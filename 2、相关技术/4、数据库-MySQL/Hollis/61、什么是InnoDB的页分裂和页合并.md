#页分裂 #页合并 #插入、删除、修改触发也分裂和聚合 #尽量使用自增字段为索引 #尽量不使用可变长字段作索引 #尽量使用批量插入而非逐条插入 #尽量不适用物理删除而是逻辑删除 #适当调整页分裂和聚合的阈值 

# 典型回答

[52、介绍一下InnoDB的数据页，和B+树的关系是什么？](2、相关技术/4、数据库-MySQL/Hollis/52、介绍一下InnoDB的数据页，和B+树的关系是什么？.md)

先看上面的这个，了解下什么是InnoDB中的数据页。

InnoDB的 **==数据页是InnoDB存储引擎中用于存储数据的基本单位，是一块磁盘上的连续区域，通常大小为16KB。B+树的每个节点都对应着一个数据页==**，包括根节点、非叶子节点和叶子节点。B+树通过节点之间的指针连接了不同层级的数据页，从而构建了一个有序的索引结构。

我们都是知道，B+树是按照索引字段建立的，并且在B+树中是有序的，假如有下面一个索引的树结构，其中的索引字段的值并不连续。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202507161101495.png)

## 页分裂

假如，现在我们**插入一个新的一条记录**，他的索引值是3，那么他就要按照顺序插入到页20中，在索引值为1,2的记录的后面。而如果这个<font color="red" size=5><font color="blue" size=5>索引页已经满了</font>，那么就需要触发一次页分裂</font>。

> **页分裂是指*将该页面中的一部分索引记录移动到一个新的页面中*，从而为新记录腾出空间。这样可以保持B+树的平衡和性能。**

**触发页分裂操作：**
1. B+树索引对应字段非自增，新插入的记录中该字段乱序，参照：[35、MySQL的主键一定是自增的吗？](2、相关技术/4、数据库-MySQL/Hollis/35、MySQL的主键一定是自增的吗？.md)
2. 对表中varchar、text类型的字段修改，原因：[varchar](4、char和varchar的区别？#varchar)

以下，就是一次页分裂的过程：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202507161105043.png)

那么，当我们向Innodb中添加数据的时候，如果索引是随机无序的，那么就会导致页分裂。而且分裂这个动作还可能会引起连锁反应，从叶子节点沿着树结构一路分裂到根节点。

## 页合并

有分裂，就会有合并。在InnoDB中，**当索引页面中的索引记录删除后**，<font color="red" size=5><font color="blue" size=5>页面可能会变得过于稀疏</font>，为了节省空间和提高性能，可能会触发页合并操作</font>。

> **页合并是指*将两个相邻的索引页面合并成一个更大的页面*，减少B+树的层级，从而提高查询性能。**

**触发页合并操作：**
1. 删除表中数据（如果被删除的记录中的字段有建索引）
2. 对表中varchar、text类型的字段修改，原因：[varchar](4、char和varchar的区别？#varchar)

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202507161113069.png)

# 扩展知识

## 页分裂（合并）的危害

首先，页分裂和合并是**涉及大量数据移动和重组的操作。频繁进行这些操作会增加数据库的I/O负担和CPU消耗，影响数据库的整体性能**。

分裂和合并可能导致B+树索引结构频繁调整，这个过程也**会影响插入及删除操作的性能**。

**频繁的页分裂和合并可能会导致磁盘上存在较多的空间碎片，新分出的一个页一般会有很多空闲空间，使得数据库表占用更多的磁盘空间，而导致浪费。**

## 如何避免页分裂

[4、char和varchar的区别？](2、相关技术/4、数据库-MySQL/Hollis/4、char和varchar的区别？.md)

[35、MySQL的主键一定是自增的吗？](2、相关技术/4、数据库-MySQL/Hollis/35、MySQL的主键一定是自增的吗？.md)

在上面两篇中，我们介绍过，使用varchar或者使用UUID作为主键的话，都会导致页分裂。

1. **尽量选择使用==自增的字段作为索引==**，尤其是主键索引，这样可以很大程度的避免页分裂。
2. 字段**类型进能量==别使用可变长度==**，例如：varchar、text
3. 如果要插入大量数据，**尽量==使用批量插入的方式，而不是逐条插入==**。这样可以减少页分裂的次数。
4. **频繁删除操作可能导致页面过于稀疏**，从而触发页合并。所以，一般建议使用逻辑删除而不是物理删除。
	- **==逻辑删除==**：即在记录中添加一个标记来表示记录是否被删除(deleted  = 0/1)，而不是真正地从数据库中删除记录。
5. 我们当然还可以根据实际情况，**适当调整InnoDB的配置参数，如页大小、填充因子、叶子页合并的阈值等**，以优化数据库性能。
