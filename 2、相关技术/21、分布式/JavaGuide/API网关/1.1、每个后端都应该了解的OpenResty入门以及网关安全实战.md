# 1ã€ç®€ä»‹

åœ¨å®˜ç½‘ä¸Šå¯¹ OpenResty æ˜¯è¿™æ ·ä»‹ç»çš„ï¼ˆhttp://openresty.orgï¼‰ï¼š
> â€œOpenResty æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚ç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚â€
> 
> â€œOpenResty é€šè¿‡æ±‡èšå„ç§è®¾è®¡ç²¾è‰¯çš„ Nginx æ¨¡å—ï¼ˆä¸»è¦ç”± OpenResty å›¢é˜Ÿè‡ªä¸»å¼€å‘ï¼‰ï¼Œä»è€Œå°† Nginx æœ‰æ•ˆåœ°å˜æˆä¸€ä¸ªå¼ºå¤§çš„é€šç”¨ Web åº”ç”¨å¹³å°ã€‚è¿™æ ·ï¼ŒWeb å¼€å‘äººå‘˜å’Œç³»ç»Ÿå·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬è¯­è¨€è°ƒåŠ¨ Nginx æ”¯æŒçš„å„ç§ C ä»¥åŠ Lua æ¨¡å—ï¼Œå¿«é€Ÿæ„é€ å‡ºè¶³ä»¥èƒœä»» 10K ä¹ƒè‡³ 1000K ä»¥ä¸Šå•æœºå¹¶å‘è¿æ¥çš„é«˜æ€§èƒ½ Web åº”ç”¨ç³»ç»Ÿã€‚â€
> 
> â€œOpenResty çš„ç›®æ ‡æ˜¯è®©ä½ çš„ Web æœåŠ¡ç›´æ¥è·‘åœ¨ Nginx æœåŠ¡å†…éƒ¨ï¼Œå……åˆ†åˆ©ç”¨ Nginx çš„éé˜»å¡ I/O æ¨¡å‹ï¼Œä¸ä»…ä»…å¯¹ HTTP å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç”šè‡³äºå¯¹è¿œç¨‹åç«¯è¯¸å¦‚ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰éƒ½è¿›è¡Œä¸€è‡´çš„é«˜æ€§èƒ½å“åº”ã€‚â€

ä»ä»¥ä¸Šå®˜ç½‘æè¿°é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒOpenResty å®˜ç½‘å¯¹å…¶å®šä½æ˜¯ä»¥ Nginx ä¸ºæ ¸å¿ƒé›†æˆ Luaï¼Œæ‰“é€ ä¸€ä¸ªå…¼å…·å¼€å‘æ•ˆç‡å’Œé«˜æ€§èƒ½çš„æœåŠ¡ç«¯å¼€å‘å¹³å°ã€‚

OpenResty çš„æ ¸å¿ƒæ˜¯åŸºäº Nginx çš„ä¸€ä¸ª C æ¨¡å—ï¼ˆlua-Nginx-moduleï¼‰ï¼Œè¯¥æ¨¡å—å°† LuaJIT åµŒå…¥åˆ° Nginx æœåŠ¡å™¨ä¸­ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€å¥—å®Œæ•´çš„ Lua APIï¼Œé€æ˜åœ°æ”¯æŒéé˜»å¡ I/Oï¼Œæä¾›äº†è½»é‡çº§çº¿ç¨‹ã€å®šæ—¶å™¨ç­‰é«˜çº§æŠ½è±¡ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨ Lua è¯­è¨€æ¥è¿›è¡Œå­—ç¬¦ä¸²å’Œæ•°å€¼è¿ç®—ã€æŸ¥è¯¢æ•°æ®åº“ã€å‘é€ HTTP è¯·æ±‚ã€æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€è°ƒç”¨å¤–éƒ¨å‘½ä»¤ç­‰ï¼Œè¿˜å¯ä»¥ç”¨ FFI çš„æ–¹å¼è°ƒç”¨å¤–éƒ¨ C å‡½æ•°ã€‚è¿™åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³æœåŠ¡ç«¯å¼€å‘éœ€è¦çš„æ‰€æœ‰åŠŸèƒ½ã€‚

æŒæ¡å¥½äº† OpenRestyï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒæ—¶æ‹¥æœ‰è„šæœ¬è¯­è¨€çš„å¼€å‘æ•ˆç‡å’Œè¿­ä»£é€Ÿåº¦ï¼Œä»¥åŠ Nginx C æ¨¡å—çš„é«˜å¹¶å‘å’Œé«˜æ€§èƒ½ä¼˜åŠ¿ã€‚

**ä¸‹é¢ä¸ºå¤§å®¶ä»‹ç»æœ¬æ–‡å¤§çº²**ï¼š
- OpenResty çš„ hello world è¯¥æ€ä¹ˆå†™
- å¿«é€Ÿä¸Šæ‰‹ Lua è„šæœ¬è¯­è¨€
- OpenResty ç”¨åˆ°çš„ Nginx çŸ¥è¯†
- OpenResty åœ¨ç½‘å…³å®‰å…¨ä¸­å¦‚ä½•åº”ç”¨

# 2ã€OpenResty çš„ hello world è¯¥æ€ä¹ˆå†™

## 2.1ã€OpenResty çš„å®‰è£…

OpenResty çš„å®‰è£…æœ‰å¤šç§æ–¹æ³•ï¼Œæ¯”å¦‚ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„åŒ…ç®¡ç†å™¨ã€æºç ç¼–è¯‘æˆ–è€… docker é•œåƒã€‚æ¨èä¼˜å…ˆä½¿ç”¨ yumã€apt-getã€brew è¿™ç±»åŒ…ç®¡ç†ç³»ç»Ÿï¼Œæ¥å®‰è£… OpenRestyã€‚

å¯¹äº Mac OS X æˆ– macOS ç”¨æˆ·ï¼Œå¼ºçƒˆæ¨èæ‚¨ä½¿ç”¨ homebrew åŒ…ç®¡ç†å·¥å…·å®‰è£… OpenRestyã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢ è¿™ä¸€æ¡å‘½ä»¤ï¼š

`brew install openresty/brew/openresty`

å¯¹äºä¸€äº›å¸¸è§çš„ Linux å‘è¡Œç‰ˆæœ¬ï¼ˆUbuntuã€Debianã€CentOSã€RHELã€Fedoraã€OpenSUSEã€Alpine å’Œ Amazon Linuxï¼‰ï¼Œ OpenResty æä¾› å®˜æ–¹é¢„ç¼–è¯‘åŒ…ã€‚ç¡®ä¿é¦–å…ˆç”¨è¿™ç§æ–¹å¼æ¥å®‰è£…ã€‚è¿™é‡Œç”¨ CentOS ä¸¾ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼Œ

### 2.1.1ã€CentOS 9 æˆ–è€…æ›´æ–°ç‰ˆæœ¬

```shell
#Â addÂ theÂ yumÂ repo:  
wgetÂ https://openresty.org/package/centos/openresty2.repo  
sudoÂ mvÂ openresty2.repoÂ /etc/yum.repos.d/openresty.repo  
  
#Â updateÂ theÂ yumÂ index:  
sudoÂ yumÂ check-update
```

### 2.1.2ã€CentOS 8 æˆ–è€…æ›´è€ç‰ˆæœ¬

```shell
#Â addÂ theÂ yumÂ repo:  
wgetÂ https://openresty.org/package/centos/openresty.repo  
sudoÂ mvÂ openresty.repoÂ /etc/yum.repos.d/openresty.repo  
  
#Â updateÂ theÂ yumÂ index:  
sudoÂ yumÂ check-update
```

ç„¶åå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£…è½¯ä»¶åŒ…ï¼Œæ¯”å¦‚ openrestyï¼š

`sudoÂ yumÂ installÂ -yÂ openresty   `

### 2.1.3ã€Docker å®‰è£…

Docker å®‰è£…çš„æ–¹å¼å°±æœ€ä¸ºç®€å•äº†ï¼Œåªéœ€è¦è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥è·å–æ‰“åŒ…å¥½çš„é•œåƒã€‚

`dockerÂ pullÂ openresty/openresty   `

### 2.1.4ã€ç›®å½•ç»“æ„

å®‰è£… OpenResty æˆåŠŸåçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼ˆä»¥é»˜è®¤å®‰è£…ç›®å½•ä¸ºä¾‹ï¼‰ï¼š
```shell
/usr/local/openresty/Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #å®‰è£…ä¸»ç›®å½•
â”œâ”€â”€Â binÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€Â luajitÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #LuaJITè¿è¡Œåº“
â”œâ”€â”€Â lualibÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Luaç»„ä»¶
â”œâ”€â”€Â NginxÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Nginxæ ¸å¿ƒè¿è¡Œå¹³å°
â”œâ”€â”€Â podÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #å‚è€ƒæ‰‹å†Œï¼ˆrestydocï¼‰ä½¿ç”¨çš„æ•°æ®
â””â”€â”€Â siteÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #åŒ…ç®¡ç†å·¥å…·ï¼ˆopmï¼‰ä½¿ç”¨çš„æ•°æ®
```

### 2.1.5ã€å¯åŠ¨æœåŠ¡

yum å®‰è£…å®Œåï¼Œå°±å¯ä»¥ç›´æ¥è¿è¡ŒÂ `openresty`Â å‘½ä»¤ï¼Œå¯åŠ¨ OpenResty æœåŠ¡ã€‚
```shell
/usr/local/openresty/bin/openresty         #å¯åŠ¨OpenRestyæœåŠ¡
```

OpenResty é»˜è®¤å¼€å¯äº† localhost:80 æœåŠ¡ï¼Œä½¿ç”¨ wget æˆ–è€… curl è¿™æ ·çš„å·¥å…·å°±å¯ä»¥éªŒè¯ OpenResty æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
```shell
curl http://localhost:80                   #curlå‘½ä»¤å‘é€HTTPè¯·æ±‚
```

ä¸‹é¢æ˜¯ä¸€äº›å…¶ä»–å¸¸ç”¨å‘½ä»¤ï¼Œ
```shell
/usr/local/openresty/bin/openrestyÂ Â -sÂ stopÂ Â Â Â Â Â Â #åœæ­¢Â OpenRestyÂ æœåŠ¡
/usr/local/openresty/bin/openrestyÂ Â -sÂ reloadÂ Â Â Â Â #é‡æ–°åŠ è½½Â NginxÂ é…ç½®æ–‡ä»¶
/usr/local/openresty/bin/openrestyÂ Â -tÂ Â Â Â Â Â Â Â Â Â Â Â #æ£€æŸ¥Â NginxÂ é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
/usr/local/openresty/bin/openrestyÂ Â -cÂ Â Â Â Â Â Â Â Â Â Â Â #æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨
```

OpenResty çš„æ“ä½œå‘½ä»¤è·Ÿ Nginx ä¿æŒä¸€è‡´ã€‚å¯ä»¥æ‰§è¡ŒÂ `openresty -h`Â ä»¥åŠÂ `nginx -h`Â å¯¹æ¯”çœ‹å‡ºï¼Œ
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506071649143.jpg)

### 2.1.6ã€å‘½ä»¤è¡Œå·¥å…· resty

å¦‚æœä½ æƒ³å®‰è£…å‘½ä»¤è¡Œå·¥å…· restyï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£… openresty-resty åŒ…ï¼š
`sudoÂ yumÂ installÂ -yÂ openresty-resty   `

resty æ˜¯ä¸€ä¸ª cli å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨Â `-e`Â å‚æ•°å¯ä»¥åœ¨å‘½ä»¤è¡Œé‡Œç›´æ¥æ‰§è¡Œ Lua ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ
```shell
[root@VM-4-5-centos ~]# resty -e "print('hello world')"
hello OpenResty
```

resty å·¥å…·è¿˜æœ‰å¾ˆå¤šé€‰é¡¹ç”¨äºé…ç½®è¡Œä¸ºï¼Œéå¸¸çµæ´»ï¼Œ`-e`Â ä¹‹å¤–è¾ƒå¸¸ç”¨çš„æœ‰
```shell
-c Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ï¼šæŒ‡å®šæœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼ˆé»˜è®¤å€¼æ˜¯64ï¼‰ï¼›
-I Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ï¼šæŒ‡å®šLuaåº“çš„æœç´¢è·¯å¾„ï¼›
-l Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ï¼šæŒ‡å®šåŠ è½½æŸä¸ªLuaåº“ï¼›
--http-conf Â Â Â Â Â Â ï¼šå®šåˆ¶åœ¨httpåŸŸé‡Œçš„æŒ‡ä»¤ï¼›
--main-include Â Â Â ï¼šå®šåˆ¶åœ¨mainåŸŸé‡Œçš„æŒ‡ä»¤ï¼›
--shdict Â Â Â Â Â Â Â Â Â ï¼šå®šåˆ¶ä½¿ç”¨çš„å…±äº«å†…å­˜ï¼ˆå‚è§10.2èŠ‚ï¼‰ï¼›
--resolve-ipv6 Â Â Â ï¼šå…è®¸è§£æipv6çš„åœ°å€ã€‚
```

æƒ³äº†è§£å®Œæ•´çš„åˆ—è¡¨ï¼Œå¯ä»¥æŸ¥çœ‹ resty -h å‘½ä»¤ã€‚

### 2.1.7ã€åŒ…ç®¡ç†å·¥å…· opm

è·Ÿå¤§å¤šæ•°è¯­è¨€ä¸€æ ·æœ‰åŒ…ç®¡ç†å·¥å…·ä¸€æ ·ï¼ŒOpenResty ä¹Ÿæœ‰è‡ªå·±çš„åŒ…ç®¡ç†å·¥å…· opmï¼ˆOpenResty Package Managerï¼‰ï¼Œopm åœ¨ openresty-opm åŒ…é‡Œï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼Œ
`sudoÂ yumÂ installÂ -yÂ openresty-opm   `

opm æ˜¯ OpenResty è‡ªå¸¦çš„åŒ…ç®¡ç†å™¨ï¼Œåœ¨ä½ å®‰è£…å¥½ OpenResty ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ä¸€äº›å¸¸è§ç”¨æ³•å¦‚ä¸‹ï¼Œ
```shell
opmÂ searchÂ Â Â Â httpÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #æœç´¢å…³é”®å­—http
opmÂ searchÂ Â Â Â kafkaÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #æœç´¢å…³é”®å­—kafka
opmÂ getÂ Â Â Â Â Â Â agentzh/lua-resty-httpÂ Â Â Â Â Â Â Â Â Â #å®‰è£…ç»„ä»¶ï¼Œæ³¨æ„éœ€è¦sudo
opmÂ infoÂ Â Â Â Â Â agentzh/lua-resty-httpÂ Â Â Â Â Â Â Â Â Â #æ˜¾ç¤ºç»„ä»¶çš„ç‰ˆæœ¬ã€ä½œè€…ç­‰ä¿¡æ¯
opmÂ removeÂ Â Â Â agentzh/lua-resty-httpÂ Â Â Â Â Â Â Â Â Â #ç§»é™¤ç»„ä»¶ï¼ŒåŒæ ·éœ€è¦sudo
opmÂ --install-dir=/optÂ Â Â Â getÂ xxxÂ Â Â Â Â Â Â Â Â Â Â Â Â #æŠŠç»„ä»¶å®‰è£…åˆ°/optç›®å½•ä¸‹
opmÂ --cwdÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â getÂ xxxÂ Â Â Â Â Â Â Â Â Â Â Â Â #å®‰è£…åˆ°å½“å‰ç›®å½•çš„/resty_modulesä¸‹
```

## 2.2ã€ç¼–å†™ hello world

åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· resty å†™äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ OpenResty ç¨‹åºï¼Œæ²¡æœ‰ master è¿›ç¨‹ï¼Œä¹Ÿä¸ä¼šç›‘å¬ç«¯å£ã€‚ä¸‹é¢è®©æˆ‘ä»¬å†™ä¸€ä¸ªéœ€è¦å¯åŠ¨ OpenResty æœåŠ¡çš„ hello worldã€‚

é¦–å…ˆæ‰¾åˆ° OpenResty å®‰è£…ç›®å½•ä¸‹Â `nginx/conf/nginx.conf`Â æ–‡ä»¶ï¼Œåœ¨ server ä¸‹æ–°å¢ OpenResty çš„Â `content_by_lua`Â æŒ‡ä»¤ï¼Œé‡Œé¢åµŒå…¥äº†Â `ngx.say`Â çš„ä»£ç ï¼š
```shell
server {
        listen       88;
        server_name  localhost;

        location / {
            root   html;
            index  index.html index.htm;
        }

        location /hello {
            content_by_lua '
                ngx.say("hello, world")
            ';
        }
}
```

æ¥ç€æˆ‘ä»¬æ‰§è¡ŒÂ `openresty -s reload`Â å‘½ä»¤ï¼Œé‡æ–°åŠ è½½ nginx.conf é…ç½®æ–‡ä»¶ã€‚æ²¡æœ‰æŠ¥é”™çš„è¯ï¼ŒOpenResty çš„æœåŠ¡å°±å·²ç»æˆåŠŸå¯åŠ¨äº†ã€‚

æœ€åä½¿ç”¨ curl å‘½ä»¤ï¼Œæ¥æŸ¥çœ‹ç»“æœçš„è¿”å›ï¼š
```shell
[root@VM-4-5-centosÂ conf]#Â curlÂ localhost:88/hello
hello,Â world
```

åˆ°è¿™é‡Œï¼Œä¸€ä¸ªçœŸæ­£çš„ OpenResty å¼€å‘çš„ hello world ç¨‹åºå°±å®Œæˆäº†ã€‚

# 3ã€å¿«é€Ÿä¸Šæ‰‹ Lua è„šæœ¬è¯­è¨€

## 3.1ã€Lua ç¯å¢ƒ

æˆ‘ä»¬ä¸ç”¨ä¸“é—¨å»å®‰è£…æ ‡å‡† Lua 5.1 ä¹‹ç±»çš„ç¯å¢ƒï¼Œå› ä¸º OpenResty å·²ç»ä¸å†æ”¯æŒæ ‡å‡† Luaï¼Œè€Œåªæ”¯æŒ LuaJITã€‚è¿™é‡Œæˆ‘ä»‹ç»çš„ Lua è¯­æ³•ï¼Œä¹Ÿæ˜¯å’Œ LuaJIT å…¼å®¹çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯åŸºäºæœ€æ–°çš„ Lua 5.3ï¼Œè¿™ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚

åœ¨ OpenResty çš„å®‰è£…ç›®å½•ä¸‹ï¼Œå¯ä»¥æ‰¾åˆ° LuaJIT çš„ç›®å½•å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨ CentOS ç³»ç»Ÿä¸‹ï¼ŒLuaJIT çš„ç›®å½•å¦‚ä¸‹ï¼Œ
```shell
[root@VM-4-5-centosÂ luajit]#Â cdÂ /usr/local/openresty/luajit/bin/
[root@VM-4-5-centosÂ bin]#Â ll
totalÂ 536
lrwxrwxrwxÂ 1Â rootÂ rootÂ Â Â Â Â 18Â OctÂ 12Â 11:22Â luajitÂ ->Â luajit-2.1.0-beta3
-rwxr-xr-xÂ 1Â rootÂ rootÂ 547728Â JulÂ 18Â 12:38Â luajit-2.1.0-beta3
```

æˆ‘ä»¬å¯ä»¥æ‰§è¡ŒÂ `cp luajit /usr/local/bin/`Â å°† luajit æ–‡ä»¶å¤åˆ¶åˆ°Â `/usr/local/bin/`Â ç›®å½•ä¸‹ï¼Œè¿›è€Œå¯ä»¥ç›´æ¥ä½¿ç”¨ luajit å‘½ä»¤ã€‚

æŸ¥çœ‹ LuaJIT çš„ç‰ˆæœ¬å·ï¼Œ
```shell
[root@VM-4-5-centosÂ ~]#Â luajitÂ Â -v
LuaJITÂ 2.1.0-beta3Â --Â CopyrightÂ (C)Â 2005-2022Â MikeÂ Pall.Â https://luajit.org/
```

æ‰§è¡Œ lua è„šæœ¬ï¼Œ
```shell
[root@VM-4-5-centosÂ ~]#Â echoÂ 'print("helloÂ world")'Â >Â 1.lua
[root@VM-4-5-centosÂ ~]#Â catÂ 1.lua
print("helloÂ world")
[root@VM-4-5-centosÂ ~]#Â luajitÂ 1.lua
helloÂ world
[root@VM-4-5-centosÂ ~]#
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ resty æ¥ç›´æ¥è¿è¡Œï¼Œå®ƒæœ€ç»ˆä¹Ÿæ˜¯ç”¨ LuaJIT æ¥æ‰§è¡Œçš„ï¼Œ
```sehll
[root@VM-4-5-centosÂ ~]#Â restyÂ -eÂ 'print("helloÂ world")'
helloÂ world
```

## 3.2ã€åŸºæœ¬è¯­æ³•

### 3.2.1ã€å˜é‡

åœ¨ Lua ä¸­å£°æ˜å˜é‡ï¼Œå¯ä»¥å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œ
```shell
localÂ aÂ =Â 'hello'
bÂ =Â "world"
```

åŠ äº†Â `local`Â å…³é”®å­—ï¼Œç”¨äºå£°æ˜å±€éƒ¨å˜é‡ã€‚

ä¸åŠ Â `local`Â å…³é”®å­—çš„è¯ï¼Œå˜é‡é»˜è®¤æ˜¯å…¨å±€çš„ã€‚

### 3.2.2ã€æ³¨é‡Š

ä¸¤ä¸ªå‡å·æ˜¯å•è¡Œæ³¨é‡Š
`--Â æ³¨é‡Š   `

å¤šè¡Œæ³¨é‡Š
```shell
--[[
Â å¤šè¡Œæ³¨é‡Š
Â å¤šè¡Œæ³¨é‡Š
Â --]]
```

### 3.2.3ã€è¡Œå°¾ç»“æŸ

Lua ä¸­ä»£ç çš„è¡Œå°¾ç»“æŸéƒ½ä¸éœ€è¦æ·»åŠ ç‰¹æ®Šå­—ç¬¦ï¼Œè¿™è·Ÿ Java ä¸åŒï¼ˆJava åœ¨è¡Œå°¾éœ€è¦æ·»åŠ Â `;`ï¼‰ã€‚
```shell
localÂ aÂ =Â 'a'
print(a)
```

## 3.3ã€æ•°æ®ç±»å‹

Lua ä¸­çš„æ•°æ®ç±»å‹ä¸å¤šï¼Œä½ å¯ä»¥é€šè¿‡Â `type`Â å‡½æ•°æ¥è¿”å›ä¸€ä¸ªå€¼çš„ç±»å‹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·çš„æ“ä½œï¼š
```shell
[root@VM-4-5-centosÂ ~]#Â restyÂ -eÂ 'print(type("helloÂ world"))
>Â Â print(type(print))
>Â Â print(type(true))
>Â Â print(type(360.0))
>Â Â print(type({}))
>Â Â print(type(nil))
>Â Â '
```

æ‰“å°å¦‚ä¸‹ï¼Œ
```shell
string
function
boolean
number
table
nil
```

è¿™å‡ ç§å°±æ˜¯ Lua ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹äº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•ä»‹ç»ä¸€ä¸‹å®ƒä»¬ã€‚

### 3.3.1ã€å­—ç¬¦ä¸²

åœ¨ Lua ä¸­ï¼Œæœ‰ä¸‰ç§æ–¹å¼å¯ä»¥è¡¨è¾¾ä¸€ä¸ªå­—ç¬¦ä¸²ï¼šå•å¼•å·ã€åŒå¼•å·ï¼Œä»¥åŠé•¿æ‹¬å·ï¼ˆ`[[]]`ï¼‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼Œ

æ–°å»ºÂ `str.lua`Â æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
localÂ sÂ =Â 'a'
localÂ s1Â =Â "b"
localÂ s2Â =Â [[c]]

print(s)
print(s1)
print(s2)
```

æ‰§è¡ŒÂ `luajit str.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
a
b
c
```

åœ¨ Lua ä¸­ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥é‡‡ç”¨Â `..`Â çš„æ–¹å¼ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼Œ

ç¼–è¾‘Â `str.lua`Â æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
localÂ sÂ =Â 'a'
localÂ s1Â =Â "b"
localÂ s2Â =Â [[c]]

print(s)
print(s1)
print(s2)

localÂ s3Â =sÂ ..Â s1Â ..s2
print(s3)
```

æ‰§è¡ŒÂ `luajit str.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
a
b
c
abc
```

### 3.3.2ã€å¸ƒå°”å€¼

åœ¨ Lua ä¸­ï¼Œåªæœ‰ nil å’Œ false ä¸ºå‡ï¼Œå…¶ä»–éƒ½ä¸º trueï¼ŒåŒ…æ‹¬ 0 å’Œç©ºå­—ç¬¦ä¸²ä¹Ÿä¸ºçœŸã€‚æˆ‘ä»¬å¯ä»¥ç”¨ç¤ºä¾‹å°è¯ä¸€ä¸‹ï¼š

æ–°å»ºÂ `bool.lua`Â è„šæœ¬æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
localÂ aÂ =Â 0
localÂ b
ifÂ aÂ then
Â Â print("true")
end
aÂ =Â ""
ifÂ aÂ then
Â Â print("true")
end

print(b)
```

æ‰§è¡ŒÂ `luajit str.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
true
true
nil
```

åœ¨ Lua ä¸­ï¼Œç©ºå€¼å°±æ˜¯ nilã€‚å¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œä½†æ²¡æœ‰èµ‹å€¼ï¼Œå®ƒçš„é»˜è®¤å€¼å°±æ˜¯ nilï¼Œå¯¹åº”çš„å°±æ˜¯ä¸Šé¢ç¤ºä¾‹ä»£ç çš„å±€éƒ¨å˜é‡ bã€‚

### 3.3.3ã€æ•°å­—

Lua çš„ number ç±»å‹ï¼Œæ˜¯ç”¨åŒç²¾åº¦æµ®ç‚¹æ•°æ¥å®ç°çš„ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒLuaJIT æ”¯æŒ dual-numberï¼ˆåŒæ•°ï¼‰æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒLuaJIT ä¼šæ ¹æ®ä¸Šä¸‹æ–‡æ¥ç”¨æ•´å‹æ¥å­˜å‚¨æ•´æ•°ï¼Œè€Œç”¨åŒç²¾åº¦æµ®ç‚¹æ•°æ¥å­˜æ”¾æµ®ç‚¹æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œ

æ–°å»ºÂ `number.lua`Â è„šæœ¬æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
print(type(2))
print(type(2.2))
print(type(0.2))
print(type(2e+1))
print(type(0.2e-1))
print(type(7.8263692594256e-06))

print(2Â +Â 2)
print(2Â +Â 22.2)
```

æ‰§è¡ŒÂ `luajit number.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
number
number
number
number
number
number
4
24.2
```

### 3.3.4ã€å‡½æ•°

å‡½æ•°åœ¨ Lua ä¸­æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œä½ å¯ä»¥æŠŠå‡½æ•°å­˜æ”¾åœ¨ä¸€ä¸ªå˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥å½“ä½œå¦å¤–ä¸€ä¸ªå‡½æ•°çš„å…¥å‚å’Œå‡ºå‚ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œ

æ–°å»ºÂ `fun.lua`Â æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹ä»£ç ï¼Œ
```shell
--Â é˜¶ä¹˜
functionÂ factorial1(n)
Â Â Â Â ifÂ nÂ ==Â 0Â then
Â Â Â Â Â Â Â Â returnÂ 1
Â Â Â Â else
Â Â Â Â Â Â Â Â returnÂ nÂ *Â factorial1(nÂ -Â 1)
Â Â Â Â end
end
print(factorial1(5))
factorial2Â =Â factorial1
print(factorial2(5))
```

æ‰§è¡ŒÂ `luajit fun.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
120
120
```

## 3.4ã€åˆ†æ”¯æ§åˆ¶

Lua æä¾›äº†ä»¥ä¸‹ä¸¤ç§åˆ†æ”¯æ§åˆ¶ç»“æ„è¯­å¥ï¼š
- if è¯­å¥
- if...else è¯­å¥
- if...elseif...else è¯­å¥

### 3.4.1ã€if è¯­å¥

Lua if è¯­å¥è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š
```shell
if(å¸ƒå°”è¡¨è¾¾å¼)
then
Â Â Â --[Â åœ¨å¸ƒå°”è¡¨è¾¾å¼ä¸ºÂ trueÂ æ—¶æ‰§è¡Œçš„è¯­å¥Â --]
end
```

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåˆ¤æ–­å˜é‡ a çš„å€¼æ˜¯å¦å°äº 20 çš„ç¤ºä¾‹ï¼Œ

æ–°å»ºÂ `if1.lua`ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
--[Â å®šä¹‰å˜é‡Â --]
aÂ =Â 10;

--[Â ä½¿ç”¨Â ifÂ è¯­å¥Â --]
ifÂ (aÂ <Â 20)Â then
Â Â Â --[Â ifÂ æ¡ä»¶ä¸ºÂ trueÂ æ—¶æ‰“å°ä»¥ä¸‹ä¿¡æ¯Â --]
Â Â Â print("aÂ å°äºÂ 20"Â );
end
print("aÂ çš„å€¼ä¸º:",Â a);
```

æ‰§è¡ŒÂ `luajit if1.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
aÂ å°äºÂ 20
aÂ çš„å€¼ä¸º:Â 10
```

### 3.4.2ã€if...else è¯­å¥

Lua if è¯­å¥å¯ä»¥ä¸ else è¯­å¥æ­é…ä½¿ç”¨, åœ¨ if æ¡ä»¶è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œ else è¯­å¥ä»£ç å—ã€‚

Lua if...else è¯­å¥è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š
```shell
if(å¸ƒå°”è¡¨è¾¾å¼)
then
Â Â Â --[Â å¸ƒå°”è¡¨è¾¾å¼ä¸ºÂ trueÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]
else
Â Â Â --[Â å¸ƒå°”è¡¨è¾¾å¼ä¸ºÂ falseÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]
end
```

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåˆ¤æ–­å˜é‡ a å€¼çš„ç¤ºä¾‹ï¼Œ

æ–°å»ºÂ `if2.lua`ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
--[Â å®šä¹‰å˜é‡Â --]
aÂ =Â 100;
--[Â æ£€æŸ¥æ¡ä»¶Â --]
if(Â aÂ <Â 20Â )
then
Â Â Â --[Â ifÂ æ¡ä»¶ä¸ºÂ trueÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]
Â Â Â print("aÂ å°äºÂ 20"Â )
else
Â Â Â --[Â ifÂ æ¡ä»¶ä¸ºÂ falseÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]
Â Â Â print("aÂ å¤§äºÂ 20"Â )
end
print("aÂ çš„å€¼ä¸ºÂ :",Â a)
```

æ‰§è¡ŒÂ `luajit if2.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
aÂ å¤§äºÂ 20
aÂ çš„å€¼ä¸ºÂ :Â 100
```

### 3.4.3ã€if...elseif...else è¯­å¥

Lua if è¯­å¥å¯ä»¥ä¸ elseif...else è¯­å¥æ­é…ä½¿ç”¨, åœ¨ if æ¡ä»¶è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œ elseif...else è¯­å¥ä»£ç å—ï¼Œç”¨äºæ£€æµ‹å¤šä¸ªæ¡ä»¶è¯­å¥ã€‚

Lua if...elseif...else è¯­å¥è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š
```shell
if(Â å¸ƒå°”è¡¨è¾¾å¼Â 1)
then
Â Â Â --[Â åœ¨å¸ƒå°”è¡¨è¾¾å¼Â 1Â ä¸ºÂ trueÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]

elseif(Â å¸ƒå°”è¡¨è¾¾å¼Â 2)
then
Â Â Â --[Â åœ¨å¸ƒå°”è¡¨è¾¾å¼Â 2Â ä¸ºÂ trueÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]

elseif(Â å¸ƒå°”è¡¨è¾¾å¼Â 3)
then
Â Â Â --[Â åœ¨å¸ƒå°”è¡¨è¾¾å¼Â 3Â ä¸ºÂ trueÂ æ—¶æ‰§è¡Œè¯¥è¯­å¥å—Â --]
else
Â Â Â --[Â å¦‚æœä»¥ä¸Šå¸ƒå°”è¡¨è¾¾å¼éƒ½ä¸ä¸ºÂ trueÂ åˆ™æ‰§è¡Œè¯¥è¯­å¥å—Â --]
end
```

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåˆ¤æ–­å˜é‡ a å€¼çš„ç¤ºä¾‹ï¼Œ

æ–°å»ºÂ `if3.lua`ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
--[Â å®šä¹‰å˜é‡Â --]
aÂ =Â 100

--[Â æ£€æŸ¥å¸ƒå°”æ¡ä»¶Â --]
if(Â aÂ ==Â 10Â )
then
Â Â Â Â --[Â å¦‚æœæ¡ä»¶ä¸ºÂ trueÂ æ‰“å°ä»¥ä¸‹ä¿¡æ¯Â --]
Â Â Â Â print("aÂ çš„å€¼ä¸ºÂ 10"Â )
elseif(Â aÂ ==Â 20Â )
then
Â Â Â Â --[Â ifÂ elseÂ ifÂ æ¡ä»¶ä¸ºÂ trueÂ æ—¶æ‰“å°ä»¥ä¸‹ä¿¡æ¯Â --]
Â Â Â Â print("aÂ çš„å€¼ä¸ºÂ 20"Â )
elseif(Â aÂ ==Â 30Â )
then
Â Â Â Â --[Â ifÂ elseÂ ifÂ conditionÂ æ¡ä»¶ä¸ºÂ trueÂ æ—¶æ‰“å°ä»¥ä¸‹ä¿¡æ¯Â --]
Â Â Â Â print("aÂ çš„å€¼ä¸ºÂ 30"Â )
else
Â Â Â Â --[Â ä»¥ä¸Šæ¡ä»¶è¯­å¥æ²¡æœ‰ä¸€ä¸ªä¸ºÂ trueÂ æ—¶æ‰“å°ä»¥ä¸‹ä¿¡æ¯Â --]
Â Â Â Â print("æ²¡æœ‰åŒ¹é…Â aÂ çš„å€¼"Â )
end
print("aÂ çš„çœŸå®å€¼ä¸º:Â ",Â aÂ )
```

æ‰§è¡ŒÂ `luajit if3.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
æ²¡æœ‰åŒ¹é…Â aÂ çš„å€¼
aÂ çš„çœŸå®å€¼ä¸º:Â Â 100
```

## 3.5ã€å¾ªç¯

Lua ç¼–ç¨‹è¯­è¨€ä¸­ for å¾ªç¯è¯­å¥å¯ä»¥é‡å¤æ‰§è¡ŒæŒ‡å®šè¯­å¥ï¼Œé‡å¤æ¬¡æ•°å¯åœ¨ for è¯­å¥ä¸­æ§åˆ¶ã€‚

Lua ç¼–ç¨‹è¯­è¨€ä¸­ for è¯­å¥æœ‰ä¸¤å¤§ç±»ï¼š
- æ•°å€¼ for å¾ªç¯
- æ³›å‹ for å¾ªç¯

### 3.5.1ã€æ•°å€¼ for å¾ªç¯

Lua ç¼–ç¨‹è¯­è¨€ä¸­æ•°å€¼ for å¾ªç¯è¯­æ³•æ ¼å¼:
```shell
forÂ var=exp1,exp2,exp3Â do
Â Â Â Â <æ‰§è¡Œä½“>
end
```

var ä» exp1 å˜åŒ–åˆ° exp2ï¼Œæ¯æ¬¡å˜åŒ–ä»¥ exp3 ä¸ºæ­¥é•¿é€’å¢ varï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡ "æ‰§è¡Œä½“"ã€‚exp3 æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º 1ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œ

æ–°å»ºÂ `for1.lua`Â æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
functionÂ f(x)
Â Â Â Â print("function")
Â Â Â Â returnÂ x*2
end

forÂ iÂ =Â 1,Â f(5)Â doÂ print(i)
end
```

æ‰§è¡ŒÂ `luajit for1.lua`Â è¿”å›ç»“æœå¦‚ä¸‹ï¼Œ
```shell
function
1
2
3
4
5
6
7
8
9
10
```

### 3.5.2ã€æ³›å‹ for å¾ªç¯

æ³›å‹ for å¾ªç¯é€šè¿‡ä¸€ä¸ªè¿­ä»£å™¨å‡½æ•°æ¥éå†æ‰€æœ‰å€¼ï¼Œç±»ä¼¼ java ä¸­çš„ foreach è¯­å¥ã€‚

Lua ç¼–ç¨‹è¯­è¨€ä¸­æ³›å‹ for å¾ªç¯è¯­æ³•æ ¼å¼:
```shell
--æ‰“å°æ•°ç»„açš„æ‰€æœ‰å€¼
localÂ aÂ =Â {"one",Â "two",Â "three"}
forÂ i,Â vÂ inÂ ipairs(a)Â do
Â Â Â Â print(i,Â v)
end
```

i æ˜¯æ•°ç»„ç´¢å¼•å€¼ï¼Œv æ˜¯å¯¹åº”ç´¢å¼•çš„æ•°ç»„å…ƒç´ å€¼ã€‚`ipairs`Â æ˜¯ Lua æä¾›çš„ä¸€ä¸ªè¿­ä»£å™¨å‡½æ•°ï¼Œç”¨æ¥è¿­ä»£æ•°ç»„ã€‚

å°†ä»¥ä¸Šå†…å®¹ä¸‹å…¥Â `for2.lua`Â æ–‡ä»¶ï¼Œæ‰“å°ç»“æœå¦‚ä¸‹ï¼Œ
```shell
1Â one
2Â two
3Â three
```

## 3.6ã€Lua æ¨¡å—ä¸åŒ…

æ¨¡å—ç±»ä¼¼äºä¸€ä¸ªå°è£…åº“ï¼Œä» Lua 5.1 å¼€å§‹ï¼ŒLua åŠ å…¥äº†æ ‡å‡†çš„æ¨¡å—ç®¡ç†æœºåˆ¶ï¼Œå¯ä»¥æŠŠä¸€äº›å…¬ç”¨çš„ä»£ç æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œä»¥ API æ¥å£çš„å½¢å¼åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œæœ‰åˆ©äºä»£ç çš„é‡ç”¨å’Œé™ä½ä»£ç è€¦åˆåº¦ã€‚

Lua æä¾›äº†ä¸€ä¸ªåä¸ºÂ `require`Â çš„å‡½æ•°ç”¨æ¥åŠ è½½æ¨¡å—ã€‚è¦åŠ è½½ä¸€ä¸ªæ¨¡å—ï¼Œåªéœ€è¦ç®€å•åœ°è°ƒç”¨å°±å¯ä»¥äº†ã€‚ä¾‹å¦‚ï¼š
```shell
require("cjson")
-- æˆ–è€…
require "cjson"
```

Lua æ¯”è¾ƒå°å·§ï¼Œå†…ç½®çš„æ ‡å‡†åº“å¹¶ä¸å¤šã€‚åœ¨ OpenResty çš„ç¯å¢ƒä¸­é»˜è®¤æ”¯æŒäº†ä¸€äº›å®˜æ–¹æ¨¡å—ï¼Œå¦‚Â `cjson`Â å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå…¶ä»–çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“åˆ™éœ€è¦å…ˆä½¿ç”¨Â `lua_package_path`Â æŒ‡ä»¤é…ç½® OpenResty çš„æ–‡ä»¶å¯»å€è·¯å¾„ï¼Œåˆæˆ–è€…ç›´æ¥ä½¿ç”¨ opm åŒ…ç®¡ç†å·¥å…·æ¥å®‰è£…ä¸€äº›ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚

OpenResty ä¸­é»˜è®¤å¯ç”¨äº†ä¸‹é¢åˆ—è¡¨çš„ç»å¤§éƒ¨åˆ†ç»„ä»¶ï¼Œæƒ³è¦äº†è§£æ›´å¤š OpenResty ç›¸å…³ç»„ä»¶çš„è¯ï¼Œå¯ä»¥ç¿»é˜…å®˜ç½‘è¯´æ˜ https://openresty.org/cn/components.htmlã€‚
```shell
LuaJIT
ArrayVarNginxModule
AuthRequestNginxModule
CoolkitNginxModule
DrizzleNginxModule
EchoNginxModule
EncryptedSessionNginxModule
FormInputNginxModule
HeadersMoreNginxModule
...
```

> æœ¬æ–‡çš„ Lua è¯­æ³•ä»‹ç»åˆ°è¿™é‡Œå°±è¶³å¤Ÿåœ¨ OpenResty ä¸­ç¼–å†™ lua è„šæœ¬äº†ï¼Œæƒ³è¦äº†è§£æ›´å¤š Lua å†…å®¹ï¼Œå¦‚ tableã€æ–‡ä»¶ã€è°ƒå¼ç­‰å¯ä»¥è‡ªè¡Œç¿»é˜… https://www.runoob.com/lua/lua-tutorial.html ç½‘ç«™ã€‚

# 4ã€OpenResty ç”¨åˆ°çš„ Nginx çŸ¥è¯†

## 4.1ã€å†…ç½®å¸¸é‡å’Œå˜é‡

OpenResty åœ¨å†…ç½® Lua å¼•æ“ä¸­æ–°å¢äº†ä¸€äº›å¸¸ç”¨çš„å†…ç½®å˜é‡å¦‚ä¸‹æ‰€ç¤ºã€‚
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072136753.jpg)

OpenResty åœ¨å†…ç½® Lua å¼•æ“ä¸­æ–°å¢äº†ä¸€äº›å¸¸ç”¨çš„å†…ç½®å¸¸é‡å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºã€‚
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072140708.jpg)
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072138017.jpg)

è¿™äº›å†…ç½®å˜é‡å’Œå¸¸é‡éƒ½å¯ä»¥åœ¨ Lua è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨ã€‚

## 4.2ã€é…ç½®æŒ‡ä»¤

OpenResty å®šä¹‰äº†ä¸€ç³»åˆ— Nginx é…ç½®æŒ‡ä»¤ï¼Œç”¨äºé…ç½®ä½•æ—¶è¿è¡Œç”¨æˆ· Lua è„šæœ¬ä»¥åŠå¦‚ä½•è¿”å› Lua è„šæœ¬çš„æ‰§è¡Œç»“æœï¼Œè¿™äº›æŒ‡ä»¤å¯ä»¥ç›´æ¥åœ¨ nginx.conf é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚

OpenResty å®šä¹‰çš„ Nginx é…ç½®æŒ‡ä»¤å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºã€‚
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072143623.jpg)

è¿™äº›æŒ‡ä»¤ä¸­æœ‰ 9 ä¸ªÂ `*_by_lua`Â æŒ‡ä»¤ï¼Œå®ƒä»¬å’Œ Nginx çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072143704.jpg)

å…¶ä¸­ï¼Œ`init_by_lua`Â åªä¼šåœ¨ Master è¿›ç¨‹è¢«åˆ›å»ºæ—¶æ‰§è¡Œï¼Œ`init_worker_by_lua`Â åªä¼šåœ¨æ¯ä¸ª Worker è¿›ç¨‹è¢«åˆ›å»ºæ—¶æ‰§è¡Œã€‚å…¶ä»–çš„Â `*_by_lua`Â æŒ‡ä»¤åˆ™æ˜¯ç”±ç»ˆç«¯è¯·æ±‚è§¦å‘ï¼Œä¼šè¢«åå¤æ‰§è¡Œã€‚

æ‰€ä»¥åœ¨Â `init_by_lua`Â é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆåŠ è½½ Lua æ¨¡å—å’Œå…¬å…±çš„åªè¯»æ•°æ®ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ COWï¼ˆcopy on writeï¼‰ç‰¹æ€§ï¼Œæ¥èŠ‚çœä¸€äº›å†…å­˜ã€‚

å¯¹äºä¸šåŠ¡ä»£ç æ¥è¯´ï¼Œå…¶å®å¤§éƒ¨åˆ†çš„æ“ä½œéƒ½å¯ä»¥åœ¨Â `content_by_lua`Â é‡Œé¢å®Œæˆï¼Œä½†æ›´æ¨èçš„åšæ³•ï¼Œæ˜¯æ ¹æ®ä¸åŒçš„åŠŸèƒ½æ¥è¿›è¡Œæ‹†åˆ†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼š
- set_by_luaï¼šè®¾ç½®å˜é‡ï¼›
- rewrite_by_luaï¼šè½¬å‘ã€é‡å®šå‘ç­‰ï¼›
- access_by_luaï¼šå‡†å…¥ã€æƒé™ç­‰ï¼›
- content_by_luaï¼šç”Ÿæˆè¿”å›å†…å®¹ï¼›
- header_filter_by_luaï¼šåº”ç­”å¤´è¿‡æ»¤å¤„ç†ï¼›
- body_filter_by_luaï¼šåº”ç­”ä½“è¿‡æ»¤å¤„ç†ï¼›
- log_by_luaï¼šæ—¥å¿—è®°å½•ã€‚

åˆ©ç”¨è¿™äº›é˜¶æ®µçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€äº›é€šç”¨é€»è¾‘è¿›è¡Œæ‹†åˆ†å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨ access é˜¶æ®µè§£å¯†ï¼Œåœ¨ body filter é˜¶æ®µåŠ å¯†å°±å¯ä»¥äº†ï¼Œåœ¨ content é˜¶æ®µçš„ä»£ç æ˜¯ä¸ç”¨åšä»»ä½•ä¿®æ”¹çš„ã€‚
```shell
#Â åŠ å¯†åè®®ç‰ˆæœ¬
locationÂ /testÂ {
Â Â Â Â access_by_luaÂ '...';Â Â Â Â Â Â Â Â #Â è¯·æ±‚ä½“è§£å¯†
Â Â Â Â content_by_luaÂ '...';Â Â Â Â Â Â Â #Â å¤„ç†è¯·æ±‚ï¼Œä¸éœ€è¦å…³å¿ƒé€šä¿¡åè®®
Â Â Â Â body_filter_by_luaÂ '...';Â Â Â #Â åº”ç­”ä½“åŠ å¯†
}
```

# 5ã€OpenResty åœ¨ç½‘å…³å®‰å…¨ä¸­å¦‚ä½•åº”ç”¨

## 5.1ã€WAF ä»‹ç»

Web åº”ç”¨é˜²ç«å¢™ï¼ˆWeb Application Firewallï¼Œç®€ç§° WAFï¼‰å¯¹ç½‘ç«™æˆ–è€… App çš„ä¸šåŠ¡æµé‡è¿›è¡Œæ¶æ„ç‰¹å¾è¯†åˆ«åŠé˜²æŠ¤ï¼Œåœ¨å¯¹æµé‡æ¸…æ´—å’Œè¿‡æ»¤åï¼Œå°†æ­£å¸¸ã€å®‰å…¨çš„æµé‡è¿”å›ç»™æœåŠ¡å™¨ï¼Œé¿å…ç½‘ç«™æœåŠ¡å™¨è¢«æ¶æ„å…¥ä¾µå¯¼è‡´æ€§èƒ½å¼‚å¸¸ç­‰é—®é¢˜ï¼Œä»è€Œä¿éšœç½‘ç«™çš„ä¸šåŠ¡å®‰å…¨å’Œæ•°æ®å®‰å…¨ã€‚

### 5.2ã€å¸¸è§ Web åº”ç”¨æ”»å‡»é˜²æŠ¤

- é˜²å¾¡ä¸€äº›å¸¸è§å¸¸è§å¨èƒï¼šSQL æ³¨å…¥ã€XSS è·¨ç«™ã€WebShell ä¸Šä¼ ã€åé—¨æ”»å‡»ã€å‘½ä»¤æ³¨å…¥ã€éæ³• HTTP åè®®è¯·æ±‚ã€å¸¸è§ Web æœåŠ¡å™¨æ¼æ´æ”»å‡»ã€CSRFã€æ ¸å¿ƒæ–‡ä»¶éæˆæƒè®¿é—®ã€è·¯å¾„ç©¿è¶Šã€ç½‘ç«™è¢«æ‰«æç­‰ã€‚
- CC æ¶æ„æ”»å‡»é˜²æŠ¤ï¼šæ§åˆ¶å•ä¸€æº IP çš„è®¿é—®é¢‘ç‡ï¼ŒåŸºäºé‡å®šå‘è·³è½¬éªŒè¯ã€äººæœºè¯†åˆ«ç­‰ã€‚é’ˆå¯¹æµ·é‡æ…¢é€Ÿè¯·æ±‚æ”»å‡»ï¼Œæ ¹æ®ç»Ÿè®¡å“åº”ç åŠ URL è¯·æ±‚åˆ†å¸ƒã€å¼‚å¸¸ Referer åŠ User-Agent ç‰¹å¾è¯†åˆ«ï¼Œç»“åˆç½‘ç«™ç²¾å‡†é˜²æŠ¤è§„åˆ™ç»¼åˆé˜²æŠ¤ã€‚
- ç½‘ç«™éšèº«ï¼šä¸å¯¹æ”»å‡»è€…æš´éœ²ç«™ç‚¹åœ°å€ï¼Œé¿å…å…¶ç»•è¿‡ Web åº”ç”¨é˜²ç«å¢™ç›´æ¥æ”»å‡»ã€‚

### 5.3ã€ç›¸å…³äº§å“

ç›®å‰ WAF ç›¸å…³äº§å“ä¸»è¦æœ‰ä¸‰ç±»ï¼š
- ç¡¬ä»¶ WAFï¼šæ•ˆæœå¥½ï¼Œä½†æ˜¯è´µï¼
- è½¯ä»¶ WAFï¼šæ•ˆæœè¿˜ç®—å¯ä»¥ï¼Œèƒ½ç”¨ï¼Œæœ‰å¼€æºäº§å“ï¼
- äº‘å‚å•† WAFï¼šäº‘å‚å•†çš„ WAF éƒ½å¾ˆè´µï¼

é‰´äºæå®¢ç²¾ç¥ï¼ˆç™½å«–ä¸‡å² ğŸ˜ï¼‰ï¼Œè¿™é‡Œä»‹ç»å‡ æ¬¾ä¸šå†…å¼€æºçš„ WAF äº§å“ï¼Œ
- é•¿äº­ç§‘æŠ€çš„é›·æ± ç¤¾åŒºç‰ˆï¼Œä¸»é¡µåœ°å€ï¼šhttps://waf-ce.chaitin.cn/
- ModSecurityï¼Œä¸»é¡µåœ°å€ï¼šhttps://www.modsecurity.org/
- Corazaï¼Œä¸»é¡µåœ°å€ï¼šhttps://coraza.io/
- VeryNginxï¼Œä¸»é¡µåœ°å€ï¼šhttps://github.com/alexazhou/VeryNginx
- NAXSIï¼Œä¸»é¡µåœ°å€ï¼šhttps://github.com/nbs-system/naxsi
- NGX_WAFï¼Œä¸»é¡µåœ°å€ï¼šhttps://github.com/ADD-SP/ngx_waf
- å—å¢™ï¼Œä¸»é¡µåœ°å€ï¼šhttps://waf.uusec.com/
- JANUSECï¼Œä¸»é¡µåœ°å€ï¼šhttps://www.janusec.com/
- HTTPWAFï¼Œä¸»é¡µåœ°å€ï¼šhttps://github.com/httpwaf/httpwaf2.0
- é”¦è¡£ç›¾ï¼Œä¸»é¡µåœ°å€ï¼šhttps://www.jxwaf.com/

å¯¹äºä»¥ä¸Š WAF äº§å“çš„ä¸€äº›è¯„ä»·æŒ‡æ ‡å¦‚ä¸‹ï¼š

- **é˜²æŠ¤æ•ˆæœ**ï¼šä¸»è¦æ˜¯ä¸¤ä¸ªç»´åº¦ï¼Œèƒ½ä¸èƒ½é˜²ä½æ”»å‡»ï¼Œä¼šä¸ä¼šå½±å“æ™®é€šç”¨æˆ·
- **æŠ€æœ¯å…ˆè¿›æ€§**ï¼šé˜²æŠ¤å¼•æ“çš„æŠ€æœ¯ç«äº‰åŠ›ï¼Œæ˜¯å¦å…·å¤‡å¯¹æŠ—é«˜çº§æ”»å‡»çš„èƒ½åŠ›
- **é¡¹ç›®è´¨é‡**ï¼šæœ¬æ–‡å°†ä»¥åŠŸèƒ½å®Œæ•´æ€§ã€å¼€æºä»£ç è´¨é‡ã€æ–‡æ¡£å®Œæ•´æ€§ç­‰è§’åº¦ä½œä¸ºè¯„ä»·ä¾æ®
- **ç¤¾åŒºè®¤å¯åº¦**ï¼šåæ˜ äº†é¡¹ç›®åœ¨ç”¨æˆ·ç¤¾åŒºä¸­çš„å£°èª‰å’Œå½±å“åŠ›ï¼Œæœ¬æ–‡å°†ä»¥ GitHub Star æ•°ä½œä¸ºè¯„ä»·ä¾æ®
- **ç¤¾åŒºæ´»è·ƒåº¦**ï¼šæ˜¯æ½œåŠ›çš„ä½“ç°ï¼Œæ´»è·ƒåº¦è¶Šé«˜å‘å±•è¶Šå¿«ï¼Œæœ¬æ–‡å°†ä»¥ç¤¾åŒºç”¨æˆ·çš„å‚ä¸åº¦å’Œä½œè€…ç»´æŠ¤é¡¹ç›®çš„ç§¯ææ€§ä½œä¸º

æœ€ç»ˆçš„çš„å¾—åˆ†å¦‚ä¸‹ï¼Œ
![1.jpg](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506072151669.jpg)

> éœ€è¦æ³¨æ„çš„æ˜¯è½¯ä»¶ WAF ä¸€èˆ¬åœ¨ç¬¬ 7 å±‚ä¸­è¿›è¡Œé˜²å¾¡ï¼ˆosi æ¨¡å‹ï¼‰ï¼Œå¹¶éèƒ½å¤Ÿé˜²å¾¡æ‰€æœ‰ç±»å‹çš„æ”»å‡»ï¼Œæ¯”å¦‚ ddos æ”»å‡»å°±ä¸èƒ½é˜²å¾¡ã€‚ä¸è¿‡ä¸€èˆ¬äº‘å‚å•†æä¾›çš„ WAF äº§å“ä¹Ÿæœ‰æºå¸¦äº† ddos æ”»å‡»é˜²å¾¡çš„æ”¯æŒï¼Œæ¯”å¦‚é˜¿é‡Œäº‘ã€‚

## 5.2ã€OpenResty åœ¨ WAF ä¸­çš„åº”ç”¨

ä½¿ç”¨ OpenResty ä½œä¸ºæµé‡å…¥å£æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™ä¸€äº› Lua è„šæœ¬æ¥å®ç° WAF é˜²å¾¡çš„åŠŸèƒ½ã€‚Lua è„šæœ¬å¯ä»¥åœ¨ Nginx é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œåœ¨ä¸åŒçš„é˜¶æ®µæ‰§è¡Œã€‚

å¯¹äºé˜²ç«å¢™åŠŸèƒ½ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥åœ¨ access_by_lua é˜¶æ®µæ‰§è¡Œ Lua è„šæœ¬ï¼Œç”¨äºåŒ¹é…è¯·æ±‚æˆ–å“åº”çš„å¤´éƒ¨æˆ–å†…å®¹ï¼Œå¹¶æ ¹æ®åŒ¹é…ç»“æœå†³å®šæ˜¯å¦æ”¾è¡Œæ•°æ®åŒ…æˆ–è¿”å›é”™è¯¯ä¿¡æ¯ã€‚

ä¸‹é¢æˆ‘å°†ç»™å¤§å®¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ OpenResty å®ç°ä¸€ä¸ªåŸºäº Lua çš„ WAFï¼ˆWeb Application Firewallï¼‰åŠŸèƒ½ã€‚ç”¨æ¥è¯†åˆ«å’Œé˜»æ­¢å¸¸è§çš„ Web æ”»å‡»ï¼Œå¦‚ cc é˜²å¾¡ã€ip é»‘åå•ã€ua å‚æ•°æ ¡éªŒç­‰ã€‚

### 5.2.1ã€cc é˜²å¾¡

1. ä¿®æ”¹ nginx.conf æ–‡ä»¶ï¼ŒåŠ å…¥Â `access_by_lua_file cc.lua`Â æŒ‡ä»¤ï¼Œ
```shell
http {
  # å£°æ˜ä¸€ä¸ª 10m å¤§å°çš„å…±äº«å†…å­˜ cc_dict
  lua_shared_dict cc_dict 10m;
  lua_package_path "/usr/local/openresty/nginx/conf/lua/waf/?.lua;/usr/local/openresty/lualib/?.lua;";
  ...
  server {
    listen       88;
    server_name  localhost;

    # åœ¨accessé˜¶æ®µæ‰§è¡Œ cc é˜²å¾¡æ’ä»¶
    access_by_lua_file cc.lua;

    location / {
      ...
    }
  }
}
```
2. æ–°å»ºÂ `cc.lua`Â è„šæœ¬ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
--Â è·å–å®¢æˆ·ç«¯ip
localÂ functionÂ getClientIp()
Â Â Â Â IPÂ Â =Â ngx.var.remote_addr
Â Â Â Â ifÂ IPÂ ==Â nilÂ then
Â Â Â Â Â Â Â Â IPÂ Â =Â "unknown"
Â Â Â Â end
Â Â Â Â returnÂ IP
end

localÂ functionÂ denyCC()
Â Â Â Â localÂ uri=ngx.var.uri
Â Â Â Â ccCount=100
Â Â Â Â ccSeconds=6
Â Â Â Â localÂ access_uriÂ =Â getClientIp()..uri
Â Â Â Â localÂ limitÂ =Â ngx.shared.cc_dict
Â Â Â Â localÂ req,_=limit:get(access_uri)
Â Â Â Â ifÂ reqÂ then
Â Â Â Â Â Â Â Â ifÂ reqÂ >Â ccCountÂ then
Â Â Â Â Â Â Â Â Â Â Â Â ngx.exit(503)
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ true
Â Â Â Â Â Â Â Â else
Â Â Â Â Â Â Â Â Â Â Â Â limit:incr(access_uri,1)
Â Â Â Â Â Â Â Â end
Â Â Â Â else
Â Â Â Â Â Â Â Â limit:set(access_uri,1,ccSeconds)
Â Â Â Â end
Â Â Â Â returnÂ false
end

ifÂ denyCC()Â then
Â Â Â Â return
end
```
3. é‡å¯ OpenResty æœåŠ¡ï¼Œå°±å®Œæˆäº† cc é˜²å¾¡åŠŸèƒ½ã€‚
```shell
openrestyÂ -sÂ Â reload
```

### 5.2.2ã€ip é»‘åå•

1. ä¿®æ”¹ nginx.conf æ–‡ä»¶ï¼ŒåŠ å…¥Â `access_by_lua_file ip_block.lua`Â æŒ‡ä»¤ï¼Œ
 ```shell
 http {
  lua_package_path "/usr/local/openresty/nginx/conf/lua/waf/?.lua;/usr/local/openresty/lualib/?.lua;";
  ...
  server {
    listen       88;
    server_name  localhost;

    # åœ¨accessé˜¶æ®µæ‰§è¡Œ ip_block é˜²å¾¡æ’ä»¶
    access_by_lua_file ip_block.lua;

    location / {
      ...
    }
  }
}
```
2. æ–°å»ºÂ `ip_block.lua`Â è„šæœ¬ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
localÂ cjsonÂ =Â requireÂ "cjson"

localÂ functionÂ read_json(var)
Â Â Â Â fileÂ =Â io.open(var,"r")
Â Â Â Â ifÂ file==nilÂ then
Â Â Â Â Â Â Â Â return
Â Â Â Â end
Â Â Â Â strÂ =Â file:read("*a")
Â Â Â Â file:close()
Â Â Â Â listÂ =Â cjson.decode(str)
Â Â Â Â returnÂ list
end

localÂ functionÂ getClientIp()
Â Â Â Â IPÂ Â =Â ngx.var.remote_addr
Â Â Â Â ifÂ IPÂ ==Â nilÂ then
Â Â Â Â Â Â Â Â IPÂ Â =Â "unknown"
Â Â Â Â end
Â Â Â Â returnÂ IP
end

localÂ functionÂ blockIpCheck()
Â Â Â Â localÂ ipBlockList=read_json('/usr/local/openresty/nginx/conf/lua/waf/ip_block.json')
Â Â Â Â ifÂ next(ipBlockList)Â ~=Â nilÂ then
Â Â Â Â Â Â Â Â forÂ _,ipÂ inÂ pairs(ipBlockList)Â do
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ getClientIp()==ipÂ then
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ngx.exit(403)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ true
Â Â Â Â Â Â Â Â Â Â Â Â end
Â Â Â Â Â Â Â Â end
Â Â Â Â end
Â Â Â Â returnÂ false
end

ifÂ blockIpCheck()Â then
Â Â Â Â return
end
```
3. åœ¨Â `/usr/local/openresty/nginx/conf/lua/waf`Â ç›®å½•ä¸‹æ–°å»ºÂ `ip_block.json`Â æ–‡ä»¶ï¼Œå†™å…¥æˆ‘ä»¬è¦åŠ å…¥é»‘åå•çš„ ipï¼Œ
```shell
["58.48.224.7"]
```

4. é‡å¯ OpenResty æœåŠ¡ï¼Œå°±å®Œæˆäº† ip é»‘åå•åŠŸèƒ½ã€‚
```shell
openresty -s  reload
```

### 5.2.3ã€ua æ‹¦æˆª

1. ä¿®æ”¹ nginx.conf æ–‡ä»¶ï¼ŒåŠ å…¥Â `access_by_lua_file ua.lua`Â æŒ‡ä»¤ï¼Œ
```shell
http {
  lua_package_path "/usr/local/openresty/nginx/conf/lua/waf/?.lua;/usr/local/openresty/lualib/?.lua;";
  ...
  server {
    listen       88;
    server_name  localhost;

    # åœ¨accessé˜¶æ®µæ‰§è¡Œ ua é˜²å¾¡æ’ä»¶
    access_by_lua_file ua.lua;

    location / {
      ...
    }
  }
}
```
2. æ–°å»ºÂ `ua.lua`Â è„šæœ¬ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œ
```shell
localÂ ngxMatch=ngx.re.match
localÂ cjsonÂ =Â requireÂ "cjson"

localÂ functionÂ read_json(var)
Â Â Â Â fileÂ =Â io.open(var,"r")
Â Â Â Â ifÂ file==nilÂ then
Â Â Â Â Â Â Â Â return
Â Â Â Â end
Â Â Â Â strÂ =Â file:read("*a")
Â Â Â Â file:close()
Â Â Â Â listÂ =Â cjson.decode(str)
Â Â Â Â returnÂ list
end

functionÂ ua()
Â Â Â Â localÂ uaÂ =Â ngx.var.http_user_agent
Â Â Â Â localÂ userAgents=read_json('/usr/local/openresty/nginx/conf/lua/waf/user_agent.json')
Â Â Â Â ifÂ next(userAgents)Â ~=Â nilÂ then
Â Â Â Â Â Â Â Â forÂ _,ruleÂ inÂ pairs(userAgents)Â do
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ ruleÂ ~=""Â andÂ ngxMatch(ua,rule,"isjo")Â then
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ngx.exit(403)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ true
Â Â Â Â Â Â Â Â Â Â Â Â end
Â Â Â Â Â Â Â Â end
Â Â Â Â end
Â Â Â Â returnÂ false
end

ifÂ ua()Â then
Â Â Â Â return
end
```
3. åœ¨Â `/usr/local/openresty/nginx/conf/lua/waf`Â ç›®å½•ä¸‹æ–°å»ºÂ `user_agent.json`Â æ–‡ä»¶ï¼Œå†™å…¥æˆ‘ä»¬è¦åŠ å…¥é»‘åå•çš„ ua ä¿¡æ¯ï¼Œ
```shell
["Chrome/116.0.0.0"]
```
4. é‡å¯ OpenResty æœåŠ¡ï¼Œå°±å®Œæˆäº† ua æ‹¦æˆªåŠŸèƒ½ã€‚
```shell
openresty -s  reload
```

## 5.3ã€ç›¸å…³èµ„æ–™

- OpenResty å®˜ç½‘ï¼šhttps://openresty.org/cn/benchmark.html
- èœé¸Ÿæ•™ç¨‹ï¼šhttps://www.runoob.com/lua/lua-tutorial.html
- ã€ŠOpenRestyå®Œå…¨å¼€å‘æŒ‡å—ã€‹ï¼šhttps://weread.qq.com/web/bookDetail/fec3240071848696fec3572
- ã€ŠOpenRestyä»å…¥é—¨åˆ°å®æˆ˜ã€‹ï¼šhttps://time.geekbang.org/column/intro/186?code=hkx6qkdp47iccvn0yf40aowqzyzzchyykmswfogb90g%3D

# 6ã€æ€»ç»“

è‡ªæ­¤æœ¬æ–‡ä»‹ç»äº†OpenRestyå…¥é—¨ä»¥åŠä½¿ç”¨ Lua è„šæœ¬å®ç°ä¸€äº›å¸¸è§çš„ç½‘å…³å®‰å…¨åŠŸèƒ½ç­‰ã€‚éœ€è¦æ³¨æ„çš„å°±æ˜¯å¤§å®¶åœ¨å·²æœ‰çš„ Nginx æœåŠ¡è¿ç§»åˆ° OpenResty ä¸Šæ¥æ—¶ï¼Œè®°å¾—æ³¨æ„ OpenResty ç‰ˆæœ¬ï¼ŒNginx ä¸ OpenResty ç›¸åŒç‰ˆæœ¬æƒ…å†µä¸‹ï¼ŒOpenResty å®˜æ–¹æ˜¯ä¿è¯å®Œå…¨å…¼å®¹çš„ã€‚

æœ€åæ„Ÿè°¢å¤§å®¶é˜…è¯»ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚
