# 1、缓存的基本思想

很多同学只知道缓存可以提高系统性能以及减少请求相应的事件，但是，不太清楚缓存的本质思想是什么。

缓存的基本思想其实很简单，就是我们非常熟悉的空间换事件。不要把缓存想的台高大上，虽然，它的确对系统的性能提升的性价比非常高。

其实，我们在学习使用缓存的时候，你会发现缓存的思想实际操作系统或者其他地方都被大量用到。比如CPU Cache缓存的是内存数据用于解决CPU处理速度和内存不匹配的问题，内存缓存的是硬盘数据用于解决硬盘访问速度过慢的问题。再比如操作系统在页表方案基础之上引入了块表来加快虚拟地址到物理地址的转换。我们可以把快表理解为一种页数的高速缓冲存储器（Cache）。

我们知道，缓存中的数据通常存储在内存中，因此访问速度非常快。为了避免内存中的数据在重启或则和宕机之后丢失，很多缓存中间件会利用磁盘做持久化。

也就是说，缓存相比较于我们常用的关系型数据库（比如MySQL）来说访问速度要快非常多。为了避免用户请求数据库中的数据速度过于缓慢，我们可以在数据库之上增加一层缓存。

除了能够提高访问速度之外，缓存支持的并发量也要更大，有了缓存之后，数据库的压力会随之变小。



# 2、缓存的分类

## 2.1、本地缓存

### 2.1.1、什么是本地缓存？

这个实际在项目中用的很多，特别是单体架构的时候。数据量不大，并且没有分布式要求的话，使用本地缓存还是可以的。

***本地缓存<font color = "red">位于应用内部</font>，最大的优点是应用存在于同一进程内部，请求本地缓存的速度非常快，不存在额外的网络开销。***

常见的单体架构图片如下：我们使用Nginix来做负载均衡，部署两个相同的应用到服务器，两个服务使用一个数据库，并且使用的是本地缓存。

![image-20221013152231624](D:\Tyora\AssociatedPicturesInTheArticles\Redis基础：为什么要用分布式缓存？\image-20221013152231624.png)



### 2.1.2、本地缓存的方案有那些？

1. JDK自带的HashMap和ConcurrentHashMap
   ConcurrentHashMap可以看作是线程安全版本的HashMap，两者都是存放key/value形式的键值对。但是，大部分场景来说不会使用这两者作缓存，因为只提供了缓存的功能，并没有提供其他诸如过期事件之类的功能。一个稍微完善一点的缓存框架至少需要提供：过期事件、淘汰机制、命中率统计这三点。
2. Ehcache、Guava Cache、Spring Cashe这三者是使用的比较多的本地缓存框架：
   ![image-20221013153144676](D:\Tyora\AssociatedPicturesInTheArticles\Redis基础：为什么要用分布式缓存？\image-20221013153144676.png)
3. 后起之秀Caffenie
   相比较于Guava来说Caffeine在各个方面比如性能更加优秀，一般建议使用其来替代Guava。并且，Guava和Caffeine的使用方式很像！

### 2.1.3、本地缓存有什么痛点？

本地缓存的优势非常明显：**低依赖、轻量、简单、成本低**。

本地缓存存在的缺陷：

1. **本地缓存应用耦合，多分布式架构支持不友好**，比如同一个相同服务器部署在多台机器上时，各个服务之间的缓存是无法共享的，因为本地缓存只在当前机器上有
2. **本地缓存容量收服务部署所在的机器限制明显。**如果当前系统锁耗费的内存多，那么本地缓存可用的容量就很少。

## 1.2、分布式缓存

### 1.2.1、什么是分布式缓存？

我们可以把分布式缓存看作是一种内存数据库的服务，它的最终作用就是提供缓存数据的服务。

分布式缓存脱离于应用独立存在，多个应用可以直接的共同使用同一个分布式缓存来服务。

如下图所示，就是一个简单的使用分布式缓存的架构图。我们使用Nginx来做负载均衡，部署两个相同的应用到服务器，两个服务使用同一个数据库和缓存。

![image-20221013162055943](D:\Tyora\AssociatedPicturesInTheArticles\Redis基础：为什么要用分布式缓存？\image-20221013162055943.png)

使用分布式缓存之后，缓存服务可以部署在一台单独的服务器上，即使同一个相同的服务器部署在多台机器上，也是使用的同一份缓存。并且，单独的分布式缓存服务器的性能、容量和提供的功能都更加强大。

引用分布式缓存的同时还带来了以下问题：

1. **系统复杂性增加：**你需要维护缓存和数据库的一致性，维护热点缓存、保证缓存服务的高可用等等
2. **系统开发成本往往会增加：**引入缓存意味着系统共需要一个单独的缓存服务器，这是需要花费相应的成本的，并且这个成本还是很贵的，毕竟耗费的是宝贵的内存。

### 1.2.2、分布式缓存的方案有那些？

![image-20221013163756506](D:\Tyora\AssociatedPicturesInTheArticles\Redis基础：为什么要用分布式缓存？\image-20221013163756506.png)



## 1.3、多级缓存

使用  **本地缓存** + **分布式缓存**  的多级缓存方案。

就那么既然使用了分布式缓存，为什么还要用本地缓存呢？

一般情况下，是不建议使用多级缓存的，这回增加维护负担（需要保证一级缓存和二级缓存的数据一致性），并且，实际带来的提升效果对绝大部分项目来说并不是很大。

多级缓存方案中，第一级缓存（L1）使用本地内存（比如Caffeine），第二级缓存（L2）使用分布式缓存（比如Redis）。读取缓存数据的时候，我们先从L1中读取，读取不到的时候再去L2中读取。这样可以降低L2的压力，减少L2的读次数。并且，本地内存的范文的速度是最快的，不存在什么网络开销。

![image-20221013164819407](D:\Tyora\AssociatedPicturesInTheArticles\Redis基础：为什么要用分布式缓存？\image-20221013164819407.png)

J2Cache就是一个基于内存和分布式缓存的两级Java缓存架构。