#RDB #AOF #混合持久化 

# 典型回答

Redis提供了两种持久化的机制，分别是RDB和AOF。

[尚硅谷_Redis6课件](D:\Obsidian\知识库—Java相关\2、相关技术\5、数据库-Redis\Redis(B站尚硅谷)\笔记\尚硅谷_Redis6课件.docx) 整理的对比：

| 对比项       | RDB                                                                                                                                                                                                                                           | AOF                                                                                                                                                                                                                                                                                                                                                    |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 默认开启      | 默认开启                                                                                                                                                                                                                                          | 默认不开启，若AOF和RDB同时开启，系统默认取AOF的数据                                                                                                                                                                                                                                                                                                                         |
| 定义        | 指定的时间间隔（不能实时持久化）内将内存中的数据集快照写入磁盘， 也就是行话讲的**Snapshot快照**，它恢复时是将快照文件直接读到内存里                                                                                                                                                                      | 以**日志**的形式来记录每个**写操作**（**增量保存**），将Redis执行过的所有写指令记录下来，在记录的时候**只许追加**文件但不可以改写文件                                                                                                                                                                                                                                                                          |
| 备份方式      | 单独`fork`一个**子进程进行持久化**，这个子线程会先将数据写入到 一个**临时文件**中，待持久化过程都结束了，再用这个**临时文件替换上次持久化好的文件(dump.rdb)**。 整个过程中，**主进程不进行任何IO操作的**；【*==写时复制技术==*】<br>![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202509211022485.png) | 1. 客户端的请求写命令会被append追加到AOF缓冲区内；<br>2. AOF缓冲区根据AOF持久化策略`[always,everysec,no]`将操作sync同步到磁盘的AOF文件中；<br>3. AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；<br>![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202509211034346.png)<br>                                                                                     |
| Rewrite压缩 | 无                                                                                                                                                                                                                                             | 1. *==背景==*：AOF采用文件**追加**方式，文件会越来越大；为避免出现此种情况而存在的**重写机制**, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩， **只保留可以恢复数据的==最小指令集==**.可以使用命令`bgrewriteaof`；<br>2. *==原理==*：fork出一条**新进程来将文件重写**(*==写时复制==*)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作<br>3. *==触发方式==*：Redis会**记录上次重写时的AOF大小**，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发 |
| 恢复        | 需要恢复时再拷贝到Redis工作目录下                                                                                                                                                                                                                           | 需要恢复时再拷贝到Redis工作目录下                                                                                                                                                                                                                                                                                                                                    |
| 触发方式      | 1. 命令：save（会阻塞主进程）、bgsave（后台异步执行，保存快照的同时还能正常处理命令）<br>2. 配置文件指定                                                                                                                                                                                | 1. 配置文件中配置：appendfsync，有always（每次redis的写入都会被记录，性能差但完整性强）、everysec（每秒记入日志一次，可能会丢失最后一秒的数据）、no（Redis不主动备份，由操作系统进行）                                                                                                                                                                                                                                        |
| 优缺点       | **缺点**：不是实时持久化最后一次持久化后的数据可能丢失、fork子进程比较耗时<br>**优点**：节省磁盘空间（RDB文件很紧凑）、恢复快、适合大规模的数据恢复                                                                                                                                                           | **缺点**：占用磁盘更大（要记录数据和写操作）、恢复慢、有一定的性能压力、存在bug<br>**优点**：丢失概率更低、日志文件可读                                                                                                                                                                                                                                                                                    |
| 推荐        | RDB和AOF都启用                                                                                                                                                                                                                                    | RDB和AOF都启用                                                                                                                                                                                                                                                                                                                                             |

## RDB

RDB是将Redis的内存中的数据**定期保存到磁盘上**，以防止数据在Redis进程异常退出或服务器断电等情况下丢失。

**RDB的优点是：快照文件小、恢复速度快，适合做备份和灾难恢复。**
**RDB的缺点是：定期更新可能会丢数据**

## AOF

AOF是将Redis的所有写操作**同步追加到AOF文件（Append Only File）的末尾**，从而记录了Redis服务器运行期间所有修改操作的详细记录。当Redis重新启动时，可以通过执行AOF文件中保存的写操作来恢复数据。

但是如果Redis刚刚执行完一个写命令，还没来得及写AOF文件就宕机了，那么这个命令和相应的数据就会丢失了。但是他也比RDB要更加靠谱一些。

**AOF的优点是：可以实现更高的数据可靠性、支持更细粒度的数据恢复，适合做数据存档和数据备份。**
**AOF的缺点是：文件大占用空间更多，每次写操作都需要写磁盘导致负载较高**

## 比较

RDB和AOF在数据可靠性、性能、存储空间占用等方面都有不同的优缺点，具体可以根据实际业务需求和硬件条件来选择合适的持久化机制，或者同时使用两种持久化机制来实现更高的数据可靠性。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202507112246928.png)


## 混合持久化

AOF和RDB各自有优缺点，为了让用户能够同时拥有上述两种持久化的优点， Redis 4.0 推出了 RDB-AOF 混合持久化。

**在开启混合持久化的情况下，AOF 重写时会把 Redis 的持久化数据，以 RDB 的格式写入到 AOF 文件的开头，之后的数据再以 AOF 的格式化追加的文件的末尾。**

**`aof-use-rdb-preamble`是开启混合模式的参数**

混合持久化结合了 RDB 和 AOF 持久化的优点，开头为 RDB 的格式，使得 Redis 可以更快的启动，同时结合 AOF 的优点，又减低了大量数据丢失的风险。

但是，在AOF 文件中添加了 RDB 格式的内容，使得 AOF 文件的可读性变得很差；如果开启混合持久化，那么此混合持久化 AOF 文件，是不能用在旧版本中的，不向下兼容的。

# 扩展知识

## Redis能完全保证数据不丢失吗？

[61、Redis能完全保证数据不丢失吗？](2、相关技术/5、数据库-Redis/Hollis/61、Redis能完全保证数据不丢失吗？.md)

