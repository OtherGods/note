大家好，我是 **华仔**, 又跟大家见面了。

从今天开始我会带领大家去深入学习 **RocketMQ**。
# **01 聊聊消息中间件**

随着微服务技术的兴起，消息中间件作为「**现代技术架构**」中不可或缺的一部分，应用相当广泛。正是因为这样，各大厂都在相继自研消息队列，比如最初来自 LinkedIn 的 Kafka、阿里的 RocketMQ、以及 Yahoo 的 Pulsar，都是业界主流的消息中间件。

## **1.1 消息中间件应用场景**

消息中间件的应用场景主要有两个：「**异步解耦**」、「**削峰填谷**」。

这里我们拿电商平台用户注册会送优惠券场景来说明下「**异步解耦**」。

首先看下未使用消息中间件的时序流程图：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202410041818400.png)

通过上图可以看出，这里有个非常严重的问题，就是「**耦合性**」太高、 「**扩展性**」太低了。

对于「**双十一大促场景**」下，如果要调整活动策略，在发送优惠券时，还要「**额外送大礼包**」，技术人员为了实现这个功能，就不得不修改注册流程。

另外，通过远程 RPC 请求优惠券服务也让注册主流程变长，在高并发场景下，用户注册这个环节就很容易成为「**系统瓶颈**」。

要解决上面的设计缺陷，常用的方案是引入「**消息中间件**」，让用户注册主流程和商家活动「**异步解耦**」。改造后的时序图如下：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202410041818116.png)

完成用户注册相关逻辑后，只需要向 MQ 发送一条消息就直接给用户返回「**注册成功**」。而赠送优惠券等与活动相关的需求，可以通过异步的方式进行执行，这样，无论后续无论发生什么变化，用户中心都不需要发布新版本。

这里只需要引入一个送优惠券的「**MQ消费者服务**」并订阅消息，然后根据消息调用「**优惠券中心服务**」。如果后续活动策略发生变化，只需要增加对应的消费者服务即可。

另外一个常用场景就是「**削峰填谷**」.

假设公司在做大型促销活动，比如双十一大促，「**在线系统 A**」要面临超过 2万 QPS，而「**后端系统 B**」每秒只能处理 5000 左右 QPS 的并发流量，此时如果将并发流量全部发送给「**后端系统 B**」, 它肯定会宕机，最终促销活动失败。

此时可以引入消息中间件，将并发流量先打到「**MQ**」中，然后「**后端系统 B**」按照其每秒处理 5000 左右 QPS 的处理能力从 MQ 中获取消息实现「**削峰填谷**」，如下图：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202410041821755.png)

## **1.2 消息中间件的技术选型**

主要的消息中间件包括 「**RocketMQ**」、「**Kafka**」 和 「**RabbitMQ**」，我们先来看一下这张功能对比图：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202410051813374.png)


通过上图，我认为在选型时不能只看「**功能级别**」，更重要的是要看重消息中间件的「**高性能**」、「**高可扩展性**」，另外还有一个重要因素就是中间件使用的「**技术栈语言**」。

# **02 为什么选择 RocketMQ**

那么为什么要选择学习 RocketMQ 呢？

这里给出四个优点：

**1、 语言优势：** 首先 RocketMQ 使用 Java 语言开发，对比 Erlang 开发的 RabbitMQ，更容易上手阅读、体验。在遇到 RocketMQ 底层的问题时，大部分熟悉 Java 的同学都可以深入阅读其源码，分析、排查问题，甚至可以进行二次开发。

**2、 丰富的高级特性：** 从 RocketMQ 官方文档 [https://rocketmq.apache.org/zh/](https://rocketmq.apache.org/zh/) 来看，高级特性达到了 12 种，例如「**普通消息**」、「**顺序消息**」、「**事务消息**」、「**消息过滤**」、「**定时/延时消息**」、「**消息重试**」等，这些特性后续都会进行讲解。其丰富的特性，能够为我们在复杂的业务场景下尽可能多地提供思路及解决方案。

**3、 商业前景良好：** RocketMQ 不仅解决了阿里的内部需求，同时还被搬到了阿里云上，作为一个商业化的产品对外提供服务。如今 RocketMQ 商业化版已经具有相当大的规模。良好的商业前景，也推动着 RocketMQ 在业界的普及。

**4、 阿里背书：** 历年来大家所熟悉的双十一大促，在阿里内部就是使用的 RocketMQ 来承载消息，面对如此庞大的「**流量洪峰**」，RocketMQ 表现非常令人满意。另外 RocketMQ 也是阿里「**交易链路**」中的核心产品。交易链路本已是核心中的核心，而这个核心又将 RocketMQ 当作核心链路中的核心，足以见对 RocketMQ 的重视程度。

