这篇文章含金量很低，想了解详细信息，去看 [[Spring事务小结]] 

对于 [mysql](https://spring.hhui.top/spring-blog/2020/02/02/200202-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E4%BA%8B%E5%8A%A1%E4%BC%A0%E9%80%92%E5%B1%9E%E6%80%A7/#)而言，关于事务的主要知识点可能集中在隔离级别上；在 [Spring](https://spring.hhui.top/spring-blog/2020/02/02/200202-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E4%BA%8B%E5%8A%A1%E4%BC%A0%E9%80%92%E5%B1%9E%E6%80%A7/#)体系中，使用事务的时候，还有一个知识点事务的传递属性同样重要，本文将主要介绍7种传递属性的使用场景

# 1、配置

本文的case，将使用声明式事务，首先我们创建一个SpringBoot项目，版本为`2.2.1.RELEASE`，使用mysql作为目标数据库，存储引擎选择`Innodb`，事务隔离级别为RR

## 1.1、项目配置

在项目`pom.xml`文件中，加上`spring-boot-starter-jdbc`，会注入一个`DataSourceTransactionManager`的bean，提供了事务支持
```xml
<dependency>  
    <groupId>mysql</groupId>  
    <artifactId>mysql-connector-java</artifactId>  
</dependency>  
<dependency>  
    <groupId>org.springframework.boot</groupId>  
    <artifactId>spring-boot-starter-jdbc</artifactId>  
</dependency>
```

## 1.2、数据库配置

进入spring配置文件`application.properties`，设置一下db相关的信息
```properties
## DataSource  
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/story?useUnicode=true&characterEncoding=UTF-8&useSSL=false  
spring.datasource.username=root  
spring.datasource.password=
```

## 1.3、数据库

新建一个简单的表结构，用于测试
```sql
CREATE TABLE `money` (  
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,  
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT '用户名',  
  `money` int(26) NOT NULL DEFAULT '0' COMMENT '钱',  
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',  
  `create_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  
  `update_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',  
  PRIMARY KEY (`id`),  
  KEY `name` (`name`)  
) ENGINE=InnoDB AUTO_INCREMENT=551 DEFAULT CHARSET=utf8mb4;
```

# 2、使用说明
## 2.1、准备

在正式开始之前，得先准备一些基础数据
```java
@Component  
public class PropagationDemo {  
    @Autowired  
    private JdbcTemplate jdbcTemplate;  
  
    @PostConstruct  
    public void init() {  
        String sql = "replace into money (id, name, money) values (420, '初始化', 200)," + "(430, '初始化', 200)," +  
                "(440, '初始化', 200)," + "(450, '初始化', 200)," + "(460, '初始化', 200)," + "(470, '初始化', 200)," +  
                "(480, '初始化', 200)," + "(490, '初始化', 200)";  
        jdbcTemplate.execute(sql);  
    }  
}
```

其次测试事务的使用，我们需要额外创建一个测试类，后面的测试case都放在类`PropagationSample`中; 为了使输出结果更加友好，提供了一个封装的call方法
```java
@Component  
public class PropagationSample {  
    @Autowired  
    private PropagationDemo propagationDemo;  
      
    private void call(String tag, int id, CallFunc<Integer> func) {  
        System.out.println("============ " + tag + " start ========== ");  
        propagationDemo.query(tag, id);  
        try {  
            func.apply(id);  
        } catch (Exception e) {  
            System.out.println(e.getMessage());  
        }  
        propagationDemo.query(tag, id);  
        System.out.println("============ " + tag + " end ========== \n");  
    }  
  
  
    @FunctionalInterface  
    public interface CallFunc<T> {  
        void apply(T t) throws Exception;  
    }  
}
```

## 2.2、REQUIRED

也是默认的传递属性，其特点在于

- 如果存在一个事务，则在当前事务中运行
- 如果没有事务则开启一个新的事务

使用方式也比较简单，不设置`@Transactional`注解的propagation属性，或者设置为 REQUIRED即可
```java
/**  
 * 如果存在一个事务，则支持当前事务。如果没有事务则开启一个新的事务  
 *  
 * @param id  
 */  
@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)  
public void required(int id) throws Exception {  
    if (this.updateName(id)) {  
        this.query("required: after updateMoney name", id);  
        if (this.updateMoney(id)) {  
            return;  
        }  
    }  
  
    throw new Exception("事务回滚!!!");  
}
```

上面就是一个基础的使用姿势
```java
private void testRequired() {  
    int id = 420;  
    call("Required事务运行", id, propagationDemo::required);  
}
```

输出结果如下
```java
============ Required事务运行 start ========== 
Required事务运行 >>>> {id=420, name=初始化, money=200, is_deleted=false, create_at=2020-02-02 15:23:26.0, update_at=2020-02-02 15:23:26.0}
required: after updateMoney name >>>> {id=420, name=更新, money=200, is_deleted=false, create_at=2020-02-02 15:23:26.0, update_at=2020-02-02 15:23:46.0}
事务回滚!!!
Required事务运行 >>>> {id=420, name=初始化, money=200, is_deleted=false, create_at=2020-02-02 15:23:26.0, update_at=2020-02-02 15:23:26.0}
============ Required事务运行 end ==========
```

## 2.3、SUPPORTS




## 2.4、MANDATORY




## 2.5、NOT_SUPPORT




## 2.6、NEVER




## 2.7、NESTED



### 2.7.1、内部事务回滚




### 2.7.2、外部事物回滚



## 2.8、REQUIRES_NEW




## 2.9、小结




# 3、其他

### 3.1、系列博文&源码

**系列博文**

- [180926-SpringBoot高级篇DB之基本使用](http://spring.hhui.top/spring-blog/2018/09/26/180926-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87DB%E4%B9%8B%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/)
- [190407-SpringBoot高级篇JdbcTemplate之数据插入使用姿势详解](http://spring.hhui.blog/spring-blog/2019/04/07/190407-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF%E8%AF%A6%E8%A7%A3/)
- [190412-SpringBoot高级篇JdbcTemplate之数据查询上篇](http://spring.hhui.top/spring-blog/2019/04/12/190412-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%B8%8A%E7%AF%87/)
- [190417-SpringBoot高级篇JdbcTemplate之数据查询下篇](http://spring.hhui.top/spring-blog/2019/04/17/190417-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%B8%8B%E7%AF%87/)
- [190418-SpringBoot高级篇JdbcTemplate之数据更新与删除](http://spring.hhui.top/spring-blog/2019/04/18/190418-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%88%A0%E9%99%A4/)
- [200119-SpringBoot系列教程之声明式事务Transactional](http://spring.hhui.top/spring-blog/2020/01/19/200119-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1Transactional/)
- [200120-SpringBoot系列教程之事务隔离级别知识点小结](http://spring.hhui.top/spring-blog/2020/01/20/200120-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%9F%A5%E8%AF%86%E7%82%B9%E5%B0%8F%E7%BB%93/)

**源码**

- 工程：[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- 实例源码: [https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-boot/101-jdbctemplate-transaction](https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-boot/101-jdbctemplate-transaction)
  已经将这个项目Fork到我的GitHub：[https://github.com/OtherGods/paicoding-yihui-spring-boot-demo](https://github.com/OtherGods/paicoding-yihui-spring-boot-demo)


转载自：[【DB系列】事务传递属性](https://spring.hhui.top/spring-blog/2020/02/02/200202-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E4%BA%8B%E5%8A%A1%E4%BC%A0%E9%80%92%E5%B1%9E%E6%80%A7/)

