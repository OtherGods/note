
**Spring Boot 3.1.5** å’Œ **Spring Framework 6.0.13** çš„æºç ï¼Œè¯¦ç»†æ¢³ç† **Spring Boot è‡ªåŠ¨è£…é…** å’Œ **Spring Bean åˆå§‹åŒ–** çš„å…³ç³»ï¼Œå¹¶æŠŠæ¶‰åŠçš„æ ¸å¿ƒç±»/æ–¹æ³•å…¨éƒ¨è¡¥å……ä¸Šã€‚

## 1ï¸âƒ£ Spring Boot è‡ªåŠ¨è£…é…æ˜¯ä»€ä¹ˆï¼Ÿ
- **ç›®æ ‡**ï¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œæ ¹æ® classpath ä¾èµ–å’Œæ¡ä»¶æ³¨è§£è‡ªåŠ¨æ³¨å†Œ Beanã€‚
- **å…³é”®å…¥å£**ï¼š`@EnableAutoConfiguration`ï¼ˆè¢« `@SpringBootApplication` éšå¼å¼•å…¥ï¼‰
- **æ‰§è¡Œæ—¶æœº**ï¼šå®¹å™¨åˆ·æ–°æ—©æœŸï¼Œ**Bean å®ä¾‹åŒ–ä¹‹å‰**ï¼Œé€šè¿‡ `BeanDefinitionRegistryPostProcessor` å®Œæˆã€‚
- **æ ¸å¿ƒç»„ä»¶**ï¼š
    - `ConfigurationClassPostProcessor`ï¼šè§£æ `@Configuration`ã€`@Import`
    - `AutoConfigurationImportSelector`ï¼šæ‰«æ `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports`
    - æ¡ä»¶æ³¨è§£ï¼ˆ`@ConditionalOnClass`, `@ConditionalOnMissingBean` ç­‰ï¼‰

## 2ï¸âƒ£ Spring Bean åˆå§‹åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ
- **ç›®æ ‡**ï¼šæŠŠ BeanDefinition è½¬æ¢ä¸º Bean å®ä¾‹ï¼Œå®Œæˆä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚
- **æ‰§è¡Œæ—¶æœº**ï¼š`AbstractApplicationContext.refresh()` çš„ `finishBeanFactoryInitialization()` é˜¶æ®µã€‚
- **æ ¸å¿ƒç»„ä»¶**ï¼š
    - `AbstractAutowireCapableBeanFactory`
    - `doCreateBean()`ï¼šå®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–å›è°ƒã€AOP

## 3ï¸âƒ£ è‡ªåŠ¨è£…é…å’Œ Bean åˆå§‹åŒ–çš„å…³ç³»

âœ… **è‡ªåŠ¨è£…é…**ï¼šè´Ÿè´£æ‰«æã€è§£æé…ç½®ç±»ï¼Œå‘å®¹å™¨æ³¨å†Œ `BeanDefinition`ã€‚  
âœ… **Bean åˆå§‹åŒ–**ï¼šæ ¹æ® `BeanDefinition` çœŸæ­£åˆ›å»ºå¯¹è±¡ï¼Œæ‰§è¡Œä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸã€‚

ğŸ‘‰ **å…³ç³»æ€»ç»“**ï¼šè‡ªåŠ¨è£…é… = â€œå‡†å¤‡åŸææ–™ï¼ˆBeanDefinitionï¼‰â€ï¼ŒBean åˆå§‹åŒ– = â€œåŠ å·¥æˆå“ï¼ˆBean å®ä¾‹ï¼‰â€ã€‚  
å®ƒä»¬é€šè¿‡ **BeanDefinition** ä½œä¸ºæ¡¥æ¢ä¸²è”ã€‚

## 4ï¸âƒ£ æ ¸å¿ƒè°ƒç”¨é“¾ï¼ˆBoot 3.1.5 + Spring 6.0.13ï¼‰

```
SpringApplication.run()
   â”‚
   â–¼
AbstractApplicationContext.refresh()
   â”‚
   â”œâ”€ invokeBeanFactoryPostProcessors()        <-- è‡ªåŠ¨è£…é…é˜¶æ®µ
   â”‚       â””â”€ ConfigurationClassPostProcessor
   â”‚              â””â”€ è§£æ @Configuration/@EnableAutoConfiguration
   â”‚              â””â”€ AutoConfigurationImportSelector åŠ è½½è‡ªåŠ¨é…ç½®ç±»
   â”‚              â””â”€ æ³¨å†Œ BeanDefinition
   â”‚
   â”œâ”€ registerBeanPostProcessors()
   â”‚
   â”œâ”€ finishBeanFactoryInitialization()        <-- Bean åˆå§‹åŒ–é˜¶æ®µ
   â”‚       â””â”€ DefaultListableBeanFactory.preInstantiateSingletons()
   â”‚              â””â”€ AbstractAutowireCapableBeanFactory.getBean()
   â”‚                     â””â”€ doCreateBean()     <-- å®ä¾‹åŒ– + ä¾èµ–æ³¨å…¥ + åˆå§‹åŒ–å›è°ƒ
   â”‚
   â””â”€ finishRefresh()
```

## 5ï¸âƒ£ æ¶‰åŠåˆ°çš„å…³é”®ç±» & æ–¹æ³•ï¼ˆè¡¥å……è§£é‡Šï¼‰

### ğŸ”¹ `AbstractApplicationContext.invokeBeanFactoryPostProcessors()`

- **ä½œç”¨**ï¼šæ‰§è¡Œæ‰€æœ‰ `BeanFactoryPostProcessor` å’Œ `BeanDefinitionRegistryPostProcessor`ã€‚
- **é‡è¦æ€§**ï¼šè‡ªåŠ¨è£…é…çš„è§¦å‘ç‚¹ã€‚

æºç ï¼ˆSpring 6.0.13ï¼‰ï¼š

```java
protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {
    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());
}
```

- `ConfigurationClassPostProcessor` åœ¨è¿™é‡Œè¢«è°ƒç”¨ã€‚

### ğŸ”¹ `ConfigurationClassPostProcessor`

- **ç±»å‹**ï¼š`BeanDefinitionRegistryPostProcessor`
- **ä½œç”¨**ï¼š
    - è§£æ `@Configuration`ã€`@ComponentScan`
    - å¤„ç† `@EnableAutoConfiguration` â†’ è°ƒç”¨ `AutoConfigurationImportSelector`
    - æŠŠ `@Bean` æ–¹æ³•å’Œè‡ªåŠ¨é…ç½®ç±»è½¬æ¢æˆ BeanDefinition

æ ¸å¿ƒæµç¨‹ï¼š

```java
public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {
    processConfigBeanDefinitions(registry);
}
```

### ğŸ”¹ `AutoConfigurationImportSelector`

- æ‰«æ `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports`
- åŠ è½½æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»
- ç»“åˆ `@Conditional` æ³¨è§£åˆ¤æ–­å“ªäº›ç”Ÿæ•ˆ
- æŠŠåŒ¹é…çš„é…ç½®ç±»æ³¨å†Œä¸º BeanDefinition

### ğŸ”¹ `AbstractAutowireCapableBeanFactory`

- **Spring Bean åˆ›å»ºæ ¸å¿ƒå·¥å‚**ã€‚
- **èŒè´£**ï¼š
    - åˆ›å»º Bean å®ä¾‹
    - ä¾èµ–æ³¨å…¥
    - ç”Ÿå‘½å‘¨æœŸå›è°ƒ
    - ä»£ç†ï¼ˆAOPï¼‰

### ğŸ”¹ `doCreateBean()`

æºç æ ¸å¿ƒæµç¨‹ï¼š

```java
protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    // 1. åˆ›å»ºå®ä¾‹
    BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args);

    // 2. å±æ€§å¡«å……ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
    populateBean(beanName, mbd, instanceWrapper);

    // 3. åˆå§‹åŒ–ï¼ˆ@PostConstructã€BeanPostProcessorã€AOPï¼‰
    Object exposedObject = initializeBean(beanName, instanceWrapper.getWrappedInstance(), mbd);

    return exposedObject;
}
```

### ğŸ”¹ å…¶ä»–æ¶‰åŠçš„å…³é”®æ–¹æ³•/ç±»

- **`AbstractApplicationContext.refresh()`**ï¼šSpring å®¹å™¨å¯åŠ¨æ€»æ§æµç¨‹ï¼Œè§¦å‘è‡ªåŠ¨è£…é…å’Œ Bean åˆå§‹åŒ–ã€‚
- **`PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()`**ï¼šæ’åºæ‰§è¡Œæ‰€æœ‰ `BeanFactoryPostProcessor`ã€‚
- **`DefaultListableBeanFactory.preInstantiateSingletons()`**ï¼šæå‰å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹ Beanã€‚
- **`BeanPostProcessor`**ï¼šBean ç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹ï¼ŒAOP ä»£ç†ä¹Ÿåœ¨è¿™é‡Œä»‹å…¥ã€‚

## 6ï¸âƒ£ æ•´ä½“æ€»ç»“

1ï¸âƒ£ **Spring Boot è‡ªåŠ¨è£…é…é˜¶æ®µ**ï¼š

- å…¥å£ï¼š`AbstractApplicationContext.invokeBeanFactoryPostProcessors()`
- æ ¸å¿ƒç±»ï¼š`ConfigurationClassPostProcessor`
- ç»“æœï¼šæ‰«æé…ç½®ç±»ã€åŠ è½½ Starter è‡ªåŠ¨é…ç½®ã€æ³¨å†Œ BeanDefinitionã€‚

2ï¸âƒ£ **Spring Bean åˆå§‹åŒ–é˜¶æ®µ**ï¼š

- å…¥å£ï¼š`finishBeanFactoryInitialization()`
- æ ¸å¿ƒç±»ï¼š`AbstractAutowireCapableBeanFactory`
- ç»“æœï¼šå®ä¾‹åŒ– Beanã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–å›è°ƒã€‚

3ï¸âƒ£ **å…³ç³»**ï¼š

- è‡ªåŠ¨è£…é…è§£å†³ â€œå“ªäº› Bean éœ€è¦æ³¨å†Œâ€
- BeanFactory è§£å†³ â€œå¦‚ä½•åˆ›å»ºè¿™äº› Bean å®ä¾‹â€
- äºŒè€…é€šè¿‡ `BeanDefinition` ä¸²è”ã€‚

æ˜¯å¦éœ€è¦æˆ‘ **ç”»å‡ºå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸæ—¶åºå›¾**ï¼ˆä» `SpringApplication.run()` â†’ è‡ªåŠ¨è£…é… â†’ Bean åˆ›å»º â†’ AOP ä»£ç†ï¼‰å¹¶åœ¨å›¾ä¸Šæ ‡æ³¨è¿™äº›ç±»å’Œæ–¹æ³•ï¼Ÿè¿™æ ·ä¼šæŠŠè‡ªåŠ¨è£…é…å’Œ Bean åˆå§‹åŒ–å…³ç³»æ›´ç›´è§‚å±•ç°å‡ºæ¥ã€‚æ˜¯å¦éœ€è¦è¿™å¼ å›¾ï¼Ÿ
