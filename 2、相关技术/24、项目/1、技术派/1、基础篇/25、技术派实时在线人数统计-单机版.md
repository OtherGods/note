技术派中借，。。助web三大组件中的Listener实现了一个简单的在线人数实时统计的功能，其主要的原理，就是用来监听session的创建和销毁，以此来实现在线人数的+1/-1，如
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061633139.png)

接下来看一下具体的实现策略
# 1、在线人数实时统计
## 1.1、设计思路

用户每次访问时，没有则创建session，并且设置有效时间，有则更新session中的访问时间；当用户主动退出或者一段时间没有交互之后，则认为用户已经离开，session失效

基于session的创建与自动销毁的在线人数统计方案
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061643188.png)

上面的整个思路都比较清晰，核心的就两点：
1. 监听Ssession创建和销毁的监听器OnlineUserCountListener
2. 计数服务UserStatisticService

## 1.2、session监听器

直接自定义一个实现HttpSessionListener的监听器就可以,源码路径: com.github.paicoding.forum.web.hook.listener.OnlineUserCountListener
```java
/**  
 * 通过监听session来实现实时人数统计  
 *  
 * @author YiHui  
 * @date 2023/3/26  
 */
@WebListener  
public class OnlineUserCountListener implements HttpSessionListener {
    /**  
     * 新增session，在线人数统计数+1  
     *     * @param se  
     */  
    public void sessionCreated(HttpSessionEvent se) {  
        HttpSessionListener.super.sessionCreated(se);  
        SpringUtil.getBean(UserStatisticService.class).incrOnlineUserCnt(1);  
    }  
  
    /**  
     * session失效，在线人数统计数-1  
     *     * @param se  
     */  
    public void sessionDestroyed(HttpSessionEvent se) {  
        HttpSessionListener.super.sessionDestroyed(se);  
        SpringUtil.getBean(UserStatisticService.class).incrOnlineUserCnt(-1);  
    }  
}
```

## 1.3、计数服务

在技术派中，我们实现了一个非常原始基础的计数统计，目前只适用于单机的场景；当我们扩充到集群模式的时候，可以考虑借助redis来替换下面的内存变量AtomicInteger onlineUserCnt new AtomicInteger(0);
源码路径：com.github.paicoding.forum.service.statistics.service.impl.UserStatisticServiceImpl
```java
/**  
 * 用户统计服务  
 *  
 * @author YiHui  
 * @date 2023/3/26  
 */@Service  
public class UserStatisticServiceImpl implements UserStatisticService {  
  
    /**  
     * 对于单机的场景，可以直接使用本地局部变量来实现计数  
     * 对于集群的场景，可考虑借助 redis的zset 来实现集群的在线用户人数统计  
     */  
    private AtomicInteger onlineUserCnt = new AtomicInteger(0);  
  
    /**  
     * 添加在线人数  
     *  
     * @param add 正数，表示添加在线人数；负数，表示减少在线人数  
     * @return  
     */  
    public int incrOnlineUserCnt(int add) {  
        return onlineUserCnt.addAndGet(add);  
    }  
  
    /**  
     * 查询在线用户人数  
     *  
     * @return  
     */  
    public int getOnlineUserCnt() {  
        return onlineUserCnt.get();  
    }  
  
}
```

## 1.4、session创建

上面的整个方案都是基于session的创建与销毁来实现的，因此我们可以考虑直接在Filter中进行创建session
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061726278.png)

关于session的相关知识点，请阅读[7、技术派身份验证识别之session-cookie](2、相关技术/24、项目/1、技术派/2、进阶篇/7、技术派身份验证识别之session-cookie.md)

## 1.5、session销毁

关于session的销毁，提供了两种方式，一是用户登出，一个是超期自动失效

### 1.5.1、退出时释放会话
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061729607.png)

### 1.5.2、设置会话有效期间
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061729448.png)

## 1.6、在线人数返回

从文章开头就可以看出，在线人数统计的使用场景，所有页面的底部，有一个在线人数统计的tip，所以这个信息直接是在全局参数的地方写入的
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202308061730273.png)

# 2、小结
## 2.1、知识点小结

整篇文章内容比较简单，基于web中非常基础的知识点Listener+session来实现的实时在线人数统计，文中关联的知识点如下：
1. web三组件之listener的基本知识点
   - [22、WEB三大组件之Listener在技术派中的应用](2、相关技术/24、项目/1、技术派/1、基础篇/22、WEB三大组件之Listener在技术派中的应用.md)
2. web三组件之filter的相关知识点
   - [20、WEB三大组件之Filter在技术派中的应用](2、相关技术/24、项目/1、技术派/1、基础篇/20、WEB三大组件之Filter在技术派中的应用.md)
3. cookie/session相关知识点
   - [7、技术派身份验证识别之session-cookie](2、相关技术/24、项目/1、技术派/2、进阶篇/7、技术派身份验证识别之session-cookie.md)
4. 基AtomicInteger实现的单机版计数器
## 2.2、扩展知识点

请注意，现在都已经2023年了，单机的服务在实际的生产环境中并不多见
那么在集群的模式中，实时的在线人数可以怎么统计呢？直接用这个方案会有什么问题呢？














