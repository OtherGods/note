
首先在阅读这篇文章之前请小伙伴们移驾的上篇 [15、技术派Cancal实现MySQL和ES同步](2、相关技术/24、项目/1、技术派/2、进阶篇/15、技术派Cancal实现MySQL和ES同步.md) ，并且<font color = "red">已经实现MySQL到ES数据同步</font>，接下来才可以继续阅读这篇文章去SpringBoot整合ES。希望这些前期工作大家一定做好。

在SpringBoot整合ES中，有两种常见方法，一种是<font color = "red">ElasticsearchRestTemplate</font>，另一种是<font color = "red">RestHighLevelClient</font>。ElasticsearchRestTemplate是ES基于Spring集成用法，但是用法比较单一，有些复杂查询无法完成；另一种RestHighLevelClient是ES原生客户端，适合各种场景查询。

综合考虑下来技术派采用后者ES原生客户端RestHighLevelClient。

# 1、构造RestHighLevelClient客户端

## 1.1、引入依赖

在<font color = "red">paicoding-service</font>模块中的pom文件中引入es和es-client相关依赖

```xml
paicoding-service中pom依赖

<!--引入es-high-level-client相关依赖  start-->
<dependency>
	<groupId>org.elasticsearch</groupId>
	<artifactId>elasticsearch</artifactId>
	<version>6.8.2</version>
</dependency>

<dependency>
	<groupId>org.elasticsearch.client</groupId>
	<artifactId>elasticsearch-rest-client</artifactId>
	<version>6.8.2</version>
</dependency>

<dependency>
	<groupId>org.elasticsearch.client</groupId>
	<artifactId>elasticsearch-rest-client</artifactId>
	<version>6.8.2</version>
</dependency>
```

## 1.2、配置yml文件


在paicoding-web模块中src->main->resource-env->dev->application-dal.yml中配置ES相关配置，配置如下所示：

```yml
ES在yml中配置

# elasticsearch配置
elasticsearch:
  # 是否开启ES？本地启动如果没有安装ES，可以设置为false关闭ES
  open: true
  # es集群名称
  clusterName: elasticsearch
  hosts: 127.0.0.1:9200
  userName: elastic
  password: elastic
  # es 请求方式
  scheme: http
  # es 连接超时时间
  connectTimeOut: 1000
  # es socket 连接超时时间
  socketTimeOut: 30000
  # es 请求超时时间
  connectionRequestTimeOut: 500
  # es 最大连接数
  maxConnectNum: 100
  # es 每个路由的最大连接数
  maxConnectNumPerRoute: 100
```

<font color = "red">注意yml格式</font>，千万别出错
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052034915.png)

配置的具体介绍我就不再重复介绍了，在yml的注解中已经详细的标注了，请小伙伴们详细看看哦。

## 1.3、编写config配置类RestHighLevelClient

配置类其实也就是交由Spring去创建RestHighLevelClient客户端，配置类代码如下所示：
```java
/**  
 * es配置类  
 *  
 * @author ygl  
 * @since 2023-05-25  
 **/@Slf4j  
@Data  
@Configuration  
@ConfigurationProperties(prefix = "elasticsearch")  
public class ElasticsearchConfig {  
  
    // 是否开启ES  
    private Boolean open;  
  
    // es host ip 地址（集群）  
    private String hosts;  
  
    // es用户名  
    private String userName;  
  
    // es密码  
    private String password;  
  
    // es 请求方式  
    private String scheme;  
  
    // es集群名称  
    private String clusterName;  
  
    // es 连接超时时间  
    private int connectTimeOut;  
  
    // es socket 连接超时时间  
    private int socketTimeOut;  
  
    // es 请求超时时间  
    private int connectionRequestTimeOut;  
  
    // es 最大连接数  
    private int maxConnectNum;  
  
    // es 每个路由的最大连接数  
    private int maxConnectNumPerRoute;  
  
  
    /**  
     * 如果@Bean没有指定bean的名称，那么这个bean的名称就是方法名  
     */  
    @Bean(name = "restHighLevelClient")  
    public RestHighLevelClient restHighLevelClient() {  
  
        // 此处为单节点es  
        String host = hosts.split(":")[0];  
        String port = hosts.split(":")[1];  
        HttpHost httpHost = new HttpHost(host, Integer.parseInt(port));  
  
        // 构建连接对象  
        RestClientBuilder builder = RestClient.builder(httpHost);  
  
        // 设置用户名、密码  
        CredentialsProvider credentialsProvider = new BasicCredentialsProvider();  
        credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(userName, password));  
  
        // 连接延时配置  
        builder.setRequestConfigCallback(requestConfigBuilder -> {  
            requestConfigBuilder.setConnectTimeout(connectTimeOut);  
            requestConfigBuilder.setSocketTimeout(socketTimeOut);  
            requestConfigBuilder.setConnectionRequestTimeout(connectionRequestTimeOut);  
            return requestConfigBuilder;  
        });  
        // 连接数配置  
        builder.setHttpClientConfigCallback(httpClientBuilder -> {  
            httpClientBuilder.setMaxConnTotal(maxConnectNum);  
            httpClientBuilder.setMaxConnPerRoute(maxConnectNumPerRoute);  
            httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);  
            return httpClientBuilder;  
        });  
  
        return new RestHighLevelClient(builder);  
    }  
}
```

其实配置类中也就是构造RestHighLevelClient客户端。注意是放在paicoding-service模块中。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052044856.png)

注意：在yml中的elasticsearch.hosts中千万不要加https前缀，只需要127.0.0.1:9200即可(我在这里翻车过)；否则在配置类中new HttpHost()会出错。

# 2、技术派首页全局查询走ES数据库

在整合之前我先来说下大致逻辑：
1. 根据查询条件去ES中查询出数据
2. 从查询出所有的数据中取出id，然后将id去add进ids中
3. 拿到ids后去MySQL数据库中捞数据

这一套流程下来，要比根据查询条件进行like%值%不走索引查询效率性能好的多。

首先在paicoding-service模块中的ArticleReadServiceImpl类中注入RestHighLevelClient客户端

然后开始编写实现代码，代码实现及过程如下所示：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052228013.png)

# 3、兼容未安装ES继续走MYSQL查询

考虑到有的小伙伴没有安装ES和Canal，为了让代码能够查询首页时还是走MySQL数据库，我这边特意做了兼容，即使没有安装ES等也是可以正常运行。

首先我在yml中增加了是否开启ES值。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052228678.png)

然后在Service层将open值注入
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052229578.png)

最后在代码层面业务层实现
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052229712.png)

# 4、总结

这里我结合上篇整合Canal和这篇文章做个大的总结，只总结思路。应该还算清楚。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202312052230558.png)


