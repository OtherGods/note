å‚è€ƒï¼š[3.3.3ã€ç¬¬ä¸‰å¤„ä¸ºQrLoginHelperç±»](2ã€ç›¸å…³æŠ€æœ¯/24ã€é¡¹ç›®/1ã€æŠ€æœ¯æ´¾/1ã€åŸºç¡€ç¯‡/15ã€æŠ€æœ¯æ´¾æ•´åˆæœ¬åœ°ç¼“å­˜ä¹‹Guava.md#3.3.3ã€ç¬¬ä¸‰å¤„ä¸ºQrLoginHelperç±»)

å®é™…ä½“éªŒè¿‡æŠ€æœ¯æ´¾çš„å°ä¼™ä¼´åº”è¯¥çŸ¥é“æ•´ä¸ªç™»å½•æ˜¯åŸºäºå¾®ä¿¡å…¬ä¼—å·æ¥å®ç°çš„ï¼Œé‚£ä¹ˆæ•´å¥—ç™»å½•æµç¨‹æ˜¯æ€ä¹ˆè®¾è®¡çš„å‘¢ï¼Ÿå¦‚æœè®©æˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™ä¹ˆä¸€ä¸ªæµç¨‹å¯ä»¥æ€ä¹ˆå»åšå‘¢ï¼Ÿç°åœ¨æ–¹å¼æœ‰æ²¡æœ‰æ›´å¥½çš„æ›¿æ¢æ–¹æ¡ˆå‘¢ï¼Ÿ

æ¥ä¸‹æ¥è¿™ç¯‡æ–‡ç« çš„é£æ ¼å’Œå…¶ä»–çš„æ–‡ç« å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä»¥æ—¥å¸¸å·¥ä½œä¸­ä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹å®Œæ•´çš„éœ€æ±‚ä½œä¸ºé©±åŠ¨ï¼Œé€šè¿‡æ ‡å‡†çš„æ–¹æ¡ˆè®¾è®¡ã€å®æ—¶æ–¹æ¡ˆæ¥è¿›è¡Œä»‹ç»è¯´æ˜

# 1ã€æ–¹æ¡ˆè®¾è®¡

é€šå¸¸åœ¨äº§å“çš„éœ€æ±‚äº¤åº•ã€è¯„å®¡ä¹‹åï¼Œå°±åˆ°äº†æˆ‘ä»¬ç ”å‘äººå‘˜å‡ºæ–¹æ¡ˆè®¾è®¡ï¼Œå¸¸è§çš„æ–¹æ¡ˆè®¾è®¡æœ‰ä»¥ä¸‹å‡ ä¸ªæ¿å—
1. éœ€æ±‚ç›¸å…³ç†è§£åŠç›®æ ‡
2. ç ”å‘çš„è®¾è®¡æ–¹æ¡ˆ
	1. ç›¸å¯¹å®Œæ•´çš„è®¾è®¡æ–¹æ¡ˆ
	2. å‰åç«¯äº¤äº’æ–¹å¼ã€æ¥å£APIçº¦å®š
	3. æµ‹è¯•è¦ç‚¹
3. æ’æœŸ
4. éªŒæ”¶æ ‡å‡†
5. ä¸Šçº¿è®¡åˆ’

> å½“ç„¶æˆ‘ä»¬è¿™é‡Œå¹¶ä¸ä¼šå°†æ‰€æœ‰çš„æ¿å—éƒ½å¡«å……ä¸Šï¼Œé‡ç‚¹ä¼šæ”¾åœ¨å‰é¢ä¸¤ç‚¹

## 1.1ã€èƒŒæ™¯ä¸ç›®æ ‡

æŠ€æœ¯æ´¾ä½œä¸ºä¸€ä¸ªæ–‡ç« åˆ†äº«è®ºå›ï¼Œå½“ç„¶ç™»å½•å°±æ˜¯åŸºæœ¬çš„åŠŸèƒ½ç‚¹äº†ï¼›å¾ˆå¤šçš„åŠŸèƒ½éƒ½è¦æ±‚åªæœ‰ç™»å½•ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œç›¸å…³æ“ä½œï¼Œå¦‚å‘æ–‡ã€ç‚¹èµã€è¯„è®ºç­‰

æ‰€ä»¥æˆ‘ä»¬çš„ä¸»è¦ç›®çš„å°±æ˜¯å®ç°æŠ€æœ¯æ´¾çš„ç”¨æˆ·ç™»å½•

## 1.2ã€è®¾è®¡æ–¹æ¡ˆ

åŸºäºç™»å½•è¿™ä¸ªéœ€æ±‚åœºæ™¯ï¼Œå¸¸è§çš„ç™»å½•æ–¹å¼æœ‰æœ€ç»å…¸çš„ç”¨æˆ·å/å¯†ç æ–¹å¼ï¼Œä¹Ÿæœ‰è¿‘äº›å¹´æ¥å¹¿ä¸ºæ™®åŠçš„æ‰‹æœºå·/éªŒè¯ç çš„ç™»å½•æ–¹å¼ä»¥åŠæ‰«ç ç™»å½•æ–¹å¼

æˆ‘ä»¬ä¸»è¦å®ç°çš„åŠŸèƒ½ç‚¹æ˜¯æ”¯æŒæŠ€æœ¯æ´¾çš„ç™»å½•ï¼Œä¸Šé¢å‡ ç§æ–¹å¼éƒ½å¯ä»¥æ”¯æŒï¼Œæˆ‘ä»¬è¿™é‡Œç»™å‡ºä¸åŒç™»å½•æ–¹å¼çš„å®ç°æ–¹æ¡ˆ

### 1.2.1ã€ç”¨æˆ·åå¯†ç æ–¹å¼ç™»å½•

å¯¹äºç”¨æˆ·åå¯†ç çš„ç™»å½•æ–¹å¼ï¼Œå±äºç»å…¸çš„å®ç°æ–¹å¼ï¼Œä¸€èˆ¬æ¥è®²ï¼Œå®ç”¨è¿™ç§æ–¹å¼æ—¶ï¼Œé™¤äº†åŸºç¡€çš„ç™»å½•ä¹‹å¤–ï¼Œè¿˜éœ€è¦æœ‰æ­é…çš„ç”¨æˆ·æ³¨å†Œã€å¿˜è®°å¯†ç ã€ä¿®æ”¹å¯†ç ç­‰åŠŸèƒ½ç‚¹

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122213887.png)

å¦‚ä¸Šå›¾ï¼Œåˆ†åˆ«ç»™å‡ºæ³¨å†Œã€ç™»å½•ã€å¿˜è®°å¯†ç é‡ç½®çš„æµç¨‹ç¤ºæ„å›¾
åŸºäºè¿™ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬çš„ç”¨æˆ·è¡¨åä¸­éœ€è¦è€ƒè™‘ä¸‹é¢è¿™å‡ ä¸ªå…³é”®ä¿¡æ¯
1. userNameï¼šç”¨äºç™»å½•çš„ç”¨æˆ·å
2. passwordï¼šç™»å½•å¯†ç ï¼Œæ³¨æ„dbä¸­ä¸ç›´æ¥å­˜å‚¨æºç ï¼Œå¸¸è§çš„æ–¹æ¡ˆæ˜¯å°†ç”¨æˆ·ä¸Šä¼ çš„å¯†ç åŠ ç›ä¹‹åè®¡ç®—MD5ä¿å­˜
3. `email/phone`ï¼šä¸»è¦ç”¨äºå¿˜è®°å¯†ç æ—¶ï¼Œå‘ç”¨æˆ·å‘é€ç”¨äºä¿®æ”¹å¯†ç çš„éªŒè¯ç æˆ–é‡ç½®å¯†ç çš„ä¸´æ—¶urlï¼ˆä¸»è¦ç›®çš„æ˜¯ç¡®å®šè¿™ä¸ªè´¦å·çœŸçš„æ˜¯xxxåœ¨æ“ä½œï¼‰

æ•´ä¸ªæ–¹æ¡ˆå®ç°ä¸‹æ¥ä¸­è§„ä¸­çŸ©ï¼Œé‡ç‚¹æ³¨æ„çš„å…³é”®ç‚¹æ— éä¸¤ä¸ªï¼š
1. å¯†ç æ³¨æ„ä¸æ˜æ–‡å­˜å‚¨
2. å¿˜è®°å¯†ç æ—¶ï¼Œéœ€è¦ç»™ç”¨æˆ·å‘é€éªŒè¯ç 

**ä¼˜ç‚¹**
1. ç”¨æˆ·æ³¨å†Œæˆæœ¬ä½
2. æµç¨‹æ¸…æ™°ç®€å•ã€æ˜“äºç†è§£

**ç¼ºç‚¹**
1. æ¥å£å¤šï¼Œæµç¨‹å¤šï¼ˆé™¤äº†ç™»å½•è¿˜æœ‰æ³¨å†Œã€å¿˜è®°å¯†ç ã€ä¿®æ”¹å¯†ç ç­‰æ“ä½œï¼‰ï¼Œå®ç°å·¥ä½œé‡ç›¸å¯¹è¾ƒå¤§
2. ç”¨æˆ·å®¹æ˜“å¿˜è®°å¯†ç ï¼Œå®‰å…¨æ€§æ²¡æœ‰å…¶ä»–çš„é«˜
3. æ‰‹æœºå·å‘é€éªŒè¯ç æ—¶è¦èŠ±é’±ï¼›é‚®ç®±å‘é€éªŒè¯ç æ—¶å®¹æ˜“è¢«å½“ä½œåƒåœ¾é‚®ä»¶æ‹‰é»‘

### 1.2.2ã€éªŒè¯ç ç™»å½•

éªŒè¯ç çš„ç™»å½•æ–¹å¼å¯¹ç”¨æˆ·è€Œè¨€ä½“éªŒæ˜¯æ¯”è¾ƒå‹å¥½çš„ï¼Œä¹Ÿä¸ç”¨è®°å¯†ç ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šæ‹…å¿ƒå¿˜è®°å¯†ç äº†ï¼Œæˆ‘ä»¬ä¸€èˆ¬è¯´çš„éªŒè¯ç ç™»å½•æ–¹å¼ä¸“æŒ‡æ‰‹æœºå·ç™»å½•ï¼Œä¸€èˆ¬çš„æ“ä½œæµç¨‹å¦‚ä¸‹
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122233909.png)

ä»ä¸Šé¢çš„æµç¨‹ç¤ºæ„å›¾å¯ä»¥çœ‹å‡ºï¼Œç”¨æˆ·è¡¨ä¸­æ ¸å¿ƒå­˜å‚¨æ‰‹æœºå·/é‚®ç®±å³å¯
1. phone: é‡‡ç”¨æ‰‹æœºå·éªŒè¯ç çš„æ–¹å¼ï¼Œå­˜æ‰‹æœºå·å³å¯
2. email: é‡‡ç”¨é‚®ç®±æ¥æ”¶éªŒè¯ç çš„æ–¹å¼ï¼Œå­˜é‚®ç®±å³å¯
æŒ‚ä»¶çš„åŠ¨ä½œæœ‰ä¸¤æ­¥
1. ç”¨æˆ·é¦–å…ˆè¾“å…¥æ‰‹æœºå·/é‚®ç®±ï¼Œç„¶åè¯·æ±‚æŠ€æœ¯æ´¾å‘é€éªŒè¯ç 
2. ç™»å½•ï¼šæäº¤æ‰‹æœºå·/é‚®ç®± + éªŒè¯ç 

**ä¼˜ç‚¹**
1. å¯¹ç”¨æˆ·è€Œè¨€æ“ä½œæ¯”è¾ƒç®€å•ï¼Œä¸ç”¨è®°å¯†ç ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒå¿˜è®°å¯†ç ã€é‡ç½®å¯†ç 

**ç¼ºç‚¹**
1. æ•´ä¸ªç™»å½•æµç¨‹æ˜¯åˆ†æ®µçš„ï¼Œå½“æ¥æ”¶éªŒè¯ç è¾ƒæ…¢æ—¶ï¼Œå¯èƒ½ä¼šé˜»å¡è¾ƒé•¿çš„æ—¶é—´
2. åŒæ ·æ‰‹æœºå·æ¥æ”¶éªŒè¯ç è´¹é’±ï¼›é‚®ç®±æ¥æ”¶éªŒè¯ç å¯¹ç”¨æˆ·ä½“éªŒåˆä¸å¤ªå¥½ï¼ˆç‰¹åˆ«æ˜¯å›½å†…æ‰‹æœºä¸Šä½¿ç”¨é‚®ç®±çš„è¾ƒå°‘ï¼‰

### 1.2.3ã€æ‰«ç ç™»é™†

å…³äºæ‰«ç ç™»å½•ï¼Œå¯¹äºpcç«™ç‚¹è€Œè¨€å¯ä»¥è¯´æˆäº†æ ‡é…äº†ï¼›å½“ç„¶å‰ææ˜¯å®‰è£…äº†å¯¹åº”çš„appï¼›è¯¦æƒ…å¯ä»¥å‚çœ‹
- [6ã€æŠ€æœ¯æ´¾ä¹‹æ‰«ç ç™»å½•å®ç°åŸç†](2ã€ç›¸å…³æŠ€æœ¯/24ã€é¡¹ç›®/1ã€æŠ€æœ¯æ´¾/2ã€è¿›é˜¶ç¯‡/6ã€æŠ€æœ¯æ´¾ä¹‹æ‰«ç ç™»å½•å®ç°åŸç†.md)

å®ƒçš„åŸºæœ¬æµç¨‹å¦‚ä¸‹
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122237277.png)

ä¸€èˆ¬çš„æ‰«ç ç™»å½•ï¼Œå‰æè¦æ±‚æ˜¯ä½ å·²ç»ç½‘ç«™çš„ç”¨æˆ·äº†ï¼Œå®‰è£…å¯¹åº”çš„appä¸”ç™»å½•ä¹‹åï¼Œç»™pcç«™ç‚¹çš„ç™»å½•æ–°å¢ä¸€ä¸ªå…å¯†çš„é€‰æ‹©æ–¹å¼è€Œå·²ï¼›ä¸æˆ‘ä»¬æŠ€æœ¯æ´¾çš„å®é™…åœºæ™¯è¿˜æ˜¯æœ‰å‡ºå…¥çš„

**ä¼˜ç‚¹**
- ç™»å½•æ–¹å¼ç®€å•ï¼Œæˆæœ¬å¾ˆä½

**ç¼ºç‚¹**
- è¦æ±‚ç”¨æˆ·ä¸‹è½½app
- å®ç°å§¿åŠ¿ç›¸æ¯”ä¸Šé¢ä¸¤ä¸ªä¼šæ›´æœ‰éš¾åº¦ä¸€ç‚¹

### 1.2.4ã€åŸºäºå¾®ä¿¡å…¬ä¼—å·ç™»å½•

æŠ€æœ¯æ´¾å½“ä¸‹æ²¡æœ‰appï¼Œä¹Ÿä¸ç¡®å®šä¹‹åä¼šä¸ä¼šæœ‰ï¼ˆğŸ˜‚ï¼‰ï¼Œæˆ‘ä»¬é‡‡ç”¨çš„ç™»å½•æ–¹å¼æ˜¯ä¸Šé¢æ‰«ç ç™»å½•çš„å˜ç§ï¼Œæ—¢ç„¶æˆ‘æ²¡æœ‰appï¼Œé‚£å°±å€ŸåŠ©å¾®ä¿¡çš„å…¬ä¼—å·æ¥åš

è™½ç„¶æˆ‘è¿™é‡Œç™»å½•æ—¶å±•ç¤ºçš„æ˜¯ä¸€ä¸ªäºŒç»´ç ï¼Œä½†å®é™…ä¸Šçš„æ“ä½œæ˜¯å€ŸåŠ©è¿™ä¸ªå±•ç¤ºçš„è¿‡ç¨‹ï¼Œå’Œå‰ç«¯æ„å»ºä¸€ä¸ªåŠé•¿è¿æ¥ï¼Œå½“ç”¨äºå‘å…¬ä¼—å·å‘é€éªŒè¯ç ä¹‹åï¼Œå¾®ä¿¡å…¬ä¼—å¹³å°ä¼šå°†ç”¨æˆ·å‘é€ä¿¡æ¯è½¬å‘ç»™æŠ€æœ¯æ´¾çš„æœåŠ¡å™¨ï¼Œé€šè¿‡éªŒè¯ç æ¥è¯†åˆ«è¯·æ±‚ç™»å½•çš„ç”¨æˆ·èº«ä»½ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŠé•¿è¿æ¥ï¼Œå®ç°ç”¨æˆ·çš„è‡ªåŠ¨ç™»å½•è·³è½¬
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122259129.png)

åŸºäºä¸Šé¢çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬çš„ç”¨æˆ·è¡¨ä¸­éœ€è¦å­˜å‚¨ä¸€ä¸ªæ ¸å¿ƒçš„ç”¨æˆ·æ ‡è¯†
- uuid: å¾®ä¿¡å…¬ä¼—å¹³å°è¿”å›çš„ç”¨äºå”¯ä¸€æ ‡è¯†

**ä¼˜ç‚¹**
- å¯¹äºç”¨æˆ·è€Œè¨€ç™»å½•æ–¹å¼ç®€å•ï¼Œæ— éœ€è®°å¿†å¯†ç ã€ç”¨æˆ·åï¼Œæœ‰å¾®ä¿¡å·å³å¯
- å¯¹äºå­¦ä¹ æŠ€æœ¯æ´¾é¡¹ç›®çš„å°ä¼™ä¼´è€Œè¨€ï¼Œåˆå¯ä»¥å­¦åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„çŸ¥è¯†ç‚¹
**ç¼ºç‚¹**
- å®ç°æ–¹å¼ç›¸å¯¹å‰é¢çš„å¤æ‚ä¸€ç‚¹
- ä¸ªäººå…¬ä¼—å·ä¸æ”¯æŒè‡ªå®šä¹‰äºŒç»´ç å‚æ•°ï¼Œå› æ­¤è¿˜éœ€è¦è¾“å…¥éªŒè¯ç è¿™ä¸€æ­¥éª¤ï¼Œæ“ä½œéº»çƒ¦äº†ä¸€ç‚¹ï¼ˆä¼ä¸šå…¬ä¼—å·å°±å¯ä»¥å®ç°æ‰«ç ä¹‹åç›´æ¥è‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€è¾“å…¥éªŒè¯ç ï¼‰

## 1.3ã€æ–¹æ¡ˆç¡®å®š


ä¸Šé¢ç»™äº†å‡ ä¸ªæ–¹æ¡ˆï¼Œæ˜¾ç„¶æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©çš„æ˜¯ç¬¬å››ä¸ªåŸºäºå¾®ä¿¡å…¬ä¼—å·æ¥ç™»å½•
å› æ­¤ä½ éœ€è¦å‡†å¤‡çš„å°±æ˜¯ä¸€ä¸ªå¾®ä¿¡å…¬ä¼—å·ï¼Œå…¶æ¬¡å°±æ˜¯ä¸€å°å¾®ä¿¡å…¬ä¼—å¹³å°å¯ä»¥å›è°ƒçš„æœåŠ¡å™¨

# 2ã€å®ç°ç­–ç•¥
## 2.1ã€å¾®ä¿¡å…¬ä¼—å·å¹³å°é…ç½®

å› ä¸ºæˆ‘ä»¬å®é™…ä½¿ç”¨çš„å¾®ä¿¡å…¬ä¼—å¹³å°åŠŸèƒ½è¾ƒå°‘ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªæ¥æ”¶ç”¨æˆ·çš„å‘é€ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦çš„é…ç½®ä¹Ÿä¸å¤š

ç›´æ¥ç™»å½•åå°ï¼Œå¼€å¯æœåŠ¡å™¨ç›¸å…³é…ç½®
> æˆ‘çš„å…¬ä¼—å·ï¼šè“è‰²çš„é¸Ÿ é…ç½®çš„Tokenï¼šhhyDance
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122302291.png)

æ³¨æ„ï¼Œå¾®ä¿¡å…¬ä¼—å¹³å°æ¥å…¥æ—¶ï¼Œéœ€è¦è¿›è¡Œä¸€ä¸ªtokenéªŒè¯ï¼Œå³è¿”å›å®ƒä¼ å‚çš„echostr
å¯¹åº”çš„å®ç°ä¹Ÿæ¯”è¾ƒç®€å•
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122302791.png)

```java
/**  
 * å¾®ä¿¡çš„å…¬ä¼—å·æ¥å…¥ token éªŒè¯ï¼Œå³è¿”å›echostrçš„å‚æ•°å€¼  
 *  
 * @param request  
 * @return  
 */  
@GetMapping(path = "callback")  
public String check(HttpServletRequest request) {  
    String echoStr = request.getParameter("echostr");  
    if (StringUtils.isNoneEmpty(echoStr)) {  
        return echoStr;  
    }  
    return "";  
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œå¦å¤–å·²ç»™éœ€è¦å®ç°çš„å°±æ˜¯æ¥æ”¶å¾®ä¿¡å…¬ä¼—å¹³å°çš„å›è°ƒï¼Œæ³¨æ„å¾®ä¿¡å…¬ä¼—å·é‡‡ç”¨çš„æ˜¯xmlè¿›è¡Œé€šè®¯ï¼ˆè¯´å®è¯è¿™ä¸ªçœŸæœ‰ç‚¹è›‹ç–¼ï¼‰

æˆ‘ä»¬éœ€è¦å®ç°çš„æ¥å£å¦‚ä¸‹ï¼ˆåæ–‡ç»™å‡ºè¯¦è®¾ï¼‰
```java
/**  
 * fixme: éœ€è¦åšé˜²åˆ·æ ¡éªŒ  
 * å¾®ä¿¡çš„å“åº”è¿”å›  
 * æœ¬åœ°æµ‹è¯•è®¿é—®: curl -X POST 'http://localhost:8080/wx/callback' -H 'content-type:application/xml' -d '<xml><URL><![CDATA[https://hhui.top]]></URL><ToUserName><![CDATA[ä¸€ç°ç°blog]]></ToUserName><FromUserName><![CDATA[demoUser1234]]></FromUserName><CreateTime>1655700579</CreateTime><MsgType><![CDATA[text]]></MsgType><Content><![CDATA[login]]></Content><MsgId>11111111</MsgId></xml>' -i  
 * * @param msg  
 * @return  
 */  
@PostMapping(path = "callback",  
        consumes = {"application/xml", "text/xml"},  
        produces = "application/xml;charset=utf-8")  
public BaseWxMsgResVo callBack(@RequestBody WxTxtMsgReqVo msg) {}
```

## 2.2ã€ç”¨æˆ·æ‰«ç ç™»å½•

åœ¨å‰é¢çš„æ–¹æ¡ˆè®¾è®¡ä¸­ï¼Œæœ‰ä¸€ç‚¹æ²¡æœ‰ç‰¹åˆ«çš„æ ‡æ³¨å‡ºæ¥ï¼Œé‚£å°±æ˜¯ç”¨æˆ·ç‚¹å‡»ç™»å½•ä¹‹åï¼Œå¼¹å‡ºä¸€ä¸ªå¾®ä¿¡å…¬ä¼—å·çš„äºŒç»´ç çš„åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªä¸å‰ç«¯çš„åŠé•¿è¿æ¥ï¼Œä¸»è¦ç›®çš„å°±æ˜¯ç”¨äºåç»­çš„è‡ªåŠ¨ç™»å½•è·³è½¬
è¿™é‡Œæˆ‘ä»¬è®¾è®¡äº†ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ˜¯è·å–ç™»å½•çš„éªŒè¯ç ï¼Œä¸€ä¸ªæ˜¯å»ºç«‹åŠé•¿è¿æ¥

**éªŒè¯ç è·å–**
> com.github.paicoding.forum.web.front.login.rest.LoginRestController#qrLogin

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122309458.png)


```java
/**  
 * è·å–ç™»å½•çš„éªŒè¯ç   
 *  
 * @return  
 */  
@GetMapping(path = "/login/code")  
public ResVo<QrLoginVo> qrLogin(HttpServletRequest request, HttpServletResponse response) {  
    QrLoginVo vo = new QrLoginVo();  
    vo.setCode(qrLoginHelper.genVerifyCode(request, response));  
    return ResVo.ok(vo);

// æ ¸å¿ƒå®ç°å°±æ˜¯éªŒè¯ç é‚£é‡Œ
/**  
 * åŠ ä¸€å±‚è®¾å¤‡idï¼Œä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†é¿å…ä¸æ–­åˆ·æ–°é¡µé¢æ—¶ï¼Œä¸æ–­çš„å¾€ verifyCodeCache ä¸­å¡å…¥æ–°çš„kvå¯¹  
 * å…¶æ¬¡å°±æ˜¯ç¡®ä¿äº”åˆ†é’Ÿå†…ï¼Œä¸ç®¡åˆ·æ–°å¤šå°‘æ¬¡ï¼ŒéªŒè¯ç éƒ½ä¸€æ ·  
 *  
 * @param request  
 * @param response  
 * @return  
 */  
public String genVerifyCode(HttpServletRequest request, HttpServletResponse response) {  
    String deviceId = initDeviceId(request, response);  
    String code = deviceCodeCache.getUnchecked(deviceId);  
    SseEmitter lastSse = verifyCodeCache.getIfPresent(code);  
    if (lastSse != null) {  
        // è¿™ä¸ªè®¾å¤‡ä¹‹å‰å·²ç»å»ºç«‹äº†è¿æ¥ï¼Œåˆ™ç§»é™¤æ—§çš„ï¼Œé‡æ–°å†å»ºç«‹ä¸€ä¸ª; é€šå¸¸æ˜¯ä¸æ–­åˆ·æ–°ç™»å½•é¡µé¢ï¼Œä¼šå‡ºç°è¿™ä¸ªåœºæ™¯  
        lastSse.complete();  
        verifyCodeCache.invalidate(code);  
    }  
    return code;  
}
```

å…³äºéªŒè¯ç çš„è·å–ï¼Œåšäº†ä¸€ä¸ªå…¼å®¹ç­–ç•¥ï¼ŒåŒä¸€ä¸ªè®¾å¤‡ï¼Œä¸è®¿é—®å¤šå°‘æ¬¡éªŒè¯ç éƒ½æ˜¯åŒä¸€ä¸ªï¼ˆåˆ·æ–°é™¤å¤–ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†ä¸¤ä¸ªç¼“å­˜
1. deviceCodeCache: ç¼“å­˜ deviceId è®¾å¤‡ ä¸éªŒè¯ç ä¹‹é—´çš„æ˜ å°„å…³ç³»
2. verifyCodeCache: ç¼“å­˜ codeéªŒè¯ç  ä¸ åŠé•¿è¿æ¥ä¹‹é—´çš„æ˜ å°„å…³ç³»

**åŠé•¿è¿æ¥å»ºç«‹**
> com.github.paicoding.forum.web.front.login.view.LoginViewController#subscribe
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122315765.png)

```java
/**  
 * å®¢æˆ·ç«¯ä¸åç«¯å»ºç«‹æ‰«æäºŒç»´ç çš„é•¿è¿æ¥  
 *  
 * @param code  
 * @return  
 */  
@GetMapping(path = "subscribe", produces = {org.springframework.http.MediaType.TEXT_EVENT_STREAM_VALUE})  
public SseEmitter subscribe(@RequestParam(name = "id") String code) throws IOException {  
    return qrLoginHelper.subscribe(code);  
}

/**  
 * ä¿æŒä¸å‰ç«¯çš„é•¿è¿æ¥  
 * <p>  
 * ç›´æ¥æ ¹æ®è®¾å¤‡æ‹¿ä¹‹å‰åˆå§‹åŒ–çš„éªŒè¯ç ï¼Œä¸ç›´æ¥ä½¿ç”¨ä¼ è¿‡æ¥çš„code  
 * * @param code  
 * @return  
 */  
public SseEmitter subscribe(String code) throws IOException {  
    HttpServletRequest req = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();  
    HttpServletResponse res = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();  
    String device = initDeviceId(req, res);  
    String realCode = deviceCodeCache.getUnchecked(device);  
  
    // fixme è®¾ç½®15minçš„è¶…æ—¶æ—¶é—´, è¶…æ—¶æ—¶é—´ä¸€æ—¦è®¾ç½®ä¸èƒ½ä¿®æ”¹ï¼›å› æ­¤å¯¼è‡´åˆ·æ–°éªŒè¯ç å¹¶ä¸ä¼šå¢åŠ è¿æ¥çš„æœ‰æ•ˆæœŸ  
    SseEmitter sseEmitter = new SseEmitter(15 * 60 * 1000L);  
    verifyCodeCache.put(code, sseEmitter);  
    sseEmitter.onTimeout(() -> verifyCodeCache.invalidate(realCode));  
    sseEmitter.onError((e) -> verifyCodeCache.invalidate(realCode));  
    if (!Objects.equals(realCode, code)) {  
        // è‹¥å®é™…çš„éªŒè¯ç ä¸å‰ç«¯æ˜¾ç¤ºçš„ä¸åŒï¼Œåˆ™é€šçŸ¥å‰ç«¯æ›´æ–°  
        sseEmitter.send("initCode!");  
        sseEmitter.send("init#" + realCode);  
    }  
    return sseEmitter;  
}
```

ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„åŠé•¿è¿æ¥å»ºç«‹è¿‡ç¨‹ï¼›å¹¶ä¼šä¿å­˜ä¸€ä¸ªéªŒè¯ç ä¸åŠé•¿è¿æ¥sseEmitterä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼›åç»­åœ¨ç™»å½•æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡éªŒè¯ç æ‰¾åˆ°å¯¹åº”çš„SseEmitterï¼Œä»è€Œå®ç°ç™»å½•

**è¯´æ˜**
å½“å‰ä¸Šé¢çš„ä¸¤ä¸ªæ¥å£æ˜¯æ­é…ä½¿ç”¨
- å‰ç«¯é¦–å…ˆè°ƒç”¨è·å–éªŒè¯ç æ¥å£ -> è¿™é‡Œå°†è®¾å¤‡ä¸éªŒè¯ç å»ºç«‹æ˜ å°„ï¼Œå¹¶ä¼šé‡Šæ”¾ä¹‹å‰å»ºç«‹çš„åŠé•¿è¿æ¥ï¼Œè¿”å›éªŒè¯ç 
- åŸºäºéªŒè¯ç æ¥å»ºç«‹åŠé•¿è¿æ¥ -> æ­¤æ—¶æ„å»ºäº† éªŒè¯ç ä¸åŠé•¿è¿æ¥çš„æ˜ å°„ï¼Œå› æ­¤åç»­ç™»å½•æ—¶ï¼Œç›´æ¥å¯ä»¥é€šè¿‡éªŒè¯ç æŸ¥åˆ°å¯¹åº”çš„è¿æ¥å®¢æˆ·ç«¯ï¼Œä»è€Œå®ç°è‡ªåŠ¨ç™»å½•

é‚£ä¹ˆä¸Šé¢è¿™ä¸ªè®¾è®¡ä¸ºä»€ä¹ˆè¦æ‹†åˆ†ä¸ºä¸¤ä¸ªæ¥å£ï¼Ÿ
- è¿™ä¸ªæ˜¯ç”±äºå†å²åŸå› ï¼Œæœ€å¼€å§‹çš„å¾®ä¿¡å…¬ä¼—å·ç™»å½•é‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯ç”¨æˆ·å…³æ³¨å…¬ä¼—å·ä¹‹åï¼Œè¾“å…¥å…³é”®å­— éªŒè¯ç /loginï¼Œç„¶åæŠ€æœ¯æ´¾è¿”å›éªŒè¯ç ç»™å…¬ä¼—å·ï¼Œç„¶åç”¨æˆ·åœ¨ç™»å½•çš„é¡µé¢ä¸Šè¾“å…¥è¿™ä¸ªéªŒè¯ç æ¥å®ç°ç™»å½•çš„ï¼›
- é‰´äºä¸Šé¢è¿™ä¸ªæµç¨‹æ“ä½œæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥æˆ‘ä»¬æ”¹æˆäº†ç°åœ¨çš„è¿™ç§æ“ä½œæ–¹å¼ï¼›ä½†æ˜¯åœ¨å®ç°ä¸Šå°±æ²¡æœ‰é‡æ–°è®¾è®¡ï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨äº†ä¹‹å‰çš„æ–¹æ¡ˆ ï¼ˆè¿™ä¹Ÿæ˜¯ç°å®ä¸­çš„é¡¹ç›®ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—çš„è¿­ä»£ä¹‹åï¼Œé€æ¸å¾€å±å±±å‘å±•çš„é‡è¦åŸå› ï¼‰
- æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å°è¯•ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªæµç¨‹

## 2.3ã€å‰ç«¯è°ƒç”¨å§¿åŠ¿

ä¸Šé¢ä¸¤ä¸ªæ¥å£ä¸»è¦æ˜¯åç«¯çš„æ¥å£è®¾è®¡ï¼Œæ•´ä¸ªæµç¨‹å½“ç„¶è¿˜ç¼ºä¸äº†å‰ç«¯çš„æ”¯æŒï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å‰ç«¯æ˜¯å¦‚ä½•å®ç°çš„

> src/main/resources/templates/components/layout/navbar.html
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122322433.png)

æ ¸å¿ƒå®ç°å¦‚ä¸‹
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122326033.png)

ä¸Šé¢æ˜¯å‰ç«¯jsçš„å®ç°ï¼Œå†™å¾—ä¸å’‹æ ·ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥é‡å†™ä¸€ä¸‹ï¼›æ•´ä¸ªé€»è¾‘ä¸åç«¯çš„æ¥å£è®¾è®¡æ˜¯æ­é…çš„ï¼›å…ˆè·å–éªŒè¯ç å†å»ºç«‹è¿æ¥ï¼›å®Œå…¨æ˜¯å¯ä»¥çœç•¥å‰é¢çš„ä¸€æ­¥æ“ä½œçš„
## 2.4ã€å¾®ä¿¡å…¬ä¼—å·å›è°ƒå®ç°è‡ªåŠ¨ç™»å½•

ä¸Šé¢çš„ä¸¤æ­¥æ“ä½œä¹‹åï¼ŒæŠ€æœ¯æ´¾çš„å‰ç«¯ç”¨æˆ·æ“ä½œä¸åå°çš„é€»è¾‘åŸºæœ¬ä¸Šå°±ç®—æ˜¯å®Œæˆäº†ï¼›
ç”¨æˆ·ç™»å½•ä¹‹å -> ä¸åç«¯å»ºç«‹åŠé•¿è¿æ¥
æ¥ä¸‹æ¥å°±æ˜¯ç”¨æˆ·å°†éªŒè¯ç å‘é€ç»™å…¬ä¼—å·ï¼Œç„¶åå…¬ä¼—å·å°†ç”¨æˆ·è¾“å…¥è½¬å‘ç»™æŠ€æœ¯æ´¾åç«¯æ³¨å†Œçš„å›è°ƒæ¥å£äº†
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122327983.png)

å›è°ƒæ¥å£å¦‚ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬çš„å…¬ä¼—å·ä¸ºä¸ªäººå…¬ä¼—å·ï¼Œæ‰€ä»¥å›¾ä¸­çš„ if é€»è¾‘æˆ‘ä»¬èµ°ä¸åˆ°ï¼Œæœ‰ä¼ä¸šå…¬ä¼—å·çš„å°ä¼™ä¼´åˆ™å¯ä»¥è¿›å…¥åˆ°è¿™ä¸ªæµç¨‹ï¼›æˆ‘ä»¬é‡ç‚¹æŸ¥çœ‹ä¸‹é¢çš„ wxHelper.buildResponseBody

ç™»å½•é€»è¾‘å¦‚ä¸‹ï¼Œå…¶ä»–çš„æ˜¯è‡ªåŠ¨å›å¤å†…å®¹ï¼Œä¸ç”¨å…³å¿ƒ
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122327534.png)

ä¸Šé¢åŒºåˆ†äº†ä¸¤æ­¥
1. ç”¨æˆ·æ³¨å†Œï¼Œå¹¶ç”Ÿæˆç”¨äºèº«ä»½è¯†åˆ«çš„sessionId
2. æ‰¾åˆ°å¯¹åº”çš„åŠé•¿è¿æ¥ï¼Œè‡ªåŠ¨ç™»å½•è·³è½¬

**è¯´æ˜**
- ä¸Šé¢çš„è¿™å¥—å…·ä½“å®ç°ä»¥å®é™…çš„æºç ä¸ºå‡†ï¼Œè¿™é‡Œä¸è¿‡å¤šç»†è¯´
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122328111.png)

## 2.5ã€å°ç»“

åŸºäºä¸Šé¢è¿™ä¸ªè®¾è®¡æ€è·¯ä»¥åŠå…³é”®çš„å®ç°åŠ¨ä½œï¼Œæ•´ä¸ªåŸºäºå¾®ä¿¡å…¬ä¼—å·çš„ç™»å½•æ–¹æ¡ˆå°±å·²ç»å®ç°äº†ï¼›å†ç»™ä¸€ä¸ªå®é™…çš„ä½“éªŒæ•ˆæœç»™å¤§å®¶ç…ä¸€ä¸‹

![](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202309122329994.gif)

å½“å‰çš„å¾®ä¿¡å…¬ä¼—å·ç™»å½•çš„åç«¯ä»£ç ä¸­ï¼Œç”±äºå®ç°äº†ä¸¤ç§ç™»å½•æ–¹æ¡ˆï¼ˆä¸€ä¸ªæ˜¯å½“å‰åœ¨ä½¿ç”¨çš„åœ¨å…¬ä¼—å·ä¸­è¾“å…¥éªŒè¯ç ç­–ç•¥ï¼Œä»¥åŠå¦å¤–ä¸€ä¸ªå·²ç»åºŸå¼ƒçš„ä»å…¬ä¼—å·è·å–éªŒè¯ç ï¼Œç„¶åå†æŠ€æœ¯æ´¾çš„è¾“å…¥æ¡†ä¸­è¾“å…¥éªŒè¯ç ç™»å½•çš„æ–¹æ¡ˆï¼‰ï¼Œæ‰€ä»¥ä¼šå‘ç°åœ¨æ•´ä¸ªå®ç°ç­–ç•¥ä¸­ï¼Œæœ‰ä¸€äº›å†—ä½™çš„æ“ä½œï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å°†åé¢çš„ç™»å½•æ–¹å¼ç»™å¹²æ‰ï¼Œä¼˜åŒ–ä¸€ä¸‹æ•´ä¸ªå†™æ³•

**è¡¥å……è¯´æ˜ï¼š**
æ—¢ç„¶ä¸Šé¢æåˆ°äº†ä¸¤ç§æ–¹æ¡ˆï¼Œå°±å†å¤šè¯´ä¸€å¥
- å½“å‰é€‰ç”¨çš„æ–¹æ¡ˆï¼Œå®é™…ä¸Šæœ‰ä¸ªç¼ºé™·ï¼Œæˆ‘ä»¬ä¸ºäº†ç®€åŒ–ä½¿ç”¨è€…çš„æ“ä½œï¼Œå¯¹äºéªŒè¯ç åšäº†ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œæœ€åˆç”Ÿæˆçš„éƒ½æ˜¯ä¸€äº›éå¸¸å¥½è®°çš„å¦‚666,888,999ç­‰æ•°å­—ï¼Œæ‰€ä»¥å­˜åœ¨å¸®åˆ«äººç™»å½•çš„å¯èƒ½æ€§

å…³äºæ•´ä¸ªç™»å½•æµç¨‹ï¼Œè¿™ç¯‡æ–‡ç« å…¶å®æƒ³è¯´ä¸¤ç‚¹
- ä¸€ä¸ªéœ€æ±‚è®¾è®¡æ–¹æ¡ˆæ€ä¹ˆå†™ ï¼ˆå½“å…·ä½“å®ç°æœ‰å¤šç§ç­–ç•¥æ—¶ï¼Œè¦å¯¹æ¯”å„è‡ªçš„ä¼˜åŠ£ï¼Œç„¶åç»™å‡ºè‡ªå·±çš„é€‰æ‹©ï¼Œå†å‘ä¸Šæ±‡æŠ¥è¿›è¡Œæ–¹æ¡ˆè¯„å®¡ï¼‰
- æ•´ä½“æµç¨‹çš„å®ç°æ–¹æ¡ˆ
- æŠ€æœ¯ç»†èŠ‚æœ‰å¾ˆå¤šï¼Œéœ€è¦å¤§å®¶æ·±æŒ–ä¸€ä¸‹
	- åŠé•¿è¿æ¥
	- å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å…¥
	- xml/jsonä¸€ä¸ªé¡¹ç›®ä¸­å¦‚ä½•åŒæ—¶æ”¯æŒ
	- ç¼“å­˜ç»“æ„è®¾è®¡
	- ç”¨æˆ·åã€å¤´åƒè‡ªåŠ¨ç”Ÿæˆé€‰æ‹©ç­–ç•¥
	- ç”¨æˆ·èº«ä»½è¯†åˆ«æ–¹æ¡ˆï¼Œsession/cookie
	- é‡å®šå‘
	- ...

