技术派项目中，提供了四种开发环境，针对不同的环境，打出来的包也不太一样，这个需要我们额外注意；比如正式环境的，可别打出来一个测试环境的包；接下来我们将介绍一下，技术派中的多环境配置，是怎么支持的

本文介绍主要是基于maven的多环境配置方式
# 1、配置
## 1.1、多环境配置

需要在pom.xml文件中，添加`<profiles>`，用于定义各种环境
```xml
<profiles>  
    <!-- 本地开发 -->  
    <profile>  
        <id>dev</id>  
        <properties>  
            <env>dev</env>  
        </properties>  
        <activation>  
            <activeByDefault>true</activeByDefault>  
        </activation>  
    </profile>  
    <!-- 测试 -->  
    <profile>  
        <id>test</id>  
        <properties>  
            <env>test</env>  
        </properties>  
    </profile>  
    <!-- 预发 -->  
    <profile>  
        <id>pre</id>  
        <properties>  
            <env>pre</env>  
        </properties>  
    </profile>  
    <!-- 生产 -->  
    <profile>  
        <id>prod</id>  
        <properties>  
            <env>prod</env>  
        </properties>  
    </profile>  
</profiles>  
  
<build>  
    <resources>  
        <resource>  
            <directory>src/main/resources</directory>  
        </resource>  
        <resource>  
            <directory>src/main/resources-env/${env}</directory>  
            <filtering>true</filtering>  
        </resource>  
    </resources>  
</build>
```

上面定义了四个环境，默认处于dev开发环境

其次就是build标签中的resource，用于指定不同环境下的资源存放位置；在resources目录下的配置文件为所有环境共享的配置，注意，具体环境下的配置，会覆盖默认的resources下的配置

如下图：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202404051742520.png)

以application-image.yml配置文件为例

**dev环境配置:**
```yaml
image:  
  abs-tmp-path: /tmp/storage/  
  web-img-path: /forum/image/  
  tmp-upload-path: /tmp/forum/  
  cdn-host:  
  oss:  
    type: local  
    prefix: paicoding/  
    endpoint:  
    ak:  
    sk:  
    bucket:  
    host: https://cdn.tobebetterjavaer.com  
  
spring:  
  web:  
    resources:  
      # 支持本地图片上传之后的链接，其中 file:///d的用于win系统，后面的file: 适用于mac/linux系统  
      static-locations:  
        - classpath:/static/  
        - file:///d:${image.abs-tmp-path}  
        - file:${image.abs-tmp-path}
```

**pre环境配置**
```yaml
image:  
  abs-tmp-path: /home/work/storage  
  web-img-path: forum/imge/  
  tmp-upload-path: /tmp/forum/  
  oss:  
    type: local  
    endpoint:  
    prefix: paicoding/  
    ak:  
    sk:  
    bucket:  
    host:
```

**prod环境配置**
```yaml
image:  
  # 服务器保存图片的绝对地址  
  abs-tmp-path: /home/admin/storage/  
  # 图片前缀  
  web-img-path: forum/img/  
  # 临时存储目录  
  tmp-upload-path: /tmp/forum/  
  # 图片访问域名  
  cdn-host: https://imgs.hhui.top/  
  oss:  
    type: local  
    endpoint:  
    prefix: paicoding/  
    ak:  
    sk:  
    bucket:  
    host:
```

**test环境配置**
```yaml
image:  
  abs-tmp-path: /Users/mengloulv/storage  
  web-img-path: forum/imge/  
  tmp-upload-path: /tmp/forum/  
  cdn-host:  
  oss:  
    type: local  
    prefix: paicoding/  
    endpoint:  
    ak:  
    sk:  
    bucket:  
    host:
```

上面四个配置文件，重点关注dev与prod，技术派这个项目中，dev开发环境，图片是默认上传到本地的；而我们部署到服务器的版本，则配置的是部署到阿里云的oss

## 1.2、环境切换

在本地开发时，可以借助idea进行简单的环境切换，如下：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202404051751908.png)

当我们需要打包时，则主要借助 -P  来选择具体的环境
```bash
# 比如打一个test环境的包
mvn clean package -DskipTests=true -Ptest
```

## 1.3、jar包验证

虽然在我们的源码中是包含不同环境的配置文件，但是在打包之后，jar包中只有会对应环境的配置文件，这也是这种方式与spring.profiles.active来指定选择启用的配置文件之间的区别

我们来实际验证一下（在classes目录下，并不会出现多环境的配置文件）
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202404051753874.png)

## 1.4、小结

技术派这里选择的是基于maven的方式来实现多环境配置管理；Spring本身实际上也提供了一个环境选择的方式，那就是基于 spring.profiles.active 来选择当前激活使用的配置文件，有兴趣的小伙伴也可以扩展学习一下，下面是一个示例

[补4_SpringBoot基础篇配置信息之多环境配置信息](2、相关技术/16、常用框架-SpringBoot/补12_SpringBoot配置/补4_SpringBoot基础篇配置信息之多环境配置信息.md)
