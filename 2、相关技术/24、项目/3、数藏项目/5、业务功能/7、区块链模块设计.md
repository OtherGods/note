## 一、系统设计

### 时序图

用户实名认证时，创建链账户
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202411142316696.png)

在用户实名认证之后，我们需要在链平台上给用户创建一个独一无二的链账户，只有有了账户之后，用户才能进行区块链相关的交易。所以这一步比必须要，相当于给用户开了个户。

藏品发生交易时，调用链进行上链
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202411142319570.png)

在藏品的交易相关过程中，我们主要抽象出了几个方法，分别介绍下：
- 上链藏品
- 可以把它理解为模板，即在链上创建一个藏品的基本信息，比如我们要发行100份电影票，只需要上链一次即可，后续有了这个电影票的基本信息，我们就可以基于他做出售。
- 铸造藏品
- 可以把他理解为基于模板创建出来的实例。上链后的藏品，想要被拥有，需要经过铸造过程，铸造依赖上链，只有上链后才能铸造。铸造之后的藏品需要有一个归属人，这个归属人就是为什么之前要创建链账户。
- 交易藏品
- 可以把他理解为实例的转手。铸造后的藏品，可以转让、交易给其他人，其实就是归属人的变更。
- 销毁藏品
- 一个藏品如果不想要了，则支持销毁。

## 二、接口设计

```java
/**
 * @author Hollis
 */
public interface ChainFacadeService {

    /**
     * 创建链账户
     *
     * @param request
     * @return
     */
    ChainProcessResponse<ChainCreateData> createAddr(ChainProcessRequest request);

    /**
     * 上链藏品
     *
     * @param request
     * @return
     */
    ChainProcessResponse<ChainOperationData> chain(ChainProcessRequest request);

    /**
     * 铸造藏品
     *
     * @param request
     * @return
     */
    ChainProcessResponse<ChainOperationData> mint(ChainProcessRequest request);

    /**
     * 交易藏品
     *
     * @param request
     * @return
     */
    ChainProcessResponse<ChainOperationData> transfer(ChainProcessRequest request);

    /**
     * 销毁藏品
     *
     * @param request
     * @return
     */
    ChainProcessResponse<ChainOperationData> destroy(ChainProcessRequest request);
}
```

## 三、数据库设计

### 类图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202411142332375.png)

```sql
/******************************************/
/*   DatabaseName = nfturbo   */
/*   TableName = chain_operate_info   */
/******************************************/
CREATE TABLE `chain_operate_info` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID（自增主键）',
  `gmt_create` datetime DEFAULT NULL COMMENT '创建时间',
  `gmt_modified` datetime DEFAULT NULL COMMENT '最后更新时间',
  `chain_type` varchar(64) DEFAULT NULL COMMENT '链类型',
  `biz_id` varchar(128) DEFAULT NULL COMMENT '业务id',
  `biz_type` varchar(64) DEFAULT NULL COMMENT '业务类型',
  `operate_type` varchar(64) DEFAULT NULL COMMENT '操作类型',
  `state` varchar(64) DEFAULT NULL COMMENT '状态',
  `operate_time` datetime DEFAULT NULL COMMENT '操作时间',
  `succeed_time` datetime DEFAULT NULL COMMENT '成功时间',
  `param` text COMMENT '入参',
  `result` text COMMENT '返回结果',
  `out_biz_id` varchar(128) DEFAULT NULL COMMENT '外部业务id',
  `deleted` int DEFAULT NULL COMMENT '是否逻辑删除，0为未删除，非0为已删除',
  `lock_version` int DEFAULT NULL COMMENT '乐观锁版本号',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb3 COMMENT='链操作'
;
```

## 四、设计亮点

### 工厂模式进行路由区块链服务

目前支持文昌链和mock场景
```java
/**
 * 链服务工厂
 *
 * @author hollis
 */
@Service
public class ChainServiceFactory {

    @Autowired
    private final Map<String, ChainService> chainServiceMap = new ConcurrentHashMap<String, ChainService>();

    public ChainService get(ChainType chainType) {
        String beanName = BeanNameUtils.getBeanName(chainType.name(), "ChainService");

        //组装出beanName，并从map中获取对应的bean
        ChainService service = chainServiceMap.get(beanName);

        if (service != null) {
            return service;
        } else {
            throw new UnsupportedOperationException(
                    "No ChainService Found With chainType : " + chainType);
        }
    }
}
```

根据给定的区块链类别（chainType），选择并返回正确的区块链服务实现
[2、模板方法模式](2、相关技术/24、项目/3、数藏项目/10、设计模式/2、模板方法模式.md)

[7.1、区块链基本介绍](2、相关技术/24、项目/3、数藏项目/5、业务功能/7.1、区块链基本介绍.md)
[7.2、NFT 为什么要使用区块链](2、相关技术/24、项目/3、数藏项目/5、业务功能/7.2、NFT%20为什么要使用区块链.md)


