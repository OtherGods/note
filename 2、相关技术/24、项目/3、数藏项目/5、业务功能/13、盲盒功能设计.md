在数字藏品领域，盲盒功能是一种基于随机性和惊喜感的购买体验，通常用于吸引用户参与并增加数字藏品的收藏乐趣。这一功能借鉴了传统实体盲盒的概念，在数字藏品的购买和交易中引入了随机性和稀有性元素。

﻿

数字藏品中的盲盒和普通藏品的主要区别就是随机性。用户在购买盲盒时，无法预先知道自己将获得哪种具体的数字藏品。每个盲盒内含有多个可能的数字藏品，每一件藏品的稀有度、价值或属性都可能不同。这种不确定性为用户带来了挑战和乐趣。

﻿

在我们的项目中，盲盒的功能在 nft-turbo-box 这个 module 下：
﻿![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251136394.png)


## 一、系统设计

### 用例图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251136629.png)

### ER图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251137242.png)

和藏品有关的表主要是 blind_box、blind_box_item 以及 blind_box_inventory_stream表，以及和他们有关的还有 held_collection 表、trade_order 表。
- blind_box
	- 盲盒表，主要记录了盲盒的数量、价格、标题、封面、状态等信息。
- blind_box_item
	- 盲盒条目表，和盲盒表是多对一的关系，一个盲盒中有多个条目。比如说创建一个盲盒，其中有一百个藏品，那么就会对应有100个盲盒条目，每个条目上还有自己的藏品的标题、封面、订单号、用户之类的信息。
- blind_box_inventory_stream
	- 盲盒库存流水，记录盲盒的每一次购买行为的。

后台用户，在创建一个盲盒时候，就会同时把他所有的条目一起创建好，这时候的条目处理用户信息、订单信息之外，其他的信息就都已经有了。

然后用户在购买盲盒的时候（准确的说是支付成功的时候），对于盲盒藏品来说，就会随机挑选出一个盲盒条目来进行绑定，这时候就已经确定了他后面开盒的时候能开出来什么东西。后面在开盒的时候，只是一个带有用户信息的盲盒条目转成藏品的过程。

所以模型的流转过程是：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251138405.png)

### 系统交互

盲盒创建过程
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251143992.png)

用户下单过程
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251143929.png)

用户下单流程，对于盲盒来说，操作没有什么特殊的，和藏品一样，做一次库存扣减即可。具体的扣减方案，也和藏品一致，就不展开说了。详见交易模块的设计。

用户支付成功
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251144773.png)

用户打开盲盒
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251146840.png)

### 状态图

盲盒状态机
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251146805.png)

- INIT
	- 盲盒创建成功之后，状态位 INIT
- SUCCEED
	- 盲盒上链成功后，状态为 SUCCEED
- REMOVED
	- 盲盒被销毁后，状态为 REMOVED

盲盒条目状态图
﻿![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251147353.png)
- INIT
	- 盲盒条目创建成功之后，状态为 INIT，这时候还没分配给任何一个用户
- ASSIGNED
	- 用户支付成功后，带上订单、用户等信息后，状态推进到 SUCC
- OPENING
	- 用户在针对某个盲盒（条目）做打开盲盒动作的时候，先推进到 OPENING
- SUCCESS
	- 直到held_collection 创建成功、上链调用成功后，推进到 SUCCESS

## 二、数据库设计

```sql
/******************************************/
/*   DatabaseName = nfturbo   */
/*   TableName = blind_box   */
/******************************************/
CREATE TABLE `blind_box` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID（自增主键）',
  `gmt_create` datetime DEFAULT NULL COMMENT '创建时间',
  `gmt_modified` datetime DEFAULT NULL COMMENT '最后更新时间',
  `name` varchar(512) DEFAULT NULL COMMENT '盲盒名称',
  `cover` varchar(512) DEFAULT NULL COMMENT '盲盒封面',
  `detail` text COMMENT '详情',
  `identifier` varchar(128) DEFAULT NULL COMMENT '幂等号',
  `state` varchar(128) DEFAULT NULL COMMENT '状态',
  `quantity` bigint DEFAULT NULL COMMENT '盲盒数量',
  `price` decimal(18,6) DEFAULT NULL COMMENT '价格',
  `saleable_inventory` bigint DEFAULT NULL COMMENT '可销售库存',
  `occupied_inventory` bigint DEFAULT NULL COMMENT '已占用库存',
  `create_time` datetime DEFAULT NULL COMMENT '盲盒创建时间',
  `sale_time` datetime DEFAULT NULL COMMENT '盲盒发售时间',
  `allocate_rule` varchar(512) DEFAULT NULL COMMENT '盲盒分配规则',
  `sync_chain_time` datetime DEFAULT NULL COMMENT '上链时间',
  `creator_id` varchar(128) DEFAULT NULL COMMENT '创建者',
  `collection_configs` text COMMENT '藏品配置',
  `deleted` int DEFAULT NULL COMMENT '是否逻辑删除，0为未删除，非0为已删除',
  `lock_version` int DEFAULT NULL COMMENT '乐观锁版本号',
  PRIMARY KEY (`id`),
  KEY `idx_state_name` (`state`,`name`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8mb3 COMMENT='盲盒表'
;
﻿
/******************************************/
/*   DatabaseName = nfturbo   */
/*   TableName = blind_box_inventory_stream   */
/******************************************/
CREATE TABLE `blind_box_inventory_stream` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID（自增主键）',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '最后更新时间',
  `blind_box_id` bigint DEFAULT NULL COMMENT '盲盒id',
  `changed_quantity` bigint DEFAULT NULL COMMENT '本次变更的数量',
  `price` decimal(18,6) DEFAULT NULL COMMENT '价格',
  `quantity` bigint DEFAULT NULL COMMENT '藏品数量',
  `state` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '状态',
  `saleable_inventory` bigint DEFAULT NULL COMMENT '可售库存',
  `occupied_inventory` bigint DEFAULT NULL COMMENT '已占库存',
  `stream_type` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '流水类型',
  `identifier` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '幂等号',
  `deleted` int DEFAULT NULL COMMENT '是否逻辑删除，0为未删除，非0为已删除',
  `lock_version` int DEFAULT NULL COMMENT '乐观锁版本号',
  `extend_info` varchar(512) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '扩展信息',
  PRIMARY KEY (`id`),
  KEY `idx_cid_ident_type` (`identifier`,`stream_type`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=561 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci AVG_ROW_LENGTH=16384 ROW_FORMAT=DYNAMIC COMMENT='盲盒表库存流水'
;
﻿
/******************************************/
/*   DatabaseName = nfturbo   */
/*   TableName = blind_box_item   */
/******************************************/
CREATE TABLE `blind_box_item` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID（自增主键）',
  `gmt_create` datetime DEFAULT NULL COMMENT '创建时间',
  `gmt_modified` datetime DEFAULT NULL COMMENT '最后更新时间',
  `blind_box_id` bigint DEFAULT NULL COMMENT '盲盒id',
  `name` varchar(512) DEFAULT NULL COMMENT '盲盒名称',
  `cover` varchar(512) DEFAULT NULL COMMENT '盲盒封面',
  `collection_name` varchar(512) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL COMMENT '藏品名称',
  `collection_cover` varchar(512) DEFAULT NULL COMMENT '藏品封面',
  `collection_detail` text COMMENT '藏品详情',
  `collection_serial_no` varchar(128) DEFAULT NULL COMMENT '持有藏品的序列号',
  `state` varchar(128) DEFAULT NULL COMMENT '状态',
  `user_id` varchar(128) DEFAULT NULL COMMENT '持有人id',
  `purchase_price` decimal(18,6) DEFAULT NULL COMMENT '购入价格',
  `order_id` varchar(128) DEFAULT NULL COMMENT '订单号',
  `deleted` int DEFAULT NULL COMMENT '是否逻辑删除，0为未删除，非0为已删除',
  `lock_version` int DEFAULT NULL COMMENT '乐观锁版本号',
  `rarity` varchar(32) DEFAULT NULL COMMENT '稀有度',
  `reference_price` decimal(18,6) DEFAULT NULL COMMENT '市场参考价',
  `opened_time` datetime DEFAULT NULL COMMENT ' 开盒时间',
  `assign_time` datetime DEFAULT NULL COMMENT ' 分配时间',
  PRIMARY KEY (`id`),
  KEY `idx_state_box_id` (`blind_box_id`,`state`),
  KEY `idx_user` (`order_id`),
  KEY `idx_order` (`order_id`)
) ENGINE=InnoDB AUTO_INCREMENT=4011 DEFAULT CHARSET=utf8mb3 COMMENT='盲盒条目表'
;
```


[13.1、盲盒抽取算法设计](2、相关技术/24、项目/3、数藏项目/5、业务功能/13.1、盲盒抽取算法设计.md)

