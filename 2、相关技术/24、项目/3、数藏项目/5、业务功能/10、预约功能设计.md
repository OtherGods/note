很多电商都提供商品预约的功能，比如天猫超市上面的茅台，只有预约过才能购买，不预约不能购买。

用户需要在开售前先预约才行， 不预约的就无法购买。数字藏品本身很多也都是热点商品，所以我们开发了预约的功能。

### 用例图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251114630.png)

### ER图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251116119.png)

goods_book这张表是预约记录表，用于记录用户的预约行为，标识一个用户对某个藏品进行了预约。

同时在 collection 表中我们增加了3个和预约有关的字段，can_book、book_start_time、book_end_time。用于记录该藏品能够预约以及可预约的时间段。

### 系统交互图

![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202506251117008.png)


在 CollectionVO 中新增了以下三个参数，返回给前端：

```java
/**
 * 预约开始时间
 */
private Date bookStartTime;
﻿
/**
 * 预约结束时间
 */
private Date bookEndTime;
﻿
/**
 * 是否预约
 */
private Integer canBook;
﻿
/**
 * 是否已预约过
 */
private Boolean hasBooked;
```

前端根据这几个字段，判断这个商品是不是需要预约，以及当前时间是否处于可预约时间段内，并且当前用户是否预约过。

### 前端展示逻辑（下单按钮）

售罄：`collectionDetail.state == 'SOLD_OUT' || collectionDetail.state == 'NOT_FOR_SALE'"`

立即购买：`collectionDetail.state == 'SELLING'`

预约成功：`(collectionDetail.state =='WAIT_FOR_SALE' || collectionDetail.state == 'COMING_SOON') && collectionDetail.hasBooked = true`

立即预约：`(collectionDetail.state =='WAIT_FOR_SALE' || collectionDetail.state == 'COMING_SOON') && collectionDetail.hasBooked = false && collectionDetail.canBook == 1 && & currentTime >= collectionDetail.bookStartTime && currentTime <= collectionDetail.bookEndTime`

即将开售：`collectionDetail.state == 'COMING_SOON' && collectionDetail.canBook == 0`

### 设计亮点

[4、基于 bitset 实现高效的商品预约](2、相关技术/24、项目/3、数藏项目/8、最佳实践/13、性能优化/4、基于%20bitset%20实现高效的商品预约.md)

