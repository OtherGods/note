![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202501121222717.png)

本文主要讲解下图中这个文件中关于分库分表部分的配置内容。

关于shardingsphere的配置如下：
```yml
spring:  
  shardingsphere:  
    rules:  
      sharding:  
        # 表配置
        tables:  
          trade_order:  
            actual-data-nodes: ds.trade_order_000${0..3}  
            keyGenerateStrategy:  
              column: id  
              keyGeneratorName: snowflake  
            table-strategy:  
              complex:  
                shardingColumns: buyer_id,order_id  
                shardingAlgorithmName: trade-order-sharding  
          trade_order_stream:  
            actual-data-nodes: ds.trade_order_stream_000${0..3}  
            keyGenerateStrategy:  
              column: id  
              keyGeneratorName: snowflake  
            table-strategy:  
              complex:  
                shardingColumns: buyer_id,order_id  
                shardingAlgorithmName: trade-order-sharding  
        
        # 分片算法的配置
        shardingAlgorithms:  
          trade-order-sharding:  
            type: CLASS_BASED  
            props:  
              algorithmClassName: cn.hollis.nft.turbo.datasource.sharding.algorithm.TurboKeyShardingAlgorithm  
              strategy: complex  
              tableCount: 4  
              mainColum: buyer_id  
        
        # 主键生成器配置
        keyGenerators:  
          snowflake:  
            type: SNOWFLAKE  
        
        # 审计器配置
        auditors:  
          sharding_key_required_auditor:  
            type: DML_SHARDING_CONDITIONS
```

## 根节点

```yml
spring:  
  shardingsphere:  
    rules:  
      sharding:
```

根节点配置 ShardingSphere 的规则，具体包括分片策略、算法和其他相关配置。

## 分表的配置

```yml
tables:  
  trade_order:
    actual-data-nodes: ds.trade_order_000${0..3}  
    keyGenerateStrategy:  
      column: id  
      keyGeneratorName: snowflake  
    table-strategy:  
      complex:  
        shardingColumns: buyer_id,order_id  
        shardingAlgorithmName: trade-order-sharding  
  trade_order_stream:  
    actual-data-nodes: ds.trade_order_stream_000${0..3}  
    keyGenerateStrategy:  
      column: id  
      keyGeneratorName: snowflake  
    table-strategy:  
      complex:  
        shardingColumns: buyer_id,order_id  
        shardingAlgorithmName: trade-order-sharding
```

我们共配置了2张表需要做分库分表，分别是`trade_order` 订单表和 `trade_order_stream` 订单流水表

### 表配置

这里拿 trade-order 举例，trade_order_stream和他是一样的。
```yml
trade_order:  
	actual-data-nodes: ds.trade_order_000${0..3}  
	keyGenerateStrategy:  
	  column: id  
	  keyGeneratorName: snowflake  
	table-strategy:  
	  complex:  
		shardingColumns: buyer_id,order_id  
		shardingAlgorithmName: trade-order-sharding
```

- **actual-data-nodes** : 指定实际的物理表节点，`ds.trade_order_000${0..3}` 表示有 4 个分片，分别为 `ds.trade_order_0000` , `ds.trade_order_0001` , `ds.trade_order_0002` , `ds.trade_order_0003` 。
- **keyGenerateStrategy** : 主键生成策略
- `column` : 主键列为 `id`
- `keyGeneratorName` : 使用 `snowflake` 算法生成主键，还支持 UUID。
- **table-strategy** : 分表策略
- `complex` : 使用复杂分片策略，还支持standard、hint等。（https://shardingsphere.apache.org/document/5.1.1/cn/features/sharding/concept/sharding/ ）
- `shardingColumns` : 分片列为 `buyer_id` 和 `order_id`
- `shardingAlgorithmName` : 使用 `trade-order-sharding` 分片算法（这是个自定义算法，会在后面配置具体内容）
> standard标准分片算法：用于处理使用单一键作为分片键的 `=`、`IN`、`BETWEEN AND`、`>`、`<`、`>=`、`<=` 进行分片的场景。
> 
> complex复合分片算法：用于处理使用多键作为分片键进行分片的场景，包含多个分片键的逻辑较复杂，需要应用开发者自行处理其中的复杂度。
> 
> Hint 分片算法：用于处理使用 `Hint` 行分片的场景。

## 分片算法的配置

```yml
shardingAlgorithms:  
  trade-order-sharding:  
    type: CLASS_BASED  
    props:  
      algorithmClassName: cn.hollis.nft.turbo.datasource.sharding.algorithm.TurboKeyShardingAlgorithm  
      strategy: complex  
      tableCount: 4  
      mainColum: buyer_id
```

这里定义了一个算法，名字为trade-order-sharding，配置内容如下：

### 分片算法

- **type** : 算法类型为 `CLASS_BASED`
- **props** :
- `algorithmClassName` : 使用自定义的 `cn.hollis.nft.turbo.datasource.sharding.algorithm.TurboKeyShardingAlgorithm` 算法类
- `strategy` : 分片策略为 `complex`
- `tableCount` : 表的分片数量为 4，这个是我们自己定义的，非 ShardingJDBC 标准字段，主要用于算法的计算使用
- `mainColum` : 主分片列为 `buyer_id` ，这个是我们自己定义的，非 ShardingJDBC 标准字段，主要用于当参数中多个字段都有时，取主字段配置即可，

## 主键生成器配置

```yml
keyGenerators:  
  snowflake:  
    type: SNOWFLAKE
```

- **type** : 生成器类型为 `SNOWFLAKE` ，即使用 Snowflake 算法生成全局唯一 ID

## 审计器配置

```yml
auditors:  
  sharding_key_required_auditor:  
    type: DML_SHARDING_CONDITIONS
```

- **type** : 审计器类型为 `DML_SHARDING_CONDITIONS` ，目前ShardingSphere内置的分片审计算法只有一个，DML_SHARDING_CONDITIONS。他的功能是要求对逻辑表查询时，必须带上分片键，防止进行不必要的全表扫描。

带注释版 yml 配置如下：
```yml
spring:  
  shardingsphere:  
    rules:  
      sharding:  
        tables:  
          trade_order:  
            actual-data-nodes: ds.trade_order_000${0..3}  # 指定实际的物理表节点，有4个分片，分别为 ds.trade_order_0000, ds.trade_order_0001, ds.trade_order_0002, ds.trade_order_0003            keyGenerateStrategy:  
              column: id  # 主键列为 id              keyGeneratorName: snowflake  # 使用 snowflake 算法生成主键  
            table-strategy:  
              complex:  # 使用复杂分片策略  
                shardingColumns: buyer_id,order_id  # 分片列为 buyer_id 和 order_id                shardingAlgorithmName: trade-order-sharding  # 使用 trade-order-sharding 分片算法  
          trade_order_stream:  
            actual-data-nodes: ds.trade_order_stream_000${0..3}  # 指定实际的物理表节点，有4个分片，分别为 ds.trade_order_stream_0000, ds.trade_order_stream_0001, ds.trade_order_stream_0002, ds.trade_order_stream_0003            keyGenerateStrategy:  
              column: id  # 主键列为 id              keyGeneratorName: snowflake  # 使用 snowflake 算法生成主键  
            table-strategy:  
              complex:  # 使用复杂分片策略  
                shardingColumns: buyer_id,order_id  # 分片列为 buyer_id 和 order_id                shardingAlgorithmName: trade-order-sharding  # 使用 trade-order-sharding 分片算法  
        shardingAlgorithms:  
          trade-order-sharding:  
            type: CLASS_BASED  # 算法类型为 CLASS_BASED            props:  
              algorithmClassName: cn.hollis.nft.turbo.datasource.sharding.algorithm.TurboKeyShardingAlgorithm  # 使用自定义的算法类  
              strategy: complex  # 分片策略为 complex              tableCount: 4  # 表的分片数量为 4              mainColum: buyer_id  # 主分片列为 buyer_id        keyGenerators:  
          snowflake:  
            type: SNOWFLAKE  # 生成器类型为 SNOWFLAKE        auditors:  
          sharding_key_required_auditor:  
            type: DML_SHARDING_CONDITIONS  # 审计器类型为 DML_SHARDING_CONDITIONS
```