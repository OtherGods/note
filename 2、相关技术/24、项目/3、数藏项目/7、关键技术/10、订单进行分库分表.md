我们的项目中用到了分库分表技术，主要是针对交易订单进行的分库分表，涉及到的一些方案如下：

### 分库&分表？

**分库主要解决的是并发量大的问题**。比较典型的分库的场景就是我们在做微服务拆分的时候，就会按照业务边界，把各个业务的数据从一个单一的数据库中拆分开，分别把订单、物流、商品、会员等数据，分别放到单独的数据库中。

**分表主要解决的是数据量大的问题。通过将数据拆分到多张表中，来减少单表的数据量，从而提升查询速度。**

我们的项目中其实只做了分表，没有做分库，其实主要是为了方便，为了让大家搭建起环境的时候不至于那么复杂。还有一个原因就是分表支持了之后，分库其实会更加简单一些，只是增加一些配置即可，所以我们这里就以分表作为主要的演示了。

### 分表数量

分表的数量一般是按照数据的存量、以及数据每天的增量来预估的。一般来说我们要保证单表的数据量维持在2000万以下。

`分表数量 = （存量数据量 + 每年的增量*期望保存的年数）/ 2000万 ===> 向上取最近的2的幂`

比如说：存量数据量2000万，每年增量1000万，保存20年：

`（2000+1000*20）/2000 = 11 ====> 16`

而我们的项目没搞得那么复杂，目前是分了4张表，基本上可以抗1亿左右的数据，实际上数藏业务，基本上单量也不会很大，每年的增长在500万就算比较高了，所以抗10年以上的话4张表足够了。

### 分表字段选择

我们的项目中和主流电商项目保持一致，采用买家 ID 作为分表字段。

我们知道，电商网站上面是有很多买家和卖家的，但是，一个大的卖家可能会产生很多订单，比如像苏宁易购、当当等这种店铺，他每天在天猫产生的订单量就非常的大。如果按照卖家Id分表的话，那同一个卖家的很多订单都会分到同一张表。

那就会使得有一些表的数据量非常的大，但是有些表的数据量又很小，这就是发生了**数据倾斜**。这个卖家的数据就变成了热点数据，随着时间的增长，就会使得这个卖家的所有操作都变得异常缓慢。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202501121110185.png)

但是，买家ID做分表字段就不会出现这类问题，因为不太容易出现一个买家能把数据买倾斜了。

但是需要注意的是，**我们说按照买家Id做分表，保证的是同一个买家的所有订单都在同一张表 ，并不是要给每个买家都单独分配一张表。**

我们在做分表路由的时候，是可以设定一定的规则的，比如我们想要分1024张表，那么我们可以用买家ID或者买家ID的hashcode对1024取模，结果是0000-1023，那么就存储到对应的编号的分表中就行了。

### 分表算法

在分表算法上，我们采用的是 hash 后取模的算法。即针对买家 ID 进行取 hash 值，然后再对总分表数取模。
```java
public class DefaultShardingTableStrategy implements ShardingTableStrategy {  
      
    public DefaultShardingTableStrategy() {  
    }  
      
    @Override  
    public int getTable(String externalId,int tableCount) {  
        int hashCode = externalId.hashCode();  
        return (int) Math.abs((long) hashCode) % tableCount;  
          
    }  
}
```

该方法的调用链如下，是被我们自定义了的分表算法调用的。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202501121149152.png)

分表算法自定义详见：
[12、自定义多Key分片算法](2、相关技术/24、项目/3、数藏项目/6、通用设计/12、自定义多Key分片算法.md)

### 全局ID

[3、全局唯一订单号生成（分布式ID）](2、相关技术/24、项目/3、数藏项目/7、关键技术/3、全局唯一订单号生成（分布式ID）.md)

### 分库分表框架

框架我们选的是 sharding-jdbc，为啥用他呢，因为市面上也没啥更多的选择了。。。而且他的主要功能，比如分表算法配置、全局 ID 生成这些基本功能也都支持。
[6、ShardingJDBC 接入](2、相关技术/24、项目/3、数藏项目/4、框架接入/6、ShardingJDBC%20接入.md)

### 分表后的查询

分表后的查询分两种：

1、带分表键的查询，即买家的订单查询，这种我们就带着 buyerId（或者订单号）去数据库中查询就行了。会自动路由到具体的物理表中进行查询的。

2、不带分表键的查询，这种的话主要是卖家查询、或者平台小二的查询。这种我们就通过 ES 来查询。









