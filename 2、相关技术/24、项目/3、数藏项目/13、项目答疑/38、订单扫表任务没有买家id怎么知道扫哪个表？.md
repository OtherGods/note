不知道大家有没有注意到，我们的订单因为做了分库分表，所以查询的时候，需要带着分表键，及buyer_id或者order_id。

但是其实，我们的超时关单的任务，并没有带着分表键啊，为什么呢？没有分表键他怎么查询呢？

**先说为什么？**

因为没办法带分表键，我不知道都有哪些buyerId或者order_id的订单需要关单，所以我才需要一个扫表任务来扫描需要超时关闭的订单的。

**没有分表键怎么查？**

那么，注定没办法拿到分表键了，在订单做了分库分表后如何查询呢？两种方案：

## 1、基于shardingjdbc的hint的方案。

这个方案其实我们在项目中也实现了，但是被废弃了。其实就是orderConfirmExecuteWithHint和orderTimeOutExecuteWithHint这两个任务。

但是被废弃是因为他们必须使用HINT类型的分表策略，而我们项目中，用了基因法，并且要基于买家id查询，需要用complex这种方式，所以他和hint只能二选一，所以我们只能选择废弃这种hint的方案了。

这里吐槽一下shardingjdbc，其实我司内部的tddl是同时支持的。可以在运行期识别hint，如果有hint优先用hint方案分表，否则再走配置的分表策略就行了，不知道为啥shardingjdbc没有实现。。。。

## 2、扫描所有的物理表。

那第二种可行的方案，就是全部扫描了，即查询的时候不带分表键，shardingjdbc就会去所有的物理表中都查一遍，然后把结果union在一起返回。

我们就是用的第二种。不指定分表键，默认就是这样的查询方式，这种方式最大的问题就是排序和分页会乱，但是我们在扫表的时候用，其实无所谓。