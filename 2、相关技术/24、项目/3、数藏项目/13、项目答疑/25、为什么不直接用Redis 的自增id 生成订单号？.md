## 为什么

大家都知道，我们项目中订单号生成使用的雪花算法+基因法，同时雪花算法中还用到了一个 Redis 的自增 id
[3、全局唯一订单号生成（分布式ID）](2、相关技术/24、项目/3、数藏项目/7、关键技术/3、全局唯一订单号生成（分布式ID）.md)

有人问，这里订单如果想要保证不重复，为啥不直接用 redis 的自增 id？

那肯定不行，因为自增 id 的话，可能被被人给预测出来，他就能根据自己的 id，比如说10000，那么他就知道10001就肯定是下一个订单号，就可能会出现各种水平权限漏洞问题。

同时也会容易被别人分析出来你的系统中一天有多少订单量，就会导致你的商业机密被暴露，所以不能用自增 id 来表示订单号。

## ChatGPT：水平越权

水平越权（Horizontal Privilege Escalation）是Web应用中的一种常见安全漏洞，指**同一权限等级的用户非法访问其他用户的资源或数据**。其核心问题在于系统未对用户访问的资源进行严格的权限校验，导致用户可以通过某些手段（如篡改参数）越权获取他人的数据。

---

### **核心概念**
- **权限层级**：所有用户属于同一层级（如普通用户、会员用户等）。
- **数据隔离**：用户只能访问自己的数据（如订单、个人信息、文件）。
- **漏洞本质**：系统未校验“当前用户是否有权访问目标数据”。

---

### **示例场景**
假设一个电商平台存在水平越权漏洞：
1. **用户A**登录后访问自己的订单页面，URL为：`https://example.com/order?id=1001`。
2. **用户B**的订单ID是`1002`。
3. **用户A**直接修改URL为`id=1002`，成功看到用户B的订单信息，这就是水平越权。

---

### **常见原因**
1. **未校验资源所有权**  
   直接使用客户端提交的参数（如用户ID、订单ID）查询数据，未验证当前用户是否有权访问该数据。
   ```python
   # 错误示例（未校验用户权限）
   order_id = request.GET.get('order_id')
   order = Order.objects.get(id=order_id)
   return order.details
   ```

2. **可预测的资源标识符**  
   使用连续数字、简单加密的ID（如`1001`, `1002`），攻击者容易猜测并遍历其他用户的数据。

3. **依赖客户端信息**  
   通过Cookie、本地存储的字段（如`user_id`）判断权限，但这些信息可能被篡改。

---

### **如何防御水平越权？**
1. **服务端强制校验所有权**  
   在查询数据时，强制关联当前用户的身份。
   ```python
   # 正确示例（校验用户权限）
   user = get_current_user()  # 从会话中获取当前用户
   order_id = request.GET.get('order_id')
   order = Order.objects.get(id=order_id, user=user)  # 确保订单属于当前用户
   return order.details
   ```

2. **使用不可预测的资源标识符**  
   避免使用自增ID，改用UUID或加密Token（如`c4ca4238a0b923820dcc`）作为资源标识。

3. **最小化数据暴露**  
   返回给客户端的数据中，避免包含敏感字段（如用户ID、手机号），减少攻击面。

4. **接口权限控制**  
   对敏感接口（如`/api/user/{id}/info`）实施严格的访问控制列表（ACL），确保用户只能访问自己的资源。

5. **自动化测试**  
   通过渗透测试工具（如Burp Suite）模拟水平越权攻击，验证防御机制是否生效。

---

### **水平越权 vs 垂直越权**
| 类型       | 特点                                                                 |
|------------|----------------------------------------------------------------------|
| **水平越权** | 同一权限层级的用户之间越权（如用户A访问用户B的数据）。               |
| **垂直越权** | 低权限用户越权访问高权限功能（如普通用户访问管理员后台）。           |

---

### **总结**
水平越权的风险在于**用户数据泄露**，可能导致隐私、财产损失。防御的核心是**服务端对每次数据请求都进行严格的权限校验**，同时避免暴露敏感信息。在开发过程中，应始终遵循“最小权限原则”和“不信任客户端”的安全设计理念。
