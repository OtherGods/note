这个问题，其实和下面问题是差不多问题，先看下链接这篇，然后再看本文。
[9、Redis 扣减后，消息丢了，数据库扣失败了怎么办？](2、相关技术/24、项目/3、数藏项目/13、项目答疑/9、Redis%20扣减后，消息丢了，数据库扣失败了怎么办？.md)

### 基于InventoryHint 方案

Redis 扣减成功后，没来得及发本地的事件（SpringEvent），应用就挂了。这时候，就会导致数据库无法正确扣减，那么怎么办呢？

主要是看挂的时间点，主要有以下三种可能：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202503161615473.png)

情况一：这时候只有 Redis 扣减成功了，订单还没创建成功。

这种情况，其实没啥办法了，因为单子都没落下来，系统没办法自己恢复了，只能依靠我们在 Redis 中写入的库存扣减流水来做核对，发现过了一段时间，还是没有这个订单的话，就把 Redis 中的库存会退回去。

情况二&情况三&以及情况三后面的任何节点：这时候订单已经创建成功了。

这种情况，我们有一个定时任务——orderConfirmExecute，他可以扫描那些还处于 INIT 状态的订单，重试进行 confirm，那么重试之后，还是可以把库存做正确的扣减的。

### 基于 MQ 的方案

基于 MQ 的方案，如果在 Redis 库存扣减后，应用挂了，或者 MQ 挂了，怎么办呢？

同样还是看情况：
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202503161616987.png)

情况一：这时候第二个半消息还没发，MQ 中的消息没有 commit

这种不需要介入，MQ 会定时回查，检查是不是需要 commit 这个消息，只要集群中还有正常的机器，或者挂了的机器重启好了之后，这个消息就会自动的 commit 了（除非超时了都没启起来，消息可能会删除）。

情况二&情况三&以及情况三后面的任何节点：这时候MQ 已经发出去了

这种情况也不需要介入，因为MQ 会重投。

如果挂的时间太长，消息被删除了或者过期了，那么还是要有一个对帐机制，和上面的方案一样， 基于 Redis 中的扣减流水进行核对。
