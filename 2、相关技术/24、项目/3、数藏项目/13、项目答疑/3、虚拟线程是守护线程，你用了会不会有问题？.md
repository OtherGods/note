我们的项目中，很多地方用了 JDK 21的虚拟线程，分别在订单的主动关单、短信的发送以及多付的退款执行这里。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202503122253049.png)

但是，虚拟线程总是守护线程，**所以，当所有启动的非守护线程都终止时，JVM将终止。这意味着JVM不会等待虚拟线程完成就会退出。**

那么也就意味着，如果应用发生重启，或者宕机，虚拟线程可能执行不完就结束了，会导致其中的任务执行到一半就停了。

那么这个问题是如何解决的呢？

其实我们没解决，而且这个问题也解决不了，因为即使用setDaemon (false)方法不能将虚拟线程更改为非守护线程。所以这个是无法改变的。

那我们为啥还用呢？

因为你看看我们用虚拟线程的这三个地方。

1、订单的主动关单

2、短信的发送

3、多付的退款执行

其实都不是一定要成功不可的 。因为如果失败了，要么就是丢了就丢了，比如短信的发送。另外就是有重试的机制，比如订单的主动关单和多付退款，都是有异步任务的。

所以说，这些场景是可以直接用虚拟线程的，一方面性能好，另外用起来也简单。

