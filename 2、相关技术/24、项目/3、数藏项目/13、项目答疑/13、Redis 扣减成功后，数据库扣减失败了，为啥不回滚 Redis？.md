在我们的项目中，我们在 Redis 扣减成功后，只有一种情况会回滚 Redis 的扣减动作，那就是订单的前置校验失败了的情况。
![image.png](https://raw.githubusercontent.com/OtherGods/MaterialImage/main/img/202503161726707.png)

其他情况下，都不会去回滚 redis 的库存了。为啥这么做呢？这么做不会导致数据的不一致吗？

理论上来说，如果 Redis 扣减成功了，并且订单的前置校验也都通过了，订单是一定可以创建成功的，没有不成功的理由。因为库存够、状态对，就要成功。所以，这种情况，我们就需要通过重试来保证数据库可以扣减成功，并且订单创建成功。
﻿
那这里如果引入 Redis 的库存回退机制，返回会导致不一致，为啥呢，因为数据库的操作会出现那种你以为失败了，但是实际上成功的情况，比如说网络超时，这时候你把 Redis 回滚了，就会出现超卖。

对于以上两个方案，最差的情况就是：
1、不回滚，会导致少卖。
2、回滚，会导致超卖

你说你选哪个？肯定是选择不回滚！至于不回滚的话，数据库和 Redis 的一致性问题，一方面重试，一方面通过旁路+对账来搞定。

