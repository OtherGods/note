我们在库存扣减这里，用了 lua 脚本，先扣减库存，然后再写入库存流水，这样做的目的主要是依靠流水可以做幂等和对账。

那么 lua 脚本执行过程中，如果库存扣减成功了，但是记录流水失败了，怎么办？

其实这种情况发生的概率比较低的，因为lua 脚本是保证原子性的，执行过程不会有其他线程中断他的操作，所以只有在 redis 挂了的时候才可能发生。

那么根据墨菲定律，有可能发生的事情就一定会发生。

首先，如果真的发生了， 根据 lua 脚本的特性，执行过程中，如果命令失败了，他会影响后面的命令的执行，会报错出来的。所以这种情况，程序会得到一个异常。那么代码中就无法走后续的订单创建流程。

但是 redis 中库存已经扣减了，而流水没生成。这可能会带来少卖的问题（库存少了一个，但是订单没创建）。

这种咋解决呢？这种情况我也不建议在代码中做什么操作了，一方面他发生的概率很低，另外一方面影响不太大，还有就是解决起来特别麻烦。
﻿
因为这里你不能重试，重试就还会在扣减一次，你也不能无脑回滚，因为没有流水，无脑回滚库存也会比较麻烦容易出错。

所以，这种极端情况，我们不在实时链路上做任何操作，出现了，就阻断后面的下单流程，报错。

然后依靠旁路验证+对帐机制（后面会讲）来发现这个问题，并人工介入处理了。

