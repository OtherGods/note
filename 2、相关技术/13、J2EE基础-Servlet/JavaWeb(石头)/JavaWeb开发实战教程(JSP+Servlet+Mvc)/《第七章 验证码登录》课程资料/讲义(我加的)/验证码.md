# 验证码



## 登录页面

login.jsp（包含验证码）

```html
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>系统登录 - 超市账单管理系统</title>
    <link rel="stylesheet" href="css/style.css"/>
    <script type="text/javascript">
       
    //点击更换图片
    function changeImge(){
    	//因为浏览器会缓存图片，所以请求生成一个新的验证码的地址
        //的时候，需要让请求的Servlet的地址变化
    	document.getElementById("pp").src="ImageServlet.do?time="+new Date(); //重新请求图片地址
    }
       
    </script>
</head>
<body class="login_bg">
    <section class="loginBox">
        <header class="loginHeader">
            <h1>超市账单管理系统</h1>
        </header>
        <section class="loginCont">
            <form class="loginForm" action="UserServlet.do?action=login" method="post">
                <div class="inputbox">
                    <label for="user">用户名：</label>
                    <input id="user" type="text" name="username" placeholder="请输入用户名" required/>
                </div>
                <div class="inputbox">
                    <label for="mima">密码：</label>
                    <input id="mima" type="password" name="password" placeholder="请输入密码" required/>
                </div>
                <div class="inputbox">
                    <label for="mima">验证码：</label>
                    <input id="mima" type="text" name="usercode" placeholder="请输入验证码" required/>
                    <!-- 验证码图片，src指向的是一个生成图片的Servlet -->
                    <img id="pp"  src="ImageServlet.do" onclick="changeImge();" style="cursor: pointer;"/>
                </div>
                <div class="subBtn">
                    <input type="submit" value="登录" />
                    <input type="reset" value="重置"/>
                </div>
            </form>
        </section>
    </section>
</body>
</html>
```

## 后端生成验证码图片的Servlet

```Java

import java.awt.Color;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.util.Random;
import javax.imageio.ImageIO;
import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

/**
	专门负责使用JAVA API程序生成一张随机的验证码图片！！！
	步骤：1、构造图片
		 2、生成验证码中的随机数字
			2.1、随机生成一种颜色（用于验证码的数字）
		 	2.2、将验证码的数字输出到图片中
		 3、保存验证码数字到HttpSession中
		 4、验证码图片干扰线（类似于第二步）
		 5、输出图片到浏览器
*/
@WebServlet("/ImageServlet.do")
public class ImageServlet extends HttpServlet{

	@Override
	protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        
        //第一步：构造图片
        
		int width=57;  //图片的宽度
		int height=30; //图片的高度
		
		//得到一个画布，最后一个参数有关于三元色
		BufferedImage bi=new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
		//获取一个画笔
		Graphics g = bi.getGraphics();
		//画笔为白色
		g.setColor(Color.WHITE);
		//用画笔给矩形填充颜色，四个参数的值可以决定一个矩形，看本小节的配图
		g.fillRect(0, 0, width, height); // Rectangle 矩形
		
		//设置图片边框（颜色）
		g.setColor(Color.BLACK);
		g.drawRect(0, 0, width-1, height-1);
		
		//第二步：生成随机验证码的数字 （大小字母和数字 62 【0-61】）
		Character[] array = { 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '0', '1', '2', '3', '4', '5', '6', '7', '8',
						'9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z' }; // 62
		
		Random r=new Random();
		StringBuffer sb=new StringBuffer();
		for(int i=1;i<=4;i++){
			int index=r.nextInt(62); //【0-61】
			String c=array[index].toString();
			sb.append(c);
			
            //第二.一步：随机生成一种颜色（用于验证码的数字）
			int red=r.nextInt(256); // 0-255 
			int green=r.nextInt(256); // 0-255 
			int blue=r.nextInt(256); // 0-255 
			Color color=new Color(red, green, blue);
			g.setColor(color);
			
            //第二.二步：将验证码的数字输出到图片中
            
			//设置字体
			g.setFont(new Font("Arial", Font.BOLD, 18));
			//将数字画到图片上，写的时候数字c在图片中的横坐标在变，纵坐标不变
			g.drawString(c, (60/6)*i,20);
		}
		System.out.println("系统生成随机的验证码是:"+sb.toString());
		HttpSession session = req.getSession();
		//第三步：把系统生成的正确验证码存入session
		session.setAttribute("syscode", sb.toString());
		
		//第四步：验证码图片干扰线（类似于第二步）
		for(int i=1;i<=8;i++){
			//生成两个点，两点决定一条干扰线，每个点的横坐标不会
            //超过图片的宽度，纵坐标不会超过纵坐标高度
			int x1=r.nextInt(width);
			int y1=r.nextInt(height);
			
			int x2=r.nextInt(width);
			int y2=r.nextInt(height);
			
			//随机生成一个颜色（用于干扰线）
			int red=r.nextInt(256); // 0-255 
			int green=r.nextInt(256); // 0-255 
			int blue=r.nextInt(256); // 0-255 
			Color color=new Color(red, green, blue);
			g.setColor(color);
			
			//画直线
			g.drawLine(x1, y1, x2, y2);
		}
		
		//第五步：输出图片到浏览器
        
		//设置响应内容格式
		resp.setContentType("image/jpeg"); // 设置图片格式
		//获取字节输出流(输出到浏览器)
		ServletOutputStream outputStream = resp.getOutputStream();
		//调用方法生成图片——>此处代码的含义：将jpeg格式的图片封装到字节输出流对象中，输出到浏览器
		ImageIO.write(bi, "jpeg", outputStream);
		

	}
}
```

g.fillRect(0, 0, width, height)==>>决定矩形：

![image-20220731111812057](D:\Tyora\AssociatedPicturesInTheArticles\验证码\image-20220731111812057.png)